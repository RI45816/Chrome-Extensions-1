var configAPI=function(){function a(a){a=_.verifyCallback(a),j=new IDBStore({dbVersion:"3",storeName:"CONFIG",keyPath:"id",onStoreReady:function(b){configOverrides.init().then(function(){j.getAll(function(b){_.each(b,function(a){config[a.id]=a.value}),config.uuid||(configAPI.set("uuid",getUUID()),configAPI.set("firstRun",!0),configAPI.set("baseVersion",config.version)),configAPI.setDefault("guid",null),configAPI.setDefault("user",null),a()})})}})}function b(a){return config[a]}function c(a,b){config[a]=b,j.put({id:a,value:b}),k()}function d(a,b){a in config||(config[a]=b,k())}function e(a){_.each(a,function(a,b){c(b,a)})}function f(a){_.each(a,function(a,b){d(b,a)})}function g(){return config}function h(a){delete config[a],j.remove(a),k()}function i(){j.clear()}var j,k=_.debounce(function(){"object"==typeof eventManager&&eventManager.dispatchEvent("CONFIG","CONFIG_SET",config)},100);return{init:a,get:b,set:c,remove:h,restoreDefaults:i,setDefault:d,setMultiple:e,setMultipleDefault:f,getConfig:g}}(),config={},ONE_SECOND=1e3,ONE_MINUTE=60*ONE_SECOND,ONE_HOUR=60*ONE_MINUTE,ONE_DAY=24*ONE_HOUR,ONE_WEEK=7*ONE_DAY;configAPI.setDefault("version",chrome.runtime.getManifest().version),configAPI.setDefault("spots_android_app_id","com.friedcookie.spots"),configAPI.setDefault("analytics_account","UA-50474899-1"),configAPI.setDefault("backgroundInitialized",$.Deferred()),configAPI.setDefault("debugEnabled",!0),configAPI.setDefault("cb","?cb=0.5.2"),configAPI.setDefault("brand","spots"),configAPI.setDefault("spots_list",["debug","favorites","phone","search","gallery","facebook","weather","apps","discovery","mobile-apps","review","gameo"]),configAPI.setDefault("module_import_list",["bi","analytics","idb","tabs","eventManager","spotsAPI","spotsManager","pushService","user","googlePlayUtils","_gaq","ftueAPI","graphicAssets","urls","notificationManager","utilsAPI","configAPI","userVoice","weather","discovery","mobileApps","languageManager","S3","webScrapper","modalManager","modalManager"]),configAPI.setDefault("initList",["configAPI","bi","analytics","chromeEvents","spotsManager","googlePlayUtils","playLight","eventManager","notificationManager","magicAPI","ftueAPI","patchHelper","languageManager","modalManager","remoteScripts"]),configAPI.setDefault("enable_encryption",!0),configAPI.setDefault("token_valid_time",ONE_WEEK),configAPI.setDefault("token_renew_attempts",10),configAPI.setDefault("wRLSfuYqTS","3E79D1AF7DB595d7"),configAPI.setDefault("bmUoRMdxOg","o6kitqcp710opjwh"),configAPI.setDefault("tSiNIpynKS","6xpslt05kh8ofm7h"),configAPI.setDefault("idp",""),configAPI.setDefault("hasAndroidDevices",!1),configAPI.setDefault("didLogin",!1),configAPI.setDefault("InstalledAndroidApp",!1),configAPI.setDefault("cleanupEventListenersInterval",5*ONE_MINUTE),configAPI.setDefault("reloadCounter",0),configAPI.setDefault("maxReloads",2),configAPI.setDefault("userIsOrganic",!0),configAPI.setDefault("unorganicOverrides",{set:{analytics_account:"UA-50423540-1",userVoiceData:{sid:"Nhly95zcTqWq74TtTeSFYA",forum:259209},searchProviderPattern:"aHR0cDovL3NwdHMuc3BlZWRpYWwuY29tLz9mPXswfSZ1cmVmPXsxfSZhPXsyfSZjZD17M30mY3I9ezR9JnE9"}}),configAPI.setDefault("remoteScriptsInterval",ONE_HOUR),configAPI.setDefault("defaultEventsSampleRate",.01),configAPI.setDefault("settingTabs",["general","presets","background","colors","favorites","notifications","android","power_search","discovery","mobile_apps"]),configAPI.setDefault("limitSearchResultType",null),configAPI.setDefault("idb_version",19),configAPI.setDefault("idb_tables",["SPOTS_DATA","SERVER_QUEUE","MAGIC_DATA","COLOR_PICKER_CACHE","NOTIFICATIONS","SCREENSHOTS","SCRAPPER_META_CACHE"]),configAPI.setDefault("opentab_enabled",!0),configAPI.setDefault("opentab_toggle_key_code",27),configAPI.setDefault("opentab_toggle_key_timeout",ONE_SECOND/2),configAPI.setDefault("opentab_sensitivity_L",.2),configAPI.setDefault("opentab_sensitivity_R",.2),configAPI.setDefault("opentabNumAppsDisplayed",5),configAPI.setDefault("appsDisplayed",!0),configAPI.setDefault("opentabDefaultResultsLimit",5),configAPI.setDefault("blackListedSites",["c3RhcnQubXlzZWFyY2hkaWFsLmNvbQ==","c3RhcnQuZnVubW9vZHMuY29t","aS5zZWFyY2gubWV0YWNyYXdsZXIuY29t","c2VhcmNoLnNlYXJjaHlhLmNvbQ==","c2VhcmNoLmZveHRhYi5jb20=","c3RhcnQuZmFjZW1vb2RzLmNvbQ==","c2VhcmNoZnVubW9vZHMuY29t","c3BlZWRpYWwuY29t","cm9ja2V0LWZpbmQuY29t","cm9ja2V0aW0uY29t","Z3Jvb3ZvcmlvLmNvbQ==","YXN0cm9tZW5kYS5jb20=","bGFzYW9yZW4uY29t","dGFwbGlrYS5jb20=","dm9zdGVyYW4uY29t"]),configAPI.setDefault("opentabCSS",{before:["/app/opentab/css/opentab.css","/app/css/components.css","/app/opentab/css/ftue.css","/app/opentab/css/opentabNotifications.css"],after:[]}),configAPI.setDefault("showPhone",!0),configAPI.setDefault("domain","spotsmagic.com"),configAPI.setDefault("url_www","http://"+config.domain),configAPI.setDefault("baseUpdatePageUrl","http://"+config.domain+"/updates/chrome/"),configAPI.setDefault("url_api","https://api."+config.domain),configAPI.setDefault("url_ts",config.url_api+"/ts"),configAPI.setDefault("url_feedback",config.url_www+"/feedback?"),configAPI.setDefault("facebookLikeSrc","http://spotsmagic.com/fblike"),configAPI.setDefault("url_pushServer","http://push."+config.domain+"/subscribe?events="),configAPI.setDefault("url_auth_complete","http(s)?:\\/\\/(www\\.)?api\\."+config.domain+"\\/(auth_complete|anon_complete)"),configAPI.setDefault("static_redirects_json","https://s3.amazonaws.com/static.addon.speedial.com/spt/config/redirects.json"),configAPI.setDefault("redirects_autopull_interval",ONE_DAY),configAPI.setDefault("biReportingHost","http://ib.spotsmagic.com/"),configAPI.setDefault("url_hoolapp","http://api.hoolapp.com/query.php"),configAPI.setDefault("url_products_search","http://prd."+config.domain+"/search/"),configAPI.setDefault("color_picker_api","http://colorbandits.com/"),configAPI.setDefault("privacyPolicyLink","http://"+config.domain+"/privacy-policy"),configAPI.setDefault("termsOfUseLink","http://"+config.domain+"/terms-of-use"),configAPI.setDefault("geolocationServiceUrl","http://geo.colorbandits.com/details"),configAPI.setDefault("weatherAPI","http://api.openweathermap.org/data/2.5/weather"),configAPI.setDefault("searchProviderUrl","https://www.google.com/?#q="),configAPI.setDefault("userVoiceData",{sid:null,forum:null}),configAPI.setDefault("api_autoPostTimer",6*ONE_SECOND),configAPI.setDefault("defaultThemeId","space"),configAPI.setDefault("themes",[{thumb:"/img/themes/strips/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"strips",bgColor:"#FFFFFF",themeColor:"#C23AFF",accentColor:"#5900A0",bgImage:"/img/themes/strips/bg.png",bgFooter:"/img/themes/strips/footer.png",bgFooterHeight:300,favoritesOpacity:.8,favoritesMargin:10,favoritesBorder:0}},{thumb:"/img/themes/fishing/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"fishing",bgColor:"#FEE7CA",themeColor:"#C046FF",accentColor:"#00B6B7",bgImage:"/img/themes/fishing/bg.png",bgFooter:"/img/themes/fishing/footer.png",bgFooterHeight:331,favoritesOpacity:.8,favoritesMargin:6,favoritesBorder:2}},{thumb:"/img/themes/space/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"space",bgColor:"#88A5ED",themeColor:"#978F8A",accentColor:"#3B7CFF",bgImage:"/img/themes/space/bg.png",bgFooter:"/img/themes/space/footer.png",bgFooterHeight:365,favoritesOpacity:1,favoritesMargin:11,favoritesBorder:4}},{thumb:"/img/themes/forest/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"forest",bgColor:"#BAD0FF",themeColor:"#3678FF",accentColor:"#014E9D",bgImage:"/img/themes/forest/bg.png",bgFooter:"/img/themes/forest/footer.png",bgFooterHeight:282,favoritesOpacity:.9,favoritesMargin:6,favoritesBorder:2}},{thumb:"/img/themes/bubbles/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"bubbles",bgColor:"#CBF0F1",themeColor:"#00B6B8",accentColor:"#0080D7",bgImage:"/img/themes/bubbles/bg.png",bgFooter:"/img/themes/bubbles/footer.png",bgFooterHeight:341,favoritesOpacity:.5,favoritesMargin:10,favoritesBorder:0}},{thumb:"/img/themes/sunset/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"sunset",bgColor:"#A5D3F0",themeColor:"#0080D7",accentColor:"#00B6B8",bgImage:"/img/themes/sunset/bg.png",bgFooter:"/img/themes/sunset/footer.png",bgFooterHeight:300,favoritesOpacity:1,favoritesMargin:0,favoritesBorder:1}},{thumb:"/img/themes/disco/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"disco",bgColor:"#C57FE2",themeColor:"#00B6B7",accentColor:"#FF007F",bgImage:"/img/themes/disco/bg.png",bgFooter:"/img/themes/disco/footer.png",bgFooterHeight:407,favoritesOpacity:1,favoritesMargin:11,favoritesBorder:2}},{thumb:"/img/themes/mountains/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"mountains",bgColor:"#BBD1FF",themeColor:"#3B7CFF",accentColor:"#FF007F",bgImage:"/img/themes/mountains/bg.png",bgFooter:"/img/themes/mountains/footer.png",bgFooterHeight:300,favoritesOpacity:.8,favoritesMargin:2,favoritesBorder:0}},{thumb:"/img/themes/city/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"city",bgColor:"#BEEFFC",themeColor:"#E25200",accentColor:"#3B7CFF",bgImage:"/img/themes/city/bg.png",bgFooter:"/img/themes/city/footer.png",bgFooterHeight:350,favoritesOpacity:.75,favoritesMargin:6,favoritesBorder:2}},{thumb:"/img/themes/buttons/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"buttons",bgColor:"#F2E9D3",themeColor:"#DD0065",accentColor:"#00B6B7",bgImage:"/img/themes/buttons/bg.png",bgFooter:"/img/themes/buttons/footer.png",bgFooterHeight:190,favoritesOpacity:.9,favoritesMargin:6,favoritesBorder:2}},{thumb:"/img/themes/sea/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"sea",bgColor:"#DBEAE3",themeColor:"#00B6B7",accentColor:"#E61F00",bgImage:"/img/themes/sea/bg.png",bgFooter:"/img/themes/sea/footer.png",bgFooterHeight:370,favoritesOpacity:.9,favoritesMargin:10,favoritesBorder:0}},{thumb:"/img/themes/planets/thumb.png",type:"spots",settings:{bodyClass:"default",themeId:"planets",bgColor:"#FFCB27",themeColor:"#FF007F",accentColor:"#FF892B",bgImage:"/img/themes/planets/bg.png",bgFooter:"/img/themes/planets/footer.png",bgFooterHeight:245,favoritesOpacity:1,favoritesMargin:2,favoritesBorder:0}}]),configAPI.setDefault("clockHourFormat","H:mm"),configAPI.setDefault("temperatureUnit",null),configAPI.setDefault("dateFormat",""),configAPI.setDefault("themeId",null),configAPI.setDefault("bgImage",null),configAPI.setDefault("userUploadedBGImages",[]),configAPI.setDefault("bgColor","#efefef"),configAPI.setDefault("bgFooter",null),configAPI.setDefault("themeColor","#0082D4"),configAPI.setDefault("accentColor","#4C4540"),configAPI.setDefault("colorScheme","light"),configAPI.setDefault("phoneSpeaker",!0),configAPI.setDefault("favoritesOpacity",.8),configAPI.setDefault("navbarOpacity",1),configAPI.setDefault("favoritesMargin",10),configAPI.setDefault("favoritesBorder",0),configAPI.setDefault("favoritesShadow",.07),configAPI.setDefault("favoritesLetterCount",2),configAPI.setDefault("topSitesItems",10),configAPI.setDefault("favoritesOpenInNewTab",!1),configAPI.setDefault("favoritesIconSize",.75),configAPI.setDefault("favoritesScreenshots",!0),configAPI.setDefault("favoritesSections",["top_sites","favorites","discovery"]),configAPI.setDefault("enableRecentlyClosed",!0),configAPI.setDefault("enableChromeApps",!0),configAPI.setDefault("enableContentDiscovery",!1),configAPI.setDefault("contentDiscoveryDisabledTimestamp",null),configAPI.setDefault("outbrainAPI","http://smm.outbrain.com/smm/api/feed"),configAPI.setDefault("outbrainFeedbackAPI","http://omakase.outbrain.com/Omakase/api"),configAPI.setDefault("outbrainAppId","3d8351f0bdf589de9e2f57edf10cd05d"),configAPI.setDefault("outbrainMaxResults",6),configAPI.setDefault("outbrainThumbnailSize","450x230"),configAPI.setDefault("discoveryItemsSize","large"),configAPI.setDefault("discoveryOptions",{maxItems:30,maxPaidItems:5,providers:[{name:"outbrain",maxPaidItems:5,percentage:.5}]}),configAPI.setDefault("notificationNewtabAutoRotate",5*ONE_SECOND),configAPI.setDefault("widgesOpentabAutoRotate",5*ONE_SECOND),configAPI.setDefault("hideLogin",!1),configAPI.setDefault("showFeedbackCategory",!1),configAPI.setDefault("opentabSearchHandlePosition",.08),configAPI.setDefault("opentabAppsHandlePosition",.08),configAPI.setDefault("phone_call_notifications","all"),configAPI.setDefault("phone_sms_notifications",!0),configAPI.setDefault("gallery_local_data_path","/app/spots/gallery/data/gallery.json"),configAPI.setDefault("gallery_remote_data_path","https://s3.amazonaws.com/IL-spots-gallery/v5/gallery.json"),configAPI.setDefault("gallery_autopull_interval",ONE_DAY),configAPI.setDefault("gallery_retry_interval",ONE_HOUR),configAPI.setDefault("default_background_colors",["#6296FF","#7CCB4D","#FF1542","#FF6D00","#4CCAC4","#C5376D","#5F8880","#D6A300"]),configAPI.setDefault("newtab_notifications_enabled",!0),configAPI.setDefault("s3_images_folder","https://s3.amazonaws.com/IL-spots/"),configAPI.setDefault("S3UploadTimeout",15*ONE_SECOND),configAPI.setDefault("languagesOptions",["de","en","es","fr","he","it","ja","nl","pl","pt","ru","tr"]),configAPI.setDefault("mostVisitedHideList",[]),configAPI.setDefault("ftueEnabled",!0),configAPI.setDefault("ftueOpentab",{step:0}),configAPI.setDefault("launchNewtabOnFirstRun",!0),configAPI.setDefault("takeOverNewtabsOnStartup",!1),configAPI.setDefault("remoteScripts",["https://s3.amazonaws.com/launchme/spots_remote.js"]),configAPI.setDefault("noModalReCheckTime",3*ONE_MINUTE),configAPI.setDefault("gameoApiAdress","https://api.gameoapp.com"),configAPI.setDefault("promotedGamesQuery","/games?type=flash,html5&gamefilters=promo&filter=title,id,icon"),configAPI.setDefault("recommendedGamesQuery","/games?type=flash,html5&sortby=recommended&order=desc&start=0&limit=100&filter=title,id,icon"),configAPI.setDefault("updateFeedInterval",ONE_DAY/2),configAPI.setDefault("gameoSearchResultAdress","http://gameoapp.com/game/%GAME_TITLE%/%GAME_ID%/?utm_source=%LABEL_NAME%&utm_medium=autocomplete"),configAPI.setDefault("websitesReported",["Roblox.com","gameninja.com","pogo.com","twitch.tv","ign.com","battle.net","gameforge.com","leagueoflegends.com","friv.com","steampowered.com","coolmath-games.com","xbox.com","y8.com","lolking.net","kongregate.com","games.yahoo.com","mmotraffic.com","gamespot.com","grepolis.com","perfectworld.com","miniclip.com","nexusmods.com","minecraft.net","battlefield.com","gtarcade.com","steamcommunity.com","gamepedia.com","r2games.com","wowhead.com","goodgamestudios.com","chess.com","zynga.com","zwinky.com","girlsgogames.com","minecraftforum.net","wizard101.com","arcadefrontier.com","ea.com","kotaku.com","gamemazing.com","armorgames.com","rockstargames.com","kizi.com","addictinggames.com","clubpenguin.com","stardoll.com","bigfishgames.com","poptropica.com","games.la","worldoftanks.com","coolrom.com","planetminecraft.com","wargaming.net","serebii.net","neopets.com","forgeofempires.com","elderscrollsonline.com","gaiaonline.com","game321.com","mobafire.com","agame.com","pogocheats.net","animaljam.com","nintendo.com","king.com","a10.com","aeriagames.com","lolnexus.com","totaljerkface.com","mojang.com","alnaddy.com","myplaycity.com","games.com","runescape.com","retrogamer.com","tiberiumalliances.com","ubi.com","tankionline.com","triviatoday.com","majorleaguegaming.com","thesims3.com","alliancewarfare.com","nexon.net","moviestarplanet.com","enmasse.com","kabam.com","enjin.com","ninjakiwi.com","origin.com","playdom.com","udmserve.net","moddb.com","smogon.com","games.pch.com","royalgames.com","pokemonshowdown.com","dorkly.com","curse.com","technicpack.net"]),configAPI.setDefault("affiliatedSearchFeed","https://s3.amazonaws.com/IL-spots-gallery/aff_search_feed.json"),configAPI.setDefault("affiliationFeedInterval",ONE_DAY/2),configAPI.setDefault("mobileAppsDiscoveryAvailable",!1),configAPI.setDefault("enableMobileAppsDiscovery",!1),configAPI.setDefault("mobileAppsFeed","http://apps.myappscloud.com/feed_v2.json"),configAPI.setDefault("mobileAppsItemsSize","medium"),configAPI.setDefault("mobileAppsDiscoveryDisabledTimestamp",null);var utils=function(){"use strict";var a=chrome.app.getDetails(),b=a.version,c=a.id,d=chrome.i18n.getMessage("@@ui_locale"),e=d.substr(0,2),f=function(){var a=navigator.userAgent.toLowerCase();return/windows nt 5.0/.test(a)?"win2K":/windows nt 5.0/.test(a)?"winXP":/windows nt 6.0/.test(a)?"vista":/windows nt 6.1/.test(a)?"win7":void 0}();return{os:function(){return f},getMessage:function(a){return chrome.i18n.getMessage(a)},getOrigin:function(){return chrome.extension.getURL("")},getURL:function(a){return chrome.extension.getURL(a)},getPage:function(a){return this.getURL("/content/"+a+".html")},getFileURL:function(a){return"filesystem:chrome-extension://"+c+"/persistent/"+a},getFavIconURL:function(a){return"chrome://favicon/"+a},id:function(){return c},version:function(){return b},locale:function(){return d},language:function(){return e},get:function(a){return localStorage["data."+a]},set:function(a,b){localStorage["data."+a]=b},remove:function(a){delete localStorage["data."+a]}}}(),urls=function(){function a(a){return/^(http:\/\/|https:\/\/|ftp:\/\/)/.test(a)}function b(a){var b=a.replace(" ","");return/^[a-zA-Z0-9_]+$/.test(b)&&(b+=".com"),b=b.replace(/\/$/,"")}function c(a){var b=g(a);S(b).startsWith("www.")&&(b=b.substr(4));var c=b.length,d=b.substr(c-4),e=b.substr(c-7,5),f=b.substr(c-6,4);return[".com",".net",".org",".gov",".edu"].indexOf(d)>=0?b=b.substring(0,c-4):[".com.",".net.",".org.",".gov",".edu."].indexOf(e)>=0?b=b.substring(0,c-7):[".co.",".ac.",".org.",".gov",".edu."].indexOf(f)>=0&&(b=b.substring(0,c-6)),b=S(b).contains(".")?S(b).replaceAll("."," ").humanize().capitalize().s:3==b.length?b.toUpperCase():S(b).replaceAll("."," ").humanize().capitalize().s}function d(b){var c=b;return/^[a-zA-Z0-9_]+$/.test(c)&&(c+=".com"),c=c.replace(/\/$/,""),a(c)||(c="http://"+c),c}function e(a){var b=a.match(/\[(.*?)\]/g);if("object"==typeof b)for(var c=0;c<b.length;c++){var d=b[c];d=d.substr(1,d.length-2);var e=config[d];void 0==e&&(e="");var f=new RegExp("\\["+d+"\\]","gi");a=a.replace(f,e)}var b=a.match(/\((.*?)\)/g);if("object"==typeof b)for(var c=0;c<b.length;c++){var d=b[c];d=d.substr(1,d.length-2);var e=user[d];void 0==e&&(e="");var f=new RegExp("\\("+d+"\\)","gi");a=a.replace(f,e)}return a}function f(b){return a(b)?b:"http://"+b}function g(a,b){a=f(a);var c=document.createElement("a");c.href=a;var d=c.hostname;return b&&d.indexOf("www.")>=0?d.substr(4):d}function h(a,b){var c=new RegExp(b+"=[-A-Za-z0-9]+");if(!c.exec(a))return!1;var d=c.exec(a)[0].split("=")[1];return d}function i(a){var b=urls.getHostName(a);b=b.replace("www.","");for(var c=!1;!c&&-1!==b.lastIndexOf(".");){var d=b.lastIndexOf(".");b.length-d<=4?b=b.substr(0,d):c=!0}return b}function j(a,b){var c=i(a),d=c.split("").join("\\s?");d=new RegExp(d,"i");var e=d.exec(b);return e?e[0]:b=b.split("|")[0]}function k(a,b){l&&l.abort(),a=f(a),l=$.ajax(a,{dataType:"text",type:"GET",success:function(c){var d=c.match(/<title>(.*?)<\/title>/);if(d){var e=d[1];if(e){var f=urls.getPrettyTitle(a,e);b(f?f:e)}else b(i(a))}else b(i(a))},error:function(a){b(null)}})}var l,m=/[\s\S]{1,}[\.][A-Za-z]{2,3}/i,n=function(a){return m.test(a)},o=function(){var a=/[?&]([^=#]+)=([^&#]*)/g;return function(b,c){var d={};return"string"==typeof b&&b.replace(a,function(a,b,e){d[c?b.toLowerCase():b]=decodeURIComponent(e)}),d}}();return{hasProtocol:a,name2host:b,url2name:c,getFullURL:d,isValidUrl:n,buildURL:e,ensureURL:f,getHostName:g,urlParameter:h,getBaseDomain:i,getPrettyTitle:j,getTitleByUrl:k,parseQueryString:o}}(),_gaq=_gaq||[],analytics=function(){"use strict";function a(f){return navigator.onLine?(function(a,b,c,d,e,f,g){a.GoogleAnalyticsObject=e,a[e]=a[e]||function(){(a[e].q=a[e].q||[]).push(arguments)},a[e].l=Date.now(),f=b.createElement(c),g=b.getElementsByTagName(c)[0],f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create",config.analytics_account,"auto"),ga("set","forceSSL",!0),ga("set","checkProtocolTask",function(){}),d(1,config.uuid),d(2,!!config.didLogin),d(3,!!config.hasAndroidDevices),d(4,!!config.InstalledAndroidApp),d(5,config.referredBy),d(6,localStorage.uref),d(6,config.brand),e(),c(),setInterval(c,25*ONE_MINUTE),_.each(_gaq,function(a){b(a)}),_gaq={push:b},void _.verifyCallback(f)()):(window.addEventListener("online",a,!1),void _.verifyCallback(f)())}function b(a,b){if(_.isArray(a))switch(a.shift()){case"_trackTiming":break;case"_trackEvent":if(null!=b){for(;a.length<3;)a.push(void 0);a.push(b)}f.apply(null,a)}}function c(){e("Keep Alive"),f("Background","Version",config.version)}function d(a,b){ga("set","dimension"+a,_.toString(b))}function e(a){ga("send","pageview",a)}function f(a,b,c,d){d=i(d,[a,b,c]),ga&&Math.random()<d&&ga("send","event",_.toString(a),_.toString(b),_.toString(c))}function g(a,b,c,d){var e=[a,b,c].join("-");f("Error",e,d,1)}function h(a,b){return"object"==typeof a?a[b]:a}function i(a,b){return a=Number(a),Number.isNaN(a)&&(a=Number(_.reduce(b,h,config.eventsSampleRate))),Number.isNaN(a)?config.defaultEventsSampleRate:a}return{init:a,reportPageView:e,reportEvent:f,reportDimension:d,reportError:g}}(),modalManager=function(){function a(a){setInterval(c,ONE_HOUR),_.verifyCallback(a)()}function b(a){_.isArray(a)?_.each(a,function(a){h.push(a)}):h.push(a)}function c(){e(function(a){(!a||Date.now()-a.timeShown>=ONE_DAY)&&d(function(b){a&&(b=_.filter(b,function(b){return b.type!=a.type})),idb.getAll("MODALS",function(a){if(b=_.filter(b,function(b){return b.once?"undefined"==typeof _.findWhere(a,{type:b.type}):!0}),analytics.reportEvent("Modal Manager","Modals Found",_.size(b)),_.size(b)>0){var c=_.first(_.sortBy(b,function(a){return-1*a.priority}));f(c),eventManager.dispatchEvent("MODAL","OPEN_MODAL",{title:c.title,path:c.path,handlers:c.handlers})}})})})}function d(a){var b=[];async.map(h,function(a,c){a.logicHandler(function(d){d&&b.push(a),c()})},function(){a(b)})}function e(a){idb.getAll("MODALS",function(b){var c=_.sortBy(b,function(a){return-1*a.timeShown});a(_.first(c))})}function f(a){var b=_.clone(a);b.timeShown=Date.now(),delete b.modalHandlers,delete b.logicHandler,idb.add("MODALS",b,function(a){})}function g(a,b){var c=_.find(h,function(b){return b.type==a});c&&c.logicHandler(function(a){(a||b)&&(f(c),eventManager.dispatchEvent("MODAL","OPEN_MODAL",{title:c.title,path:c.path,handlers:c.modalHandlers}))})}var h=[];return{init:a,add:b,checkModals:c,showModal:g}}(),chromeEvents=function(){function a(a){chrome.management.onInstalled.addListener(function(a){_gaq.push(["_trackEvent","Extension","Installed",c(a)])}),chrome.management.onUninstalled.addListener(function(a){_gaq.push(["_trackEvent","Extension","Uninstalled",a])}),chrome.management.onEnabled.addListener(function(a){_gaq.push(["_trackEvent","Extension","Enabled",c(a)])}),chrome.management.onDisabled.addListener(function(a){_gaq.push(["_trackEvent","Extension","Disabled",c(a)])}),chrome.runtime.onStartup.addListener(function(){_gaq.push(["_trackEvent","Extension","Startup"])});var d=new RegExp(config.url_auth_complete,"i");chrome.tabs.onRemoved.addListener(g.fire),e.add(function(a,b,c){c&&"chrome://newtab/"===c.url&&time.start("Newtab Loaded_"+a,null,!0)}),e.add(function(a,b,c){if(d.test(c.url.toLowerCase())){var e=urls.parseQueryString(c.url),f=/anon_complete/.test(c.url);setTimeout(function(){chrome.tabs.remove(a)}),e.fbAccessToken&&configAPI.set("fbAccessToken",e.fbAccessToken),"true"==e.success?f?(eventManager.dispatchEvent("CONFIG","USER_LOGIN_SUCCESS",e.platform),configAPI.set("passThroughDate",Date.now())):(configAPI.set("didLogin",!0),configAPI.set("idp",e.platform),bi.report({event_name:"login",login_type:login.type,login_src:login.src,login_result:"success"}),_gaq.push(["_trackEvent","Login",e.platform,"Success"]),configAPI.set("token",e.token),configAPI.set("token_last_renew",(new Date).getTime()),initUser(!1,function(a){a?(configAPI.set("loginDate",Date.now()),eventManager.dispatchEvent("CONFIG","USER_LOGIN_SUCCESS",e.platform)):(_gaq.push(["_trackEvent","Login",e.platform,"Init-User"]),eventManager.dispatchEvent("CONFIG","USER_LOGIN_ERROR"))})):(_gaq.push(["_trackEvent","Login",e.platform,"Failure"]),bi.report({event_name:"login",login_type:login.type,login_src:login.src,login_result:"fail"}),eventManager.dispatchEvent("CONFIG","USER_LOGIN_ERROR"))}}),window.newtabs={},f.add(function(a,b,c){c&&"chrome://newtab/"!==c.url&&delete window.newtabs[a]}),g.add(function(a,b){delete window.newtabs[a]}),chrome.tabs.onUpdated.addListener(function(a,c,d){if("complete"==d.status&&b(d.url),d.url&&(!c.favIconUrl||1!==_.size(c)))switch(d.status){case"loading":e.fire(a,c,d);break;case"complete":f.fire(a,c,d)}}),a()}function b(a){_.each(config.websitesReported,function(b){var c=new RegExp("(.*)"+b+"*");c.test(a)&&(config.trackedSitesCounter||configAPI.set("trackedSitesCounter",0),configAPI.set("trackedSitesCounter",parseInt(config.trackedSitesCounter,10)+1),analytics.reportEvent("Sites Tracker",b,a,1))})}function c(a){var b=["id","name","version","enabled","disabledReason","type"],c=[];return a&&_.each(b,function(b){a[b]&&c.push(a[b])}),c.join("_")}function d(){config.takeOverNewtabsOnStartup&&chrome.tabs.query({url:"chrome://newtab"},function(a){_.each(a,function(a){chrome.tabs.create({active:a.active},function(b){var c=a.index;chrome.tabs.remove(a.id,function(){chrome.tabs.move(b.id,{index:c})})})})}),"undefined"==typeof gc&&(_.delay(function(){config.firstRun&&config.launchNewtabOnFirstRun&&chrome.tabs.create({active:!0},function(){configAPI.set("firstRun",!1)})}),_.delay(defender.init,10*ONE_SECOND))}var e=$.Callbacks(),f=$.Callbacks(),g=$.Callbacks();return{init:a,refreshExtension:d,onTabLoading:e.add,onTabCompleted:f.add,onTabRemoved:g.add}}(),defender=function(){function a(a){return!0}function b(a){return!1}function c(){}return{init:c,isSpotsTab:a,isNewtab:b}}(),webappsUtils=function(){"use strict";return{list:function(a){chrome.management.getAll(function(b){var c=_.filter(b,function(a){return a.isApp&&a.enabled});_.each(c,function(a){a.icon=_.max(a.icons,function(a){return a.size}).url}),a(c)})},launch:function(a){chrome.management.launchApp(a.id)},uninstall:function(a,b){chrome.management.uninstall(a,b)}}}(),tabs=function(){"use strict";function a(a){return{url:a.url,title:a.title}}function b(a){var b;if(void 0==h[a.url])g.push(a),h[a.url]=g.length-1;else{var c=h[a.url];for(g.splice(c,1),g.push(a),b=c;b<g.length;b++)a=g[b],h[a.url]=b}if(g.length>f)for(a=g.shift(),delete h[a.url],b=0;b<g.length;b++)a=g[b],h[a.url]=b}function c(a){if(void 0!=h[a]){var b=h[a];g.splice(b,1),delete h[a];for(var c=b;c<g.length;c++){var d=g[c];h[d.url]=c}}}function d(){var c=utils.get("rc");if(void 0!=c){c=JSON.parse(c);for(var d=0;d<c.length&&f>d;d++){var e=a(c[d]);b(e)}}}function e(){utils.set("rc",JSON.stringify(g))}var f=10,g=[],h={},i={},j=0;d(),chrome.windows.getAll({populate:!0},function(b){for(var c=0;c<b.length;c++)for(var d=b[c],e=d.tabs,f=0;f<e.length;f++){var g=e[f];void 0!=g&&"chrome://newtab/"!=g.url&&(i[g.id]=a(g),j++)}}),chrome.tabs.onCreated.addListener(function(b){"chrome://newtab/"!=b.url&&(j++,i[b.id]=a(b),c(b.url))}),chrome.tabs.onUpdated.addListener(function(b,d,e){return"chrome://newtab/"==e.url?void(void 0!=i[e.id]&&(j--,delete i[e.id])):(void 0==i[e.id]&&j++,i[e.id]=a(e),void c(e.url))}),chrome.tabs.onRemoved.addListener(function(a){if(void 0!=i[a]){j--;var c=i[a];b(c),delete i[a],e()}});var k={};k.get=function(){},k.remove=function(a){c(a)};var l={};return l.get=function(){var a=[];for(var b in i){var c=i[b];if(null!=c){var d={id:b,title:c.title,url:c.url,favIconUrl:utils.getFavIconURL(c.url)};a.push(d)}}return a.reverse()},{selectTab:function(a){chrome.tabs.update(a,{active:!0},function(){})},getRecentlyClosed:function(a){for(var b=[],c=g.length-1;c>=0;c--){var d=g[c];if(null!=d){var e={title:d.title,url:d.url,favIconUrl:utils.getFavIconURL(d.url)};b.push(e)}}a(b)},getActive:function(a){var b=[];for(var c in i){var d=i[c];if(null!=d){var e={id:c,title:d.title,url:d.url,favIconUrl:utils.getFavIconURL(d.url)};b.push(e)}}a(b.reverse())},clearRecentlyClosed:function(a){h={},g=[],e(),_.verifyCallback(a)()},openLinkInNewTab:function(a,b){chrome.tabs.create({url:urls.getFullURL(a),active:_.isUndefined(b)?!0:b},function(){})}}}(),utilsAPI=function(){"use strict";function a(a){var b=PPbnlErCVt.enc.Utf8.parse(config.bmUoRMdxOg),c=PPbnlErCVt.enc.Utf8.parse(config.tSiNIpynKS),d=PPbnlErCVt.NThBPBQDDd.decrypt(a,b,{iv:c}).toString(PPbnlErCVt.enc.Utf8);return d}function b(a){var b=PPbnlErCVt.enc.Utf8.parse(config.bmUoRMdxOg),c=PPbnlErCVt.enc.Utf8.parse(config.tSiNIpynKS),d=PPbnlErCVt.NThBPBQDDd.encrypt(a,b,{iv:c}).toString();return d}function c(a){var b=document.createElement("DIV");return b.innerHTML=a,b.textContent||b.innerText||""}function d(a){a=_.verifyCallback(a),$.ajax(config.url_ts,{dataType:"text",type:"GET",cache:!1,success:function(b){try{var c=JSON.parse(b);a&&c.result&&a(c.result)}catch(d){a(!1)}},error:function(b){a(!1)}})}function e(a){return chrome.i18n.getMessage(a)}function f(a,b,c,d){d=_.verifyCallback(d),_gaq.push(["_trackEvent",a,b,c]),d()}function g(a,b){b=_.map(b,function(a,b){return a=_.map(a,function(a,b){return b+": "+a+";"}),b+" { "+a.join(" ")+" }"}).join("\n"),$("<style>",a).html(b).appendTo(a.head)}return window.wat=console.log.bind(console),{decrypt:a,encrypt:b,getCurrentTimeStamp:d,getMessage:e,sendGA:f,stripHtml:c,insertCssRules:g}}(),googlePlayUtils=function(){"use strict";function a(a){b(),l(),m(),g(),setInterval(g,ONE_HOUR),_.verifyCallback(a)()}function b(){O.signedIn=!1,O.hasDevices=!1,O.email=null,O.devices=null,O.token=null}function c(a){var b={foundDevices:!1};b.devices=[];var c=a.split("[[");if(c.length>2)for(var d=c[2].split("]"),e=0;e<d.length;e++){var f=d[e].replace(/,\[/g,"").replace(/"/g,"").split(",");if(3==f.length){var g=f[0],h=f[2];b.devices.push({id:g,permission:h}),b.foundDevices=!0}}return b}function d(a,b,c,d){var e=utilsAPI.decrypt(B)+utilsAPI.decrypt(H);_gaq.push(["_trackEvent","App Install",a,"Start"]);var f=new XMLHttpRequest;f.open("POST",e,!0),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),f.onreadystatechange=function(){4===this.readyState&&d&&"function"==typeof d&&(-1!==this.responseText.indexOf("gres")?(_gaq.push(["_trackEvent","App Install",a,"Success"]),d(!0)):(_gaq.push(["_trackEvent","App Install",a,"Failure"]),d(!1)))},f.send("id="+a+"&token="+c+"&device="+b+"&xhr=1")}function e(a){var b=utilsAPI.decrypt(B),c=new XMLHttpRequest;c.open("GET",b,!0),c.onreadystatechange=function(){if(4===this.readyState){var b=this.responseText,c="_uc='[\\42",d="\\42",e=b.indexOf(c);if(-1!=e){b=b.substr(e+c.length);var f=b.indexOf(d),g=escape(b.substr(0,f));a(g)}else O.signedIn=!1,a(!1)}},c.send()}function f(a,b){var c="xhr=1&token="+b,d=utilsAPI.decrypt(B)+utilsAPI.decrypt(E);_gaq.push(["_trackEvent","Checker","Devices","Start"]);var e=new XMLHttpRequest;e.open("POST",d,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),e.onreadystatechange=function(){if(4===this.readyState){h=this.responseText;try{var c=[];if(null!=h){var d="[",e="]",f=h.indexOf(d);if(-1!=f){h=h.substr(f);var g=h.lastIndexOf(e),h=h.substr(0,g),i=h.split("[[");if(i.length>3){for(var j=i[3].split("]"),k=0;k<j.length;k++){var l=j[k].replace(/,\[/g,"").replace(/"/g,"").split(",");if(14==l.length){var m=l[0],n=l[1],o=l[2],p=l[3],q=l[6].replace(/\u003d/g,"=");c.push({id:n,name:m,manufacturer:o,model:p,image:q})}}0==c.length?(_gaq.push(["_trackEvent","Checker","Devices","0 Devices"]),_.verifyCallback(a)(!1)):(_gaq.push(["_trackEvent","Checker","Devices","Has Devices"]),_.verifyCallback(a)(!0,b,c))}else _gaq.push(["_trackEvent","Checker","Devices","No Section"]),_.verifyCallback(a)(!1)}else _gaq.push(["_trackEvent","Checker","Devices","Parsing Failed"]),_.verifyCallback(a)(!1)}else _gaq.push(["_trackEvent","Checker","Devices","Request Failed"]),
_.verifyCallback(a)(!1)}catch(r){_gaq.push(["_trackEvent","Checker","Devices","Parsing Exception"]),_.verifyCallback(a)(!1)}}},e.send(c)}function g(a){var b=[null,null,null,null];_gaq.push(["_trackEvent","Checker","Fetch Data","Start"]),e(function(c){c?(_gaq.push(["_trackEvent","Checker","Fetch Data","Has Token"]),b[2]=c,f(function(c,d,e){chrome.cookies.getAll({domain:"play.google.com",name:"PLAY_ACTIVE_ACCOUNT"},function(f){if(1==f.length){var g=f[0].value,h=g.indexOf("=");if(-1!=h){var i=g.substr(h+1);O.email=i,b[0]=!0,b[1]=e,O.token=d,O.signedIn=!0,O.devices=e,O.hasDevices=c,configAPI.set("hasAndroidDevices",!0),_.verifyCallback(a).apply({},b)}}})},c)):(b[0]=!1,_gaq.push(["_trackEvent","Checker","Fetch Data","No Token"]),_.verifyCallback(a).apply({},b))})}function h(){return O.signedIn}function i(){return O.hasDevices}function j(a,b,c){if(h())k(a,b,c);else{var d="no-session";_.verifyCallback(c)(!1,d)}}function k(a,b,c){var d="comment&id=com.friedcookie.spots&rating="+a+"&title="+b+"&xhr=1&token="+O.token+"&hl=en",e=utilsAPI.decrypt(B)+utilsAPI.decrypt(D),f=new XMLHttpRequest;f.open("POST",e,!0),f.onreadystatechange=function(){4===this.readyState&&_.verifyCallback(c)(!0)},f.send(d)}function l(){chrome.webRequest.onBeforeSendHeaders.addListener(function(a){for(var b=utilsAPI.decrypt(B),c=!1,d=!1,e=!1,f="application/x-www-form-urlencoded;charset=UTF-8",g=0;g<a.requestHeaders.length;++g){var h=a.requestHeaders[g];/origin/i.test(h.name)?(h.value=b,c=!0):/referer/i.test(h.name)?(h.value=b+C,d=!0):/content-type/i.test(h.name)&&(h.value=f,e=!0)}return c||a.requestHeaders.push({name:"Origin",value:b}),d||a.requestHeaders.push({name:"Referer",value:b+C}),e||a.requestHeaders.push({name:"Content-Type",value:f}),{requestHeaders:a.requestHeaders}},{urls:[utilsAPI.decrypt(I)]},["blocking","requestHeaders"])}function m(){chrome.webRequest.onBeforeRequest.addListener(function(a){var b="a="+P;(-1!==a.url.indexOf(b)||void 0!==a.requestBody&&void 0!==a.requestBody.formData&&void 0!==a.requestBody.formData["continue"]&&Array.isArray(a.requestBody.formData["continue"])&&-1!==a.requestBody.formData["continue"][0].indexOf(b))&&(y=a.tabId,chrome.tabs.get(y,function(a){z=a.windowId}))},{urls:["*://*.google.com/ServiceLogin*"]},["blocking","requestBody"]),chrome.windows.onRemoved.addListener(function(a){if(a==z&&void 0!==x){var b=x;x=null,b(!1)}}),chromeEvents.onTabLoading(function(a,c,d){if(K.test(d.url)&&(_gaq.push(["_trackEvent","Checker","Logout","Detected"]),b()),M.test(d.url)&&_gaq.push(["_trackEvent","Checker","Login","Detected"]),L.test(d.url)&&g(function(a,b,c){a&&eventManager.dispatchEvent("GOOGLE","LOGIN"),_gaq.push(["_trackEvent","Checker","Login","Status changed"])}),N.test(d.url)&&-1!==d.url.indexOf("a="+P)){chrome.tabs.remove(a),_gaq.push(["_trackEvent","Checker","Login","Success"]);var e=x;x=null,e(!0)}})}function n(a,b){_.each(O.devices,function(c){d(a,c.id,O.token,_.verifyCallback(b))})}function o(a){if(O.signedIn){var b=[O.signedIn,O.devices,O.token,O.email];_.verifyCallback(a).apply({},b)}else g(a)}function p(a,b){var d="id="+a+"&xhr=1&token="+O.token,e=utilsAPI.decrypt(B)+utilsAPI.decrypt(F)+"?"+d,f=new XMLHttpRequest;f.open("POST",e,!0),f.onreadystatechange=function(a){if(4===this.readyState){var d=c(this.responseText),e=!1;if(null!=d&&d.foundDevices)for(var f in d.devices){var g=d.devices[f];if("object"==typeof g&&g.permission==J){e=!0;break}}_.verifyCallback(b)(e)}},f.send()}function q(a){var b=[],c=$.parseHTML(a);return $(c).find(".card-list").children(".card").each(function(a,c){var d=$(c).data("docid");d&&b.push(d)}),b}function r(a){var b=utilsAPI.decrypt(A)+utilsAPI.decrypt(G),c=new XMLHttpRequest;c.open("GET",b,!0),c.onreadystatechange=function(b){if(4===this.readyState){var c=q(this.responseText);_.verifyCallback(a)(c)}},c.send()}function s(a,b,c,d){u=a,v=b,w=c,x=d;var e=950,f=680,g="https://accounts.google.com/ServiceLogin?service=googleplay&continue=https://play.google.com/store%3Fa="+P+"&followup=https://play.google.com/store";window.open(g,"Play Store Login","width="+e+",height="+f+",height="+f+",screenX="+(window.screen.width/2-e/2)+",screenY="+(window.screen.height/2-f/2)),_gaq.push(["_trackEvent","Checker","Login","Start"])}function t(a){var b=new XMLHttpRequest;b.open("GET","https://accounts.google.com/Logout",!0),b.onreadystatechange=function(b){4==this.readyState&&(O.email=null,O.devices=null,O.token=null,O.signedIn=!1,O.hasDevices=!1,_.verifyCallback(a)())},b.send()}var u,v,w,x,y,z,A="MCyRFfrdpMhlFfHbiaB41bN+2rhYQbWf0D3Xyt9xBCY=",B="MCyRFfrdpMhlFfHbiaB41XrnGCrfv7/R35l4/x1JNv0=",C="xhRHUnUPc1n7MqSLo+Q+40NaIZ1VMe4X6/VXbkSdU49xF0pAGwSA2SqDGHKJEBnq",D="N4APjJ7W0QlEiSc2JoECmQ==",E="HgwzBqseA3k/rM66JxF6kA==",F="RaVuYl0HAGw7nOeotvAd4OwOILytYcM8D7djU40GXr8=",G="bzYmgb9XwIpVpB3CQayNLA==",H="sA9RtwrdfXK9pzEBh7A4iA==",I="13MUkTniXegbdP+p+9wKnqylSbR5zTZUCFYcejD2dWp5/Z35KhGHmOoHL2+oC1XA",J="1",K=/.*:\/\/.*\.(google|youtube)\.com\/.*logout.*/i,L=/.*:\/\/accounts\.google\.*/i,M=/.*:\/\/.*\.google\.com\/ServiceLogin.*/i,N=/^https?:\/\/(www\.)?play.google.com\/.*/,O={},P=Math.floor(1e5*Math.random()+1);return{init:a,getGoogleAccountData:o,testAppCompatibility:p,getInstalledApps:r,googleLogin:s,googleLogout:t,doInstall:n,isSignedIn:h,hasDevices:i,sendReview:j}}(),playLight=function(){function a(){var a=$.Deferred();return chrome.cookies.getAll({domain:"play.google.com",name:"PLAY_ACTIVE_ACCOUNT"},function(b){if(_.isEmpty(b))return a.reject();var c=b[0].value,d=c.indexOf("=");if(-1===d)return a.reject();var e=c.substring(d+1);a.resolve(e)}),a.promise()}return{getPlayAccount:a}}(),ftueAPI=function(){function a(a){config.ftueEnabled&&(a=_.verifyCallback(a),configAPI.setDefault("isShowFtue",!0),configAPI.setDefault("ftue-step",{step:0}),configAPI.setDefault("ftue-cssProps",{contentWidth:"470px",contentHeight:"400px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null}),eventManager.addEventListener("CONFIG","USER_LOGIN_SUCCESS",function(a){configAPI.get("ftue-step")&&1==configAPI.get("ftue-step").step&&(_gaq.push(["_trackEvent","ftue","step2","view"]),configAPI.set("ftue-cssProps",{contentWidth:"470px",contentHeight:"500px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null}),configAPI.set("ftue-step",{step:2}))}),eventManager.addEventListener("FTUE","SPOTS_ANDROID_INSTALLED",function(){_gaq.push(["_trackEvent","ftue","step3","view"]),configAPI.set("ftue-cssProps",{contentWidth:"470px",contentHeight:"500px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null}),configAPI.set("ftue-step",{step:3})}),eventManager.addEventListener("FTUE","STEP_UPDATE",function(a){var b=a.currentStep,c=a.nextStep;-1==c?(configAPI.set("isShowFtue",!1),_gaq.push(["_trackEvent","ftue","step"+b,"skip"])):_gaq.push(["_trackEvent","ftue","step"+c,"view"]),5==c?(configAPI.set("isShowFtue",!1),_gaq.push(["_trackEvent","ftue","step"+b,"finish"])):(1==c?configAPI.set("ftue-cssProps",{contentWidth:"470px",contentHeight:"440px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null}):4==c&&(2==b&&_gaq.push(["_trackEvent","ftue","step"+b,"skip"]),configAPI.set("ftue-cssProps",{contentWidth:"470px",contentHeight:"300px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null})),configAPI.set("ftue-step",{step:c}))})),a()}return{init:function(b){a(b)}}}(),S3=function(){"use strict";function a(a){var b=["Bytes","KB","MB","GB","TB"];if(0==a)return"0 Bytes";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,c),2)+" "+b[c]}function b(a){return a&&"string"==typeof a.type?0===a.type.indexOf("image/"):!1}function c(a,c){var d=c.folder;return graphicAssets.isDataURL(a)&&(a=graphicAssets.toBlob(a,c.filename)),_gaq.push(["_trackEvent","Image-Upload","Start",d]),b(a)?(c.maxSize=h(c.maxSize),a.size>c.maxSize?(_gaq.push(["_trackEvent","Image-Upload","Resize",d]),graphicAssets.lowerImageQuality(a,null,c.maxSize).then(function(b){return b.name=a.name,i(b,c)},function(){return _gaq.push(["_trackEvent","Upload","Failed","Image file size exceeded"]),$.Deferred().reject("Image file size exceeded")})):i(a,c)):(_gaq.push(["_trackEvent","Image-Upload","Failed","Not an Image"]),$.Deferred().reject("Not an image"))}function d(a){return"string"==typeof a?a.replace(/\/+/g,"/").replace(/^\/*|\/*$/g,""):null}function e(a,b,c){c=_.verifyCallback(c),o().then(function(){j.listObjects({Prefix:[config.guid,a].join("/"),MaxKeys:b},function(b,d){b?c(b,a):d&&d.Contents?c(d.Contents,a):c(b,a)})},function(b){c(b,a)})}function f(a,b,c){c=_.verifyCallback(c),o().then(function(){var d=[config.guid,a,b].join("/");j.deleteObject({Key:d},function(d,e){d?c(d,a,b):c(null,a,b)})},function(d){c(d,a,b)})}function g(a){if("string"==typeof a){var b=a.substr(a.lastIndexOf(".")),c=spotsAPI.encrypt(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");return c+b}}function h(a){return a=p(a),_.isNaN(a)||a>m?m:a}function i(b,c){var e=$.Deferred();if(c=_.isObject(c)?c:{},c.maxSize=h(c.maxSize),!b)return _gaq.push(["_trackEvent","Upload","Failed","No file selected"]),e.reject("No file selected");if(b.size>c.maxSize)return _gaq.push(["_trackEvent","Upload","Failed","Max size exceeded"]),e.reject("File size is too big. Maximum file size: "+a(m));if(c.folder=d(c.folder),!c.folder)return _gaq.push(["_trackEvent","Upload","Failed","Invalid folder"]),e.reject("Invalid folder name: "+c.folder);var f=g(b.name);if(!f)return e.reject("Invalid file name: "+b.name);var i=[config.guid,c.folder,encodeURIComponent(f)].join("/");return e.notify(null,i),o().then(function(){var a=j.putObject({Key:i,Body:b,ContentType:b.type}),d=!0;setTimeout(function(){d&&a.abort.bind(a)},config.S3UploadTimeout),a.on("httpUploadProgress",function(a){var b=Math.round(a.loaded/a.total*100);e.notify(b,i)}),a.on("success",function(){var a=[k,i].join("/");_gaq.push(["_trackEvent","Upload","Success",a]),d=!1,e.resolve(a)}),a.on("error",function(a){_gaq.push(["_trackEvent","Upload","Failed",a?a.toString():"Unknown error"]),e.reject(a)}),_.whenOnline(function(){_gaq.push(["_trackEvent","Upload","Start",c.folder]),a.send()})()},function(a){e.reject(a)}),e}var j,k,l="https://s3.amazonaws.com/",m=3145728,n=function(a){var b=a.Credentials;AWS.config.update({sessionToken:b.SessionToken,secretAccessKey:b.SecretAccessKey,expireTime:b.Expiration,accessKeyId:b.AccessKeyId});var c=a.FederatedUser.Bucket;j=new AWS.S3({params:{Bucket:c}}),k=l+c},o=function(){function a(){var a=$.Deferred(),d=_.tryFor(3,function(){spotsAPI.GET("s3/federatedtoken",null,a.resolve,function(a){c=0,setTimeout(d,5e3)})},function(){c=0,a.reject()});return d=_.whenOnline(d),a.done(function(a){n(a)}),c=Date.now()+ONE_HOUR/2,d(),b=a.promise()}var b,c=0;return function(){return c>Date.now()?b:a()}}(),p=function(){var a={B:0,KB:1,MB:2,GB:3},b=/(\d+)\s*(B|KB|MB|GB)*/,c=1024;return function(d){var e=b.exec(d);return e?Math.pow(c,a[e[2]||"B"])*Number(e[1]):NaN}}();return{upload:i,uploadImage:function(a,b,d){switch($.type(d)){case"function":d={success:d.bind(null,"success"),error:d.bind(null,"error"),progress:d.bind(null,"progress")};case"object":return c(a,b).then(d.success||_.noop,d.error||_.noop,d.progress||_.noop);default:return c(a,b)}},list:e,deleteFile:f}}(),yql=function(){function a(a){return a.replace(/[\0\n\r\b\t\\\'\"\x1a]/g,function(a){switch(a){case"\x00":return"\\0";case"\n":return"\\n";case"\r":return"\\r";case"\b":return"\\b";case"	":return"\\t";case"":return"\\Z";default:return"\\"+a}})}function b(b,c,d){return b+=_.map(c,function(b,c){return c+"='"+a(b)+"'"}).join(" and "),Number(d)&&(b+=" limit "+d),b}function c(a,c,f,g){return a=b(a,c,f),$.ajax({dataType:"json",url:d,data:{q:a,format:"json"},timeout:g||e}).then(function(a){return a.query.results?_.isArray(a.query.results.Result)?a.query.results.Result:[a.query.results.Result]:[]})}var d="http://query.yahooapis.com/v1/public/yql",e=0;return{query:c,buildQuery:b}}(),geolocation=function(){function a(a){function c(a){a?(configAPI.set("geolocation",a),d.resolve(config.geolocation)):d.reject()}a=_.verifyCallback(a);var d=$.Deferred();return config.randomizeGeolocation&&(b=config.geolocationServiceUrl+"/"+ip.random()),$.ajax({url:b,method:"POST"}).then(c,function(){return config.geolocation||null}),a?d.then(a):d}var b=config.geolocationServiceUrl;return{geolocate:_.once(a),geocode:function c(a,b,d){var e=$.Deferred(),f=yql.query("select * from geo.placefinder where ",{text:a,locale:languageManager.getLang()},b,d);return f.then(function(a){return _.map(a,function(a){return{name:a.name||_.compact([a.line2,a.line3,a.line4]).join(", "),lat:a.latitude,lon:a.longitude}})}).then(function(f){return f.length<b&&-1===a.indexOf("*")?(e.notify(f),c(a+"*",b-f.length,d).then(function(a){return f.concat(a)})):f}).then(e.resolve,e.reject),e.promise()},getCountryCode:function(){return config.geolocation?config.geolocation.country_code:"US"}}}(),ip=function(){function a(){return Math.round(256*Math.random())}function b(){var d=[a(),a(),a(),a()].join(".");return c(d)?b():d}function c(a){return d.test(a)}var d=/^10\.|^192\.168\.|^172\.16\.|^172\.17\.|^172\.18\.|^172\.19\.|^172\.20\.|^172\.21\.|^172\.22\.|^172\.23\.|^172\.24\.|^172\.25\.|^172\.26\.|^172\.27\.|^172\.28\.|^172\.29\.|^172\.30\.|^172\.31\./;return{random:b,isPrivate:c}}(),patchHelper=function(){"use strict";function a(a,b){function c(a){return a.split(".").map(function(a){return parseInt(a,10)})}for(var d,e,f=c(a),g=c(b),h=0;h<Math.max(f.length,g.length);h++)if(d=f[h]||0,e=g[h]||0,d!==e)return d>e;return!1}function b(b){b=_.verifyCallback(b);var d=c.slice(-2).shift();configAPI.setDefault("lastPatch",d&&d.version);var e=config.lastPatch,f={1:"0.1.0",2:"0.1.6"};f[e]&&(e=f[e],configAPI.set("lastPatch",e));var g,h=_.where(c,function(b){return a(b.version,e)});async.eachSeries(h,function(a,b){var c=a.version;_gaq.push(["_trackEvent","Patches",c]),a.exec(function(){configAPI.set("lastPatch",c),a.updatePage&&(g=a.updatePage),b(null)})},function(){configAPI.set("lastPatch",config.version),g&&tabs.openLinkInNewTab(g),b()})}var c=[{version:"0.1.0",exec:function(a){idb.clear("COLOR_PICKER_CACHE",function(){idb.clear("BADGES_DATA",function(){config.newtab_bg_image&&(config.newtab_bg_image.search("bg1")>0?configAPI.setMultiple(config.themes[3].settings):config.newtab_bg_image.search("bg2")>0?configAPI.setMultiple(config.themes[1].settings):config.newtab_bg_image.search("bg3")>0?configAPI.setMultiple(config.themes[2].settings):config.newtab_bg_image.search("bg4")>0?configAPI.setMultiple(config.themes[4].settings):config.newtab_bg_image.search("bg5")>0?configAPI.setMultiple(config.themes[6].settings):config.newtab_bg_image.search("bg6")>0&&configAPI.setMultiple(config.themes[7].settings)),configAPI.remove("newtab_bg_color"),configAPI.remove("newtab_bg_image"),configAPI.remove("settings_theme_list"),configAPI.remove("presets_colors"),a()})})}},{version:"0.1.6",exec:function(a){configAPI.remove("showSnow"),a()}},{version:"0.1.14",exec:function(a){["showPhone","phone_sms_notifications","phoneSpeaker"].forEach(function(a){var b="off"!==configAPI.get(a);configAPI.set(a,b)}),idb.search("COLOR_PICKER_CACHE",function(a){return!a.data.s},function(b){async.map(b,function(a,b){idb.remove("COLOR_PICKER_CACHE",a.id,function(){b()},!1)},function(){a()})})},updatePage:config.baseUpdatePageUrl+"0_1_14"},{version:"0.1.16",exec:function(a){"pt_BR"==config.selectedLanguage&&configAPI.set("selectedLanguage","pt"),a()}},{version:"0.1.17",exec:function(a){magicAPI.cleanAll(function(){a()})}},{version:"0.1.21",exec:function(a){configAPI.remove("css_list");var b=configAPI.get("ftueOpentab");1==b.step&&0==b.isShow?configAPI.set("ftueOpentab",{step:0}):configAPI.set("ftueOpentab",{step:null}),a()}},{version:"0.1.30",exec:function(a){idb.getAll("SCREENSHOTS",function(b){var c={};_.each(b,function(a){a.screenshots=JSON.parse(localStorage.getItem(a.localStorageItem)||null),localStorage.removeItem(a.localStorageItem),delete a.localStorageItem,c[a.id]=a,idb.remove("SCREENSHOTS",a.id,$.noop,!1)}),chrome.storage.local.set(c,function(){var b=/^\w{8}\-(\w{4}\-){3}\w{12}$/;_.chain(localStorage).keys().filter(function(a){return b.test(a)}).each(function(a){localStorage.removeItem(a)}),a()})})}},{version:"0.2.1",exec:function(a){config.sectionsOrder=_.map(config.sectionsOrder,function(a){switch(a){case"MostVisited":return"top_sites";case"Favorites":return"favorites";case"Discovery":return"discovery";default:return a}}),a()}},{version:"0.5.0",exec:function(a){configAPI.set("enableContentDiscovery",!1),configAPI.set("enableMobileAppsDiscovery",!1),idb.clear(spotsManager.spotID("gallery"),function(){a()})}}];return{init:b}}(),pageAction=function(){function a(a,c){chrome.tabs.get(a,function(d){d&&(chrome.pageAction.setIcon({tabId:a,path:b[c]}),chrome.pageAction.setTitle({tabId:a,title:c?"":"Add to SPOTS"}))})}var b={"false":{19:"/img/icons/pageAction/19x19.png",38:"/img/icons/pageAction/38x38.png"},"true":{19:"/img/icons/pageAction/19x19b.png",38:"/img/icons/pageAction/38x38b.png"}};config.backgroundInitialized.done(function(){chromeEvents.onTabCompleted(function(b,c,d){if(-1!==d.url.indexOf("http")&&!opentab.isTabBlacklisted(d.url)){var e=null;favorites.getItem({url:d.url},function(c){e=c?c.id:null,a(b,!!c),chrome.pageAction.show(b)}),eventManager.addEventListener(spotsManager.getSpot("favorites").id,"FAVORITES_EVENT",function(c){switch(c.type){case"UPDATE":case"DIRECTORY_UPDATE":break;case"ITEM_UPDATED":case"ITEM_ADDED":c.data.url===d.url&&(a(b,!0),e=c.data.id);break;case"ITEM_REMOVED":c.data===e&&(a(b,!1),e=null)}},void 0,b)}}),chrome.pageAction.onClicked.addListener(function(a){favorites.getItem({url:a.url},function(b){var c=b?"SHOW_REMOVE_FORM":"SHOW_ADD_FORM";eventManager.dispatchEvent(spotsManager.getSpot("favorites").id,c,null,[a.id])})})})}(),webScrapper=function(){"use strict";function a(a){return a+(a.lastIndexOf("/")===a.length-1?"":"/")+"*"}function b(b,c){c=_.verifyCallback(c),b=urls.getFullURL(urls.getHostName(b)),idb.get("SCRAPPER_META_CACHE",b,function(d){if(d&&d.expiration>(new Date).getTime())c(d.data);else if(urls.isValidUrl(b)){if(!navigator.onLine)return void c(null);var e=null,f=function(b){e=b.redirectUrl,b.redirectUrl!==b.url&&chrome.webRequest.onBeforeRedirect.addListener(f,{urls:[a(b.redirectUrl)],types:["xmlhttprequest"]})};chrome.webRequest.onBeforeRedirect.addListener(f,{urls:[a(b)],types:["xmlhttprequest"]}),$.ajax({url:b,type:"GET",dataType:"html"}).then(function(a){var d={};if(e&&(d.redirectUrl=e),chrome.webRequest.onBeforeRedirect.removeListener(f),_.isString(a)){a=a.split("<body")[0]+"</html>";var g=a.match(/<title>(.*)<\/title>/);d.title=g?g[1]:null,_.each(a.match(/<meta(.+)>/g),function(a){a=$(a);var b=a.attr("name"),c=a.attr("content");_.isEmpty(b)||_.isEmpty(c)||(d[b]=c)}),idb.add("SCRAPPER_META_CACHE",{id:b,expiration:(new Date).getTime()+h,data:d},function(){c(d)},!1)}else c(null)},function(){c(null)})}else c({title:b})})}function c(a,b){if(b=_.verifyCallback(b),a.gallery&&a.gallery.title?a.title=a.gallery.title.trim():a.meta&&a.meta.title?a.title=urls.getPrettyTitle(a.url,a.meta.title):a.title=urls.getBaseDomain(a.url),a.gallery&&a.gallery.assets&&a.gallery.assets.color&&a.gallery.assets.palette?(a.color=a.gallery.assets.color,a.picker=a.gallery.assets.palette):a.meta&&a.meta["msapplication-TileColor"]?(a.color=a.meta["msapplication-TileColor"],a.picker=[a.color]):a.webColorPicker&&a.webColorPicker.c&&(a.color=a.webColorPicker.c=_.sample(config.default_background_colors,1),a.picker=a.webColorPicker.p),a.gallery&&a.gallery.assets&&a.gallery.assets.icon)a.icon=a.gallery.assets.icon,_.isNumber(a.gallery.iconSize)&&(a.iconSize=a.gallery.iconSize);else if(a.meta&&a.meta["msapplication-TileImage"]){a.icon=a.meta["msapplication-TileImage"];var c=/^https?/.test(a.icon);if(!c){var d=/^\/\//.test(a.icon);if(d){var e=a.meta.redirectUrl&&a.meta.redirectUrl.match("https?:"),f=e?e.pop():"http";a.icon=f+a.icon}else a.icon=urls.getFullURL(urls.getHostName(a.url))+a.icon}}a.client_screenshot?a.screenshot=a.client_screenshot["800_480"]||a.client_screenshot["320_200"]:(a.webColorPicker&&a.webColorPicker.s&&(a.screenshot=a.webColorPicker.s),a.meta&&a.meta.redirectUrl&&urls.getHostName(a.url,!0)!==urls.getHostName(a.meta.redirectUrl,!0)&&browserUtils.getScreenshot(a.meta.redirectUrl,function(b){a.client_screenshot=b,a.screenshot=b["800_480"]||b["320_200"]},!0)),b(a)}function d(a,c,d,e){switch(a){case"gallery":gallery.searchByDomain(c,function(a){e(a)});break;case"meta":b(c,function(a){e(a)});break;case"webColorPicker":graphicAssets.webColorPicker(c,function(a){e(a)});break;case"client_screenshot":browserUtils.getScreenshot(c,function(a){e(a)},!1,d)}}function e(a,b,e){var f=$.Deferred();if(!urls.isValidUrl(a))return f.reject().promise();(null==b||_.isArray(b))&&(e=b,b=!1),_.isArray(e)||(e=["gallery","meta","webColorPicker","client_screenshot"]),g[a]||(g[a]={url:a});var h=[];return _.each(e,function(e){g[a][e]||h.push(function(h){d(e,a,b,function(b){b?(g[a][e]=b,c(g[a],function(b){g[a]=b,f.notify(g[a]),h()})):h()})})}),_.size(h)?(f.notify(g[a]),async.parallel(h,function(){c(g[a],function(b){g[a]=b,f.resolve(g[a])})})):f.resolve(g[a]),f.promise()}function f(a,b,c){var d=_.map(a,function(a){return e(a,b,c)});return $.when.apply($,d)}var g={},h=ONE_WEEK;return{scrape:e,scrapeAll:f}}(),configOverrides=function(){function a(){var a={thumb:"/img/themes/clean/thumb.png",settings:{bodyClass:"clean",themeId:"white",bgColor:"#F2F2F2",themeColor:"#A3A3A3",accentColor:"#77777f",bgImage:null,bgFooter:null,bgFooterHeight:null,favoritesOpacity:1,favoritesMargin:12,favoritesBorder:1,favoritesShadow:0}};config.themes.unshift(a),config.defaultThemeId=a.settings.themeId,config.opentab_enabled=!1,config.newtab_notifications_enabled=!1,config.settingTabs=_.without(config.settingTabs,"power_search"),config.isShowFtue=!1,config.ftueEnabled=!1,config.showPhone=!1,config.phone_call_notifications="none",config.phone_sms_notifications=!1,config.phoneSpeaker=!1,config.backgroundInitialized.done(function(){languageManager.setTranslation("search_input_placeholder","Search the web")})}function b(){var b=!config.userIsOrganic||"cd"in localStorage;if(b){config.userIsOrganic=!1,_.each(config.unorganicOverrides.set,function(a,b){config[b]=a}),_.each(config.unorganicOverrides.add,function(a,b){config[b]=_.isArray(config[b])?config[b].concat(a):a}),_.each(config.unorganicOverrides.remove,function(a,b){config[b]=_.difference(config[b],a)}),localStorage.uref||(localStorage.uref="sp05");var c=localStorage.uref,d=[2,c,localStorage.aflt,localStorage.cd,localStorage.cr],e=atob(config.searchProviderPattern);config.searchProviderUrl=_.format(e,d),"sp02"==c||"sp04"==c?config.limitSearchResultType=["favorites"]:"sp05"==c&&(config.limitSearchResultType=[]),("sp03"==c||"sp04"==c||"sp05"==c)&&a()}return config.showPhone||(config.settingTabs=_.without(config.settingTabs,"android")),$.Deferred().resolve().promise()}return{init:b}}(),bi=function(){"use strict";function a(a){b(),_.verifyCallback(a)()}function b(){bi.report({event_name:"alive"}),setTimeout(b,ONE_DAY)}function c(a){try{return a=_.assign({uuid:config.uuid?config.uuid:null,guid:config.guid?config.guid:null,uref:config.uref,spts_v:config.version,brand:config.brand,cd:localStorage.cd?JSON.stringify(localStorage.cd):null,install_type:localStorage.cd?"unorganic":"organic",affiliate:localStorage.aflt?localStorage.aflt:null,loc:languageManager.getSelectedLang()},a)}catch(b){}}function d(a){_.size(a)>0&&$.ajax({type:"POST",url:config.biReportingHost,data:JSON.stringify({table:"spots.spots_extension_logs",data:$.param(_.compactObject(c(a)))}),success:function(){}})}return{init:a,test:c,report:d}}(),browserUtils=function(){"use strict";function a(a,c,d,e){a=d?a:urls.getHostName(a,!0),a&&l.get(a,function(f){f=f[a],f&&f.screenshots?(moment().isAfter(f.expiration)&&g.push(a),_.verifyCallback(c)(f.screenshots)):(d||e)&&b(a,c)})}function b(a,b){b=_.verifyCallback(b),-1===_.indexOf(g,a)&&g.push(a),h[a]||(h[a]=$.Callbacks()),h[a].add(b)}function c(a,b){var c={};c[a.id]=a,l.set(c,b)}function d(a,b,d,e){_.delay(function(){chrome.tabs.getSelected(function g(h){var j=e?h.url:urls.getHostName(h.url,!0);b.windowId===h.windowId&&j==a?chrome.tabs.captureVisibleTab(b.windowId,f,function(b){if(b){var e={};async.map(k,function(c,d){graphicAssets.resizeImage(b,c.width,c.height,function(b){var f=c.width+"_"+c.height,g=f+"_"+a;graphicAssets.saveImage(b,g,"screenshots").then(function(a){e[f]=a,d()},function(){d()})})},function(){c({id:a,expiration:(new Date).getTime()+i,screenshots:e},function(){d(e)})})}else d(!1)}):chrome.tabs.onActivated.addListener(function l(a){a.tabId===b.id&&chrome.tabs.get(a.tabId,function(a){chrome.tabs.onActivated.removeListener(l),g(a)})})})},j)}function e(a,b){var c=b?a.url:urls.getHostName(a.url,!0);-1!==_.indexOf(g,c)?d(c,a,function(a){a&&(g=_.without(g,c),h[c].fire(a))},b):b||e(a,!0)}var f={format:"jpeg",quality:80},g=[],h={},i=ONE_DAY,j=ONE_SECOND/2,k=[{width:800,height:480},{width:320,height:200}],l={get:chrome.storage.local.get.bind(chrome.storage.local),set:chrome.storage.local.set.bind(chrome.storage.local),remove:chrome.storage.local.remove.bind(chrome.storage.local)};return chromeEvents.onTabCompleted(function(a,b,c){e(c,!1)}),{getScreenshot:a,captureQueue:function(){return g}}}(),idb=function(){function a(b){var c=(new Date).getTime();async.map(config.idb_tables,function(a,b){d(a,function(d){async.map(_.toArray(d),function(b,d){b.expiration&&b.expiration<c?h(a,b.id,function(){d(null)},!1):d(null)},function(){b(null)})})},function(){b?_.verifyCallback(b)():_.delay(a,ONE_HOUR)})}function b(a){var b=n[a]||$.Deferred(function(b){var c=new IDBStore({dbVersion:config.idb_version,storeName:a,keyPath:"id",onStoreReady:function(){n[a]=c,b.resolve(c)}})});return $.when(b)}function c(a,c,d){b(a).then(function(a){a.get(c.toString(),function(a){_.verifyCallback(d)(a)},function(){_.verifyCallback(d)(null)})})}function d(a,c){b(a).then(function(a){a.getAll(function(a){var b={};_.each(a,function(a){b[a.id]=a}),_.verifyCallback(c)(b)})})}function e(a){d(a,function(a){})}function f(a,c,d,e){e="undefined"!=typeof e?e:!0,b(a).then(function(b){c.id=c.id?c.id.toString():getUUID(),b.put(c,function(b){if(e){var f=c.id;delete c.id,spotsAPI.queue(a,f,"add",c,function(){c.id=f,_.verifyCallback(d)(b)})}else _.verifyCallback(d)(b)},function(a){_.verifyCallback(d)(null)})})}function g(a,c,d,e){e="undefined"!=typeof e?e:!0,d=_.verifyCallback(d),b(a).then(function(b){b.put(c,function(b){if(e){if(!("id"in c))return void d(null);var f=c.id.toString();delete c.id,spotsAPI.queue(a,f,"update",c,function(){c.id=f,d(b)})}else d(b)},function(){d(null)})})}function h(a,c,d,e){e="undefined"!=typeof e?e:!0;var f=function(b){e?spotsAPI.queue(a,c,"delete",null,function(){_.verifyCallback(d)(b)}):_.verifyCallback(d)(b)};b(a).then(function(b){b.remove(c.toString(),function(b){"NOTIFICATIONS"!==a?notificationManager.clear(a+"_"+c,function(){f(b)}):f(b)})})}function i(a,c){b(a).then(function(a){a.clear(function(){_.verifyCallback(c)()})})}function j(a,b,c){d(a,function(a){var d=_.filter(a,b);_.verifyCallback(c)(d)})}function k(a,b,c,e){d(a,function(a){var d=_.filter(a,function(a){return a[b]==c});_.verifyCallback(e)(d)})}function l(a,b,c,e){d(a,function(a){var d=_.find(a,function(a){return a[b]==c});_.verifyCallback(e)(d)})}function m(a,c,d,e){d=_.verifyCallback(d),e=_.verifyCallback(e),b(a).then(function(a){a.batch(c,function(){d()},function(a){e(a)})})}var n={};return _.delay(a,15*ONE_SECOND),{getStore:b,get:c,getAll:d,print:e,add:f,update:g,remove:h,clear:i,batch:m,search:j,getAllByKey:k,getItemByKey:l,autoClearTask:a}}(),spotsManager=function(){function a(a,b){c={favorites:{enabled:!0,searchable:!0,id:"ef974b5a-432f-472b-89c6-c92a67d60182",location:"favorites",background_scripts:["favorites_service.js","topsites_service.js","bookmarks_service.js","chromeapps_service.js","recent_sites_service.js"],name:"favorites",display_name:"Favorites",sync:!0,newtab:{enabled:!0,show_clock:!0,position:"spots_menu",controllers:["FavoritesNewtabCtrl.js","NewtabFavoritesSearchResultCtrl.js","FavoritesAddModalCtrl.js","FavoritesEditModalCtrl.js","FavoritesDeleteModalCtrl.js","FavoritesCategoriesAddModalCtrl.js","FavoritesCategoriesEditModalCtrl.js","FavoritesCategoriesDeleteModalCtrl.js","FavoritesRemoveTopSitesModalCtrl.js"],directives:["favorites.html"],css:["NewtabFavoritesSearchResult.css","FavoritesNewtab.css"],search_result_partial:"NewtabFavoritesSearchResult.html"},opentab:{enabled:!0,color:"#F1A30B",search_result_partial:"OpentabFavoritesSearchResult.html",css:["OpentabFavoritesSearchResult.css","favorites_opentab.css"]}},contacts:{enabled:!0,searchable:!0,id:"f46a7851-c2d9-4476-921c-cb5d9cf7bdaf",location:"phone",name:"contacts",display_name:"Contacts",background_scripts:["contacts_service.js"],sync:!0,newtab:{enabled:!0,controllers:["NewtabContactsSearchResultCtrl.js"],css:["NewtabContactsSearchResult.css"],search_result_partial:"NewtabContactsSearchResult.html"},idbIndexes:[{name:"id",keyPath:"id",unique:!0,multiEntry:!1}],opentab:{enabled:!0,search_result_partial:"OpentabContactSearchResult.html",css:["OpentabContactSearchResult.css"]},clear_on_logout:!0},call_log:{enabled:!0,id:"3858d2ce-b236-4071-864f-456830940106",location:"phone",background_scripts:["call_log_service.js"],name:"call_log",display_name:"Call Log",sync:!0,newtab:{enabled:!1,notification_partial:"call_log_newtab_notification.html"},idbIndexes:[{name:"timestamp",keyPath:"timestamp",unique:!1,multiEntry:!0},{name:"from",keyPath:"from",unique:!1,multiEntry:!0}],opentab:{notification_partial:"call_log_opentab_notification.html"},clear_on_logout:!0},sms:{enabled:!0,searchable:!0,id:"8f3aa049-b0ec-4344-a958-0c703200bce4",location:"phone",background_scripts:["sms_service.js"],name:"sms",display_name:"SMS",sync:!0,newtab:{enabled:!1,notification_partial:"sms_newtab_notification.html"},idbIndexes:[{name:"timestamp",keyPath:"timestamp",unique:!1,multiEntry:!0},{name:"from",keyPath:"from",unique:!1,multiEntry:!0},{name:"number",keyPath:"number",unique:!1,multiEntry:!0},{name:"type",keyPath:"type",unique:!1,multiEntry:!0}],opentab:{notification_partial:"sms_opentab_notification.html"},clear_on_logout:!0},phone:{enabled:!0,id:"phone",location:"phone",name:"phone",display_name:"Phone",background_scripts:["phone_notification.js"],sync:!1,icon:"icon-phone.png",opentab:{enabled:!0,color:"#BF1E4B",main_view:"phone_opentab.html"},clear_on_logout:!0},discovery:{enabled:!0,id:"78e57c52-fac7-5910-74fc-5051064f6354",location:"discovery",name:"discovery",display_name:"Discovery",sync:!1,icon:"icon-discovery.png",background_scripts:["discovery_service.js","outbrain_feed.js"],newtab:{enabled:!0,controllers:["NewtabDiscoveryCtrl.js","DisableDiscoveryModalCtrl.js","DiscoveryAddFacebookModalCtrl.js","DiscoveryAddFacebookNotificationCtrl.js"],css:["NewtabDiscovery.css","DiscoveryAddFacebookModal.css"],notification_partial:"DiscoveryAddFacebookNotification.html",modal_partials:{createSpotsAccount:"modals/CreateSpotsAccountModal.html",discoveryAddFacebook:"modals/DiscoveryAddFacebookModal.html"}}},apps:{enabled:!0,id:"185ecf76-f51f-4477-82eb-4c3e0dc65b94",location:"apps",name:"apps",background_scripts:["apps_service.js","apps_grabber_service.js"],display_name:"Apps",sync:!0,opentab:{enabled:!0,css:["apps_opentab.css"]},clear_on_logout:!0},facebook:{enabled:!0,searchable:!1,id:"ef974b5a-432f-472b-89c6-c92a67d60188",location:"facebook",background_scripts:["facebook_service.js"],name:"facebook",display_name:"facebook",sync:!1,newtab:{enabled:!0,notification_partial:"facebook_newtab_notification.html",controllers:["FacebookRateUsModalCtrl.js"],css:["FacebookRateUsModal.css"],modal_partials:{facebookRateUs:"modals/FacebookRateUsModal.html"}},opentab:{notification_partial:"facebook_opentab_notification.html"}},gallery:{enabled:!0,searchable:!0,id:"gallery",location:"gallery",
background_scripts:["gallery_service.js"],name:"gallery",display_name:"Gallery",sync:!1,newtab:{enabled:!1}},gameo:{enabled:!0,searchable:!0,id:"gameo",location:"gameo",background_scripts:["gameo_service.js"],name:"gameo",display_name:"Gameo",sync:!1,newtab:{enabled:!0,controllers:["NewtabGameoSearchResultCtrl.js"],search_result_partial:"NewtabGameoSearchResult.html",css:["NewtabGameoSearchResult.css"]}},"mobile-apps":{enabled:!0,id:"6f802a3e-3951-d26d-489a-8810ead964ac",location:"mobile-apps",name:"mobile-apps",display_name:"Mobile Apps",sync:!1,icon:"icon-mobile-apps.png",background_scripts:["mobile_apps_service.js","mobile_apps_feed.js"],newtab:{enabled:!0,controllers:["NewtabMobileAppsCtrl.js","DisableMobileAppsModalCtrl.js"],css:["NewtabMobileApps.css"]}},review:{enabled:!0,id:"review",location:"review",name:"review",display_name:"Review",sync:!1,newtab:{enabled:!0,controllers:["NewtabReviewCtrl.js"],directives:["NewtabReview.html"],css:["NewtabReview.css"]}},search:{enabled:!0,id:"7e0f48f9-9501-41ec-8aee-8cb067451a6a",location:"search",name:"search",display_name:"Search",sync:!1,background_scripts:["search_service.js","websearch_service.js","affiliatedSearch_service.js"],newtab:{enabled:!0,controllers:["SearchCtrl.js","NewtabSearchResultCtrl.js"],directives:["search.html"],css:["NewtabSearchResult.css"],search_result_partial:"NewtabSearchResult.html"},opentab:{enabled:!0,color:"#1BA0E1",main_view:"search_opentab.html",search_result_partial:"OpentabSearchResult.html",css:["OpentabSearchResult.css","search_opentab.css"]}},weather:{enabled:!0,id:"412ee6f2-5147-5fc7-4039-708c156dc63d",location:"weather",name:"weather",display_name:"Weather",sync:!1,icon:"icon-weather.png",background_scripts:["weather_service.js"],newtab:{enabled:!0,controllers:["NewtabWeatherCtrl.js","NewtabClockCtrl.js"],css:["NewtabWeather.css"],notification_widgets:[{name:"Clock",priority:100,partial:"NewtabClock.html",icon:"images/clock-icon-small.png"},{name:"Weather",priority:200,partial:"NewtabWeather.html",icon:"images/cloud-icon-small.png"}]},opentab:{enabled:!1,notification_widgets:[{name:"Clock",priority:100,partial:"OpentabClock.html",icon:"images/clock-icon-small-black.png"},{name:"Weather",priority:200,partial:"OpentabWeather.html",icon:"images/cloud-icon-small-black.png"}]}}},a(c)}function b(a){return c||d.then(_.verifyCallback(a))}var c=null,d=$.Deferred();return{init:a,getSpots:b,getSpotsArray:function(){return _.toArray(c)},getSpotByID:function(a){return _.find(c,{id:a})},spotID:function(a){return c[a].id},getSpot:function(a){return c[a]}}}(),spotsAPI=function(){function a(a,b){s=!1,p=!1,idb.clear("SPOTS_DATA",function(){idb.clear("SERVER_QUEUE",function(){j(null,a,b)})})}function b(b,c,d,e){return _.extend(n,{token:config.token,uuid:config.uuid,guid:config.guid}),n.token?void $.ajax(config.url_api+"/"+b,{headers:n,dataType:"json",data:{data:c?JSON.stringify(c):""},type:"POST",complete:function(b){var c;try{c=JSON.parse(b.responseText)}catch(f){c=b.responseText}switch(b.status){case 200:_.verifyCallback(d)(c);break;case 400:_gaq.push(["_trackEvent","spotsAPI","Error",400]),a(null,e);break;case 409:_gaq.push(["_trackEvent","spotsAPI","Error",409]),a(null,e);break;case 401:_gaq.push(["_trackEvent","spotsAPI","Error",401]),user.logout(),eventManager.dispatchEvent("CONFIG","USER_TOKEN_EXPIRED",null);break;case 500:case 502:case 666:default:_gaq.push(["_trackEvent","spotsAPI","Error",b.status]),_.verifyCallback(e)(c)}}}):void _.verifyCallback(e)()}function c(b,c,d,e){return _.extend(n,{token:config.token,uuid:config.uuid,guid:config.guid}),n.token?void $.ajax(config.url_api+"/"+b,{headers:n,dataType:"json",data:{data:c?JSON.stringify(c):""},type:"GET",complete:function(b){var c;try{c=JSON.parse(b.responseText)}catch(f){c=b.responseText}switch(b.status){case 200:_.verifyCallback(d)(c);break;case 401:user.logout(),eventManager.dispatchEvent("CONFIG","USER_TOKEN_EXPIRED",null),_.verifyCallback(e)();break;case 409:_gaq.push(["_trackEvent","spotsAPI","Error",409]),a(d,e);break;case 500:case 502:case 666:default:_gaq.push(["_trackEvent","spotsAPI","Error",b.status]),_.verifyCallback(e)(c)}}}):void _.verifyCallback(e)()}function d(a,b,c,d,e){var f=spotsManager.getSpotByID(a);if(f&&f.sync){var g={id:"rq_"+Date.now(),timestamp:Date.now(),spot_id:a,object_id:b,type:c};"delete"!=c&&(g.object_data=d),idb.add("SERVER_QUEUE",g,function(a){o(),_.verifyCallback(e)(a)},!1)}else _.verifyCallback(e)(!0)}function e(a,c){if(p)q.push({success:a,error:c});else{if(p=!0,!n.token)return void g();idb.getAll("SERVER_QUEUE",function(d){idb.getAll("SPOTS_DATA",function(e){var h={};m=[],_.each(d,function(a){m.push(a.id);var b=_.find(h,{spot_id:a.spot_id,object_id:a.object_id,type:a.type});b?b.timestamp<a.timestamp&&(h[b.object_id]=null,h[a.object_id]=a):h[a.object_id]=a});var j={};_.each(h,function(a){j[a.spot_id]||(j[a.spot_id]={},j[a.spot_id].spot_id=a.spot_id,j[a.spot_id].sequences=[{}],j[a.spot_id].sequences[0].sequence=e[a.spot_id]?parseInt(e[a.spot_id].sequence)+1:1,j[a.spot_id].sequences[0].sequence_data=[]),j[a.spot_id].sequences[0].sequence_data.push({object_id:a.object_id,type:a.type,object_data:k(a.object_data)})});var l=[];return _.each(j,function(a){l.push(a)}),l.length<1?(_.verifyCallback(a)(),void g()):void b("spot",l,function(){var b={};_.each(l,function(a){_.each(a.sequences,function(c){(!b[a.spot_id]||b[a.spot_id].value.sequence<c.sequence)&&(b[a.spot_id]={spot_id:a.spot_id,sequence:c.sequence})})}),async.each(_.toArray(b),function(a,b){i(a.spot_id,a.sequence,b)},function(){f(m,function(){g(),_.verifyCallback(a)()})})},function(){g(),_.verifyCallback(c)()})})})}}function f(a,b){var c=_.map(a,function(a){return{type:"remove",key:a}});idb.batch("SERVER_QUEUE",c,b,b)}function g(){if(p=!1,q.length>0){var a=q.pop();e(a.success,a.error)}}function h(a,b,c){idb.get("SPOTS_DATA",a,function(d){d?_.verifyCallback(b)(d.sequence):c&&i(a,0,function(){h(a,b,c)},c)})}function i(a,b,c,d){idb.update("SPOTS_DATA",{id:a,sequence:b},function(a){a?_.verifyCallback(c)(a):d&&_.verifyCallback(d)(a)},!1)}function j(a,b,d){s?r.push({spotsList:a,success:b,error:d}):(s=!0,idb.getAll("SPOTS_DATA",function(e){var f=[],g={};_.each(spotsManager.getSpotsArray(),function(b){var c={spot_id:b.id,sequence:0};e[b.id]&&e[b.id].sequence&&(c.sequence=parseInt(e[b.id].sequence)),b.sync&&(!a||_.isArray(a)&&0==a.length?f.push(c):a&&_.indexOf(a,b.id)>-1&&f.push(c)),g[c.spot_id]=c.sequence}),c("spot",f,function(a){var c,e,f,g,h=0,i=[];async.eachSeries(a,function(a,b){f=a.spot_id,g=spotsManager.getSpotByID(f).display_name,a.snapshot&&_.size(a.snapshot)>0?(c=[],_.each(a.snapshot,function(a,b){try{a=l(a),a.id=b,c.push({type:"put",value:a})}catch(d){}}),c.length>0?idb.clear(f,function(){idb.batch(f,c,function(){spotsAPI.setSequence(f,parseInt(a.sequence),function(){h+=c.length,i.push(f),b(null)})},function(){spotsAPI.setSequence(f,0,function(){b(f)})})}):b(null)):a.sequences&&_.size(a.sequences)>0?(c=[],_.each(a.sequences,function(a){e=a.sequence,_.each(a.sequence_data,function(a){try{switch(a.object_data=l(a.object_data),a.object_data.id=a.object_id,a.type){case"add":case"update":c.push({type:"put",value:a.object_data});break;case"remove":c.push({type:"remove",value:a.object_data})}}catch(b){}})}),c.length>0?idb.batch(f,c,function(){spotsAPI.setSequence(f,parseInt(e),function(){h+=c.length,i.push(f),b(null)})},function(a){b(f)}):spotsAPI.setSequence(f,parseInt(e),function(){h+=c.length,i.push(f),b(null)})):b(null)},function(c){if(_.each(i,function(b){eventManager.dispatchEvent(b,"UPDATE_EVENT",a)}),s=!1,r.length>0){var e=r.pop();j(e.spotsList,e.success,e.error)}c?_.verifyCallback(d)():_.verifyCallback(b)()})},function(){s=!1})}))}function k(a){if(a){var b=PPbnlErCVt.enc.Utf8.parse(PPbnlErCVt.shpErMgSwS(config.guid+config.wRLSfuYqTS).toString().substr(16)),c=PPbnlErCVt.enc.Utf8.parse(PPbnlErCVt.shpErMgSwS(config.wRLSfuYqTS+config.guid).toString().substr(0,16));a=JSON.stringify(a),a=PPbnlErCVt.NThBPBQDDd.encrypt(a,b,{iv:c}).toString()}return a}function l(a){if(a){a=a.replace(/\s/g,"+");var b=PPbnlErCVt.enc.Utf8.parse(PPbnlErCVt.shpErMgSwS(config.guid+config.wRLSfuYqTS).toString().substr(16)),c=PPbnlErCVt.enc.Utf8.parse(PPbnlErCVt.shpErMgSwS(config.wRLSfuYqTS+config.guid).toString().substr(0,16));a=PPbnlErCVt.NThBPBQDDd.decrypt(a,b,{iv:c}).toString(PPbnlErCVt.enc.Utf8),a=JSON.parse(a)}return a}var m,n={ct:"ch",cv:window.navigator.appVersion.match(/Chrome\/(.*?) /)[1],res:screen.width+"x"+screen.height,v:config["spots.version"],c:""},o=_.debounce(e,config.api_autoPostTimer),p=!1,q=[],r=[],s=!1;return{POST:b,GET:c,queue:d,postQueue:e,getSequence:h,setSequence:i,clearAndRequestUpdate:a,requestUpdate:j,encrypt:k,decrypt:l}}(),eventManager=function(){function a(a){a=_.verifyCallback(a),_.delay(c.bind(null,!0),config.cleanupEventListenersInterval),chromeEvents.onTabRemoved(function(a,b){eventManager.removeTabEvents(a)}),_.each([chromeEvents.onTabLoading,chromeEvents.onTabCompleted],function(a){a(function(a,b,c){b.url&&eventManager.removeTabEvents(a)})}),a()}function b(a,b){k[a]={$broadcast:b}}function c(a){var b=_.chain(j).pluck("tabID").unique().compact().value();chrome.tabs.query({},function(d){var e=_.pluck(d,"id"),f=_.difference(b,e);_(f).forEach(eventManager.removeTabEvents),a&&_.delay(c.bind(null,!0),config.cleanupEventListenersInterval)})}function d(a,b,c,d){_.each(j,function(d){if(d&&a==d.spot&&b==d.eventType&&d.eventHandler)try{d.eventHandler(c)}catch(e){_gaq.push(["_trackEvent","Error","EventManager",e.toString()]),"TypeError"==e.name&&g(d.spot,d.eventType,d.eventHandler)}}),_.each(k,function(d){d.$broadcast(a+"_"+b,c)}),opentab.dispatchEvent(a,b,c,d)}function e(a,b,c,d,e){j.push({spot:a,eventType:b,eventHandler:c,scope:d,tabID:e}),d&&d.$on("$destroy",function(){g(a,b,c)})}function f(a){j=_.reject(j,function(b){return b.tabID==a}),k[a]&&delete k[a]}function g(a,b,c){_.each(j,function(d,e){d&&a==d.spot&&b==d.eventType&&c==d.eventHandler&&j.splice(e,1)})}function h(){return j}function i(){return k}var j=[],k={};return{init:a,cleanupEventListeners:c,dispatchEvent:d,addEventListener:e,removeEventListener:g,getListenerList:h,getScopeList:i,removeTabEvents:f,addScope:b}}(),languageManager=function(){"use strict";function a(a){a=_.verifyCallback(a),j=b(),c(j,a)}function b(){if(config.selectedLanguage&&""!=config.selectedLanguage)return _gaq.push(["_trackEvent","Languages",config.selectedLanguage,"Selected"]),config.selectedLanguage;if(window.navigator.language){var a=window.navigator.language.substr(0,2);return-1!=config.languagesOptions.indexOf(a)?(_gaq.push(["_trackEvent","Languages",a,"Default"]),a):(_gaq.push(["_trackEvent","Languages",k,"Default-Not-In-Index"]),k)}return _gaq.push(["_trackEvent","Languages",k,"Default-Navigator-Not-Set"]),k}function c(a,b){b=_.verifyCallback(b),d(a,function(c){"en"!=a?d("en",function(a){l=_.extend({},a,c),b()}):(l=c,b())})}function d(a,b){b=_.verifyCallback(b),$.ajax("/locales/i18n_"+a+".json",{dataType:"text",type:"GET",success:function(a){try{var c=JSON.parse(a);b(c)}catch(d){}},error:function(a){}})}function e(){a(function(){eventManager.dispatchEvent("SETTINGS","LANGUAGE_CHANGED",{obg:l,langName:j})})}function f(){return l}function g(){return j}function h(a){return l[a]?l[a]:""}function i(a,b){l[a]=b}var j,k="en",l={};return{init:a,changeLang:e,getLangObj:f,getLang:g,getSelectedLang:b,getTranslation:h,setTranslation:i}}(),pushService=function(){function a(){return c=new EventSource(config.url_pushServer+config.guid),c.addEventListener("open",function(a){}),c.addEventListener("error",function(a){}),c.addEventListener("message",function(a){var b=JSON.parse(a.data),c=JSON.parse(b.message["default"]);config.uuid!==c.uuid&&("1"==c.type?(e=_.union(e,c.data),d&&(clearTimeout(d),delete d),d=setTimeout(function(){spotsAPI.requestUpdate(e,function(){d&&(clearTimeout(d),delete d,e=[])})},ONE_SECOND)):(c.data.data.event_data=spotsAPI.decrypt(c.data.data.event_data),eventManager.dispatchEvent(c.data.data.spot_id,c.data.data.event_type,c.data.data.event_data)))}),$.Deferred().resolve().promise()}function b(a,b,c,d,e){function f(){configAPI.set("notification_api_sequence",config.notification_api_sequence+1)}configAPI.setDefault("notification_api_sequence",Math.round(parseInt((new Date).getTime())/1e5)),spotsAPI.POST("notify",{data:{spot_id:a,event_type:b,event_data:spotsAPI.encrypt(c)},sequence:config.notification_api_sequence},function(){f(),_.verifyCallback(d)()},function(){f(),_.verifyCallback(e)()})}var c,d,e=[];return{init:a,destroy:function(){c=null},sendNotification:b}}(),notificationManager=function(){"use strict";function a(a){a=_.verifyCallback(a),_.each(spotsManager.getSpotsArray(),function(a){a.newtab&&a.newtab.notification_partial?j[a.id]="/app/spots/"+a.location+"/newtab/partials/"+a.newtab.notification_partial:j[a.id]="/app/newtab/partials/notifications/DefaultNotification.html",a.opentab&&a.opentab.notification_partial?k[a.id]="/spots/"+a.location+"/opentab/partials/"+a.opentab.notification_partial:k[a.id]="/newtab/opentab/notifications/DefaultNotification.html",a.newtab&&_.isArray(a.newtab.notification_widgets)&&_.each(a.newtab.notification_widgets,function(b){b.name&&b.partial&&(b.partial="/app/spots/"+a.location+"/newtab/partials/"+b.partial,b.icon&&(b.icon="/app/spots/"+a.location+"/"+b.icon),l.push(b))}),a.opentab&&_.isArray(a.opentab.notification_widgets)&&_.each(a.opentab.notification_widgets,function(b){b.name&&b.partial&&(b.partial="/"+a.location+"/opentab/partials/"+b.partial,b.icon&&(b.icon="/app/spots/"+a.location+"/"+b.icon),m.push(b))})}),notificationManager.getAll(null,function(b){var c=(new Date).getTime();_.each(b,function(a){a.expiration-c<0?e(a.id,null):_.delay(function(){e(a.id,null)},a.expiration-c)}),a()})}function b(a,b){b=_.verifyCallback(b),a&&a.spotID&&a.objectID&&a&&(a.id=a.spotID+"_"+a.objectID,a.expiration||(a.expiration=(new Date).getTime()+ONE_DAY),_.isUndefined(a.priority)&&(a.priority=3),_.isUndefined(a.newtab)&&(a.newtab=!0),_.isUndefined(a.opentab)&&(a.opentab=!0),_.isUndefined(a.timestamp)&&(a.timestamp=(new Date).getTime()),a.expiration>(new Date).getTime()&&idb.add(i,a,function(){idb.get(a.spotID,a.objectID,function(c){a.data=c,eventManager.dispatchEvent("NOTIFICATIONS","NOTIFICATION_ADDED",a),a.toast&&(_.isUndefined(a.toast.priority)&&(a.toast.priority=a.priority-2),chrome.notifications.create(a.id,a.toast,function(){})),_.delay(function(){e(a.id,null)},a.expiration-(new Date).getTime()),b(a.id)})},!1))}function c(a,b){b=_.verifyCallback(b),idb.get(i,a,function(a){a&&!a.data?idb.get(a.spotID,a.objectID,function(c){a.data=c,b(a)}):b(a)})}function d(a,b){b=_.verifyCallback(b),idb.getAll(i,function(c){c=a?_.where(c,a):_.toArray(c),async.each(c,function(a,b){a.data?b(null):idb.get(a.spotID,a.objectID,function(c){a.data=c,b(null)})},function(){b(c)})})}function e(a,b){b=_.verifyCallback(b),c(a,function(c){c?idb.remove(i,a,function(){eventManager.dispatchEvent("NOTIFICATIONS","NOTIFICATION_CLEARED",c),chrome.notifications.clear(a,function(){}),b()},!1):b()})}function f(a){(a=_.verifyCallback(a))(m)}function g(a){(a=_.verifyCallback(a))(k)}function h(a){a=_.verifyCallback(a),idb.clear(i,function(){eventManager.dispatchEvent("NOTIFICATIONS","ALL_NOTIFICATIONS_CLEARED",null),a()})}var i="NOTIFICATIONS",j={},k={},l=[],m=[];return chrome.notifications.onClosed.addListener(function(a,b){b&&e(a,null)}),{set:b,get:c,getAll:d,clear:e,clearAll:h,init:a,notificationPartials:j,getOpentabNotificationPartials:g,notificationWidgets:l,getOpentabNotificationWidgets:f}}(),user=function(){function a(){try{idb.clear("SERVER_QUEUE"),idb.clear("MAGIC_DATA"),idb.clear("NOTIFICATIONS"),notificationManager.clearAll(function(){}),_.each(spotsManager.getSpots(),function(a){a.clear_on_logout&&(spotsAPI.setSequence(a.id,0),idb.clear(a.id,function(){eventManager.dispatchEvent(a.id,"UPDATE_EVENT",null)}))}),configAPI.set("apps_spot_used",!1),pushService.destroy(),configAPI.set("guid",null),configAPI.set("token",null),configAPI.set("user",null),configAPI.set("loginDate",null),configAPI.set("passThroughDate",null),eventManager.dispatchEvent("CONFIG","USER_LOGOUT_SUCCESS"),_gaq.push(["_trackEvent","Logout",config.idp,"Success"])}catch(a){eventManager.dispatchEvent("CONFIG","USER_LOGOUT_ERROR"),_gaq.push(["_trackEvent","Logout",config.idp,"Error"])}}function b(){_gaq.push(["_trackEvent","User","Token-Renew","Called"]),spotsAPI.POST("auth/renew/",{},function(a){configAPI.set("user",a),configAPI.set("token",a.token),configAPI.set("guid",a.guid),configAPI.set("token_last_renew",(new Date).getTime()),_gaq.push(["_trackEvent","Login","Token-Renew","Success"])},function(){_gaq.push(["_trackEvent","Login","Token-Renew","Failed"])})}function c(){if(!f())return null;var a={givenName:config.user.givenName,familyName:config.user.familyName,display:[config.user.givenName,config.user.familyName].join(" "),phones:{}};return config.user.fbid?a.image="https://graph.facebook.com/"+config.user.fbid+"/picture":config.user.gpicture&&(a.image=config.user.gpicture),a}function d(){_.each(config.idb_tables,function(a){idb.clear(a)}),_.each(spotsManager.getSpots(),function(a){idb.clear(a.id)}),configAPI.restoreDefaults(),setTimeout(function(){chrome.runtime.reload()},3e3)}function e(){return config.userIsOrganic}function f(){return!!_.size(config.user)}function g(){function a(a){var b=[];return _.each(a,function(a,c){_.isString(a)&&b.push(c+": "+a)}),b.join("\n")}var b=[];async.eachSeries([function(c){var d={version:config.version,token:config.token,uuid:config.uuid,didLogin:config.didLogin,installedAndroidApp:config.installedAndroidApp,hasAndroidDevices:config.hasAndroidDevices,user:config.user,token_last_renew:config.token_last_renew,installationDate:config.installationDate,idp:config.idp};b.push(a(d)),c()},function(c){idb.getAll("SPOTS_DATA",function(d){var e={};_.each(d,function(a){var b=spotsManager.getSpotByID(a.id);b&&b.sync&&(e[b.name]=a.sequence)}),b.push(a(e)),c()})},function(c){b.push(a(navigator))},function(a){chrome.tabs.captureVisibleTab(null,{},function(c){b.push(c),a()})}],function(){})}return window.login={src:null,type:null},{logout:a,tokenRenew:b,userContact:c,clearAll:d,isOrganic:e,isLoggedIn:f,hasAccount:f,getUserReport:g}}(),magicAPI=function(){function a(a){eventManager.addEventListener("NOTIFICATIONS","ALL_NOTIFICATIONS_CLEARED",e),f(),setInterval(h,ONE_DAY),a()}function b(a,b){u?v.push(a):b.apply(a)}function c(){if(u=!1,v.length>0){var a=v.pop();a.func.apply(null,a.args)}}function d(a,e,f){b({func:d,args:[a,e,f]},function(){u=!0,l(a,e,function(b){b&&b.notifications&&b.notifications[f]&&(delete b.notifications[f],_.isEmpty(b.notifications)&&delete b.notifications,o(b,function(){eventManager.dispatchEvent("MAGIC","ITEM_UPDATED",a),c()}))})})}function e(){b({func:e,args:[]},function(){idb.search(t,function(a){return void 0!==a.notifications},function(a){var b=[];_.each(a,function(a){delete a.notifications,b.push({type:"put",value:a})}),_.size(b)>0?idb.batch(t,b,function(){c()},function(){c()}):c()})})}function f(){b({func:f,args:[]},function(){idb.search(t,function(a){return void 0!==a.notifications},function(a){var b=[];notificationManager.getAll(null,function(d){if(d){var e=_.values(a);_.each(e,function(a){var c=_.keys(a.notifications),e=!1;_.each(c,function(b){_.find(d,function(a){return a.id==b})||(delete a.notifications[b],0==_.size(a.notifications)&&delete a.notifications,e=!0)}),e&&b.push({type:"put",value:a})}),_.size(b)>0?idb.batch(t,b,function(){c()},function(){c()}):c()}else c()})})})}function g(a,d,e){b({func:g,args:[a,d,e]},function(){l(a,d,function(b){b||(b=n(a,d,0)),b.notifications||(b.notifications={}),b.notifications[e]=(new Date).getTime(),o(b,function(){eventManager.dispatchEvent("MAGIC","ITEM_UPDATED",a),c()})})})}function h(){idb.getAll(t,function(a){_.each(a,function(a){if(a.score){var b=a.score-1;0!=b||a.notifications?(a.score=b,idb.update(t,a,function(a){},!1)):q(a.spotID,a.objectID)}})})}function i(a,b){var c={id:a,timestamp:parseInt(b,10)};idb.add(t,c,function(a){},!1)}function j(a,b){idb.get(t,a,function(a){b(a?a.timestamp:0)})}function k(a,b){idb.search(t,function(b){return b.spotID==a},function(a){0==a.length&&(a={}),b(a)})}function l(a,b,c){var d=m(a,b);idb.get(t,d,function(a){c(a)})}function m(a,b){return a+"_"+b}function n(a,b,c){var d={id:m(a,b),spotID:a,objectID:b,score:c};return d}function o(a,b){b=_.verifyCallback(b),idb.add(t,a,function(a){b()},!1)}function p(a,b){var c=[];_.each(b,function(a){c.push({type:"put",value:a})}),idb.batch(t,c,function(){eventManager.dispatchEvent("MAGIC","ITEM_UPDATED",a)},function(){eventManager.dispatchEvent("MAGIC","ITEM_UPDATED",a)})}function q(a,b){var c=m(a,b);idb.remove(t,c,function(a){},!1)}function r(a,b){l(a,b,function(c){c||(c=n(a,b,0)),c.score++,idb.add(t,c,function(a){},!1)})}function s(a){a=_.verifyCallback(a),idb.clear("MAGIC_DATA",function(){a()})}var t="MAGIC_DATA",u=!1,v=[];return{init:a,setItems:p,removeItem:q,getItem:l,getItems:k,cleanAll:s,incrementItemScore:r,getLastUpdateTimestamp:j,setLastUpdateTimestamp:i,handleNotification:g,clearNotification:d,createMagicItem:n,getObjectKey:m}}(),opentab=function(){function a(){chrome.runtime.onConnect.addListener(function(a){a.onMessage.addListener(function(b){if("spots"==a.name)if(b.tab=a.sender.tab,b.sync){var c=window[b.serviceName][b.functionName].apply(window[b.serviceName],b.args);a.postMessage({result:[c],data:b})}else b.args.push(function(){a.postMessage({result:Array.prototype.slice.call(arguments),data:b})}),window[b.serviceName][b.functionName].apply(window[b.serviceName],b.args)}),setInterval(function(){_.each(k,function(a,b){_.each(a,function(b){"undefined"!=typeof a.expirationDate&&new Date(a.expirationDate).getTime()>(new Date).getTime()&&idb.remove("NOTIFICATIONS_DATA",a.id,null,!1)})})},ONE_HOUR/2)}),idb.getAll("NOTIFICATIONS_DATA",function(a){_.each(a,function(a){g(a)})})}function b(a,b,c,d){var e={msgType:l.event,spot:a,eventType:b,data:null==c?null:c};f(e,d)}function c(a,b,c,d,e){var h={msgType:l.notification,spot:a,id:b,priority:c,data:d,expirationDate:e},i={spot:a,id:b,priority:c,data:d,expirationDate:e,isRemoved:!1};idb.add("NOTIFICATIONS_DATA",i,function(){g(i)},!1),f(h)}function d(a,c){var d={spot:a,id:c};idb.search("NOTIFICATIONS_DATA",function(b){return b.id==c&&b.spot==a},function(a){_.each(a,function(a){a.isRemoved=!0,idb.update("NOTIFICATIONS_DATA",a,function(){h(a)},!1)})}),b("OpentabNotifications",m.remove,d)}function e(a,c,d,e,f){var g={spot:a,id:c,priority:d,notificationData:e,expirationDate:f},i={spot:a,id:c,priority:d,data:g,expirationDate:f,isRemoved:!1};idb.update("NOTIFICATIONS_DATA",i,function(){h(i)},!1),_.isUndefined(k[a])&&(k[a]=[]),k[a].push(g),b("OpentabNotifications",m.update,g)}function f(a,b){chrome.windows.getAll({populate:!0},function(c){_.each(c,function(c){var d=_.filter(c.tabs,function(a){return 0===a.url.indexOf("http")});b&&(d=_.filter(d,function(a){return _.contains(b,a.id)})),_.each(d,function(b){chrome.tabs.sendMessage(b.id,a)})})})}function g(a){"undefined"==typeof k[a.spot]&&(k[a.spot]=[]),k[a.spot].push(a)}function h(a){_.each(k[a.spot],function(b,c){b.id==a.id&&(k[a.spot][c]=a)})}function i(a){return"undefined"!=typeof a?k[a]:k}function j(a,b){for(var c=Array.isArray(config.blackListedSites)&&config.blackListedSites.length,d=[];c--;)try{d.push(new RegExp.Safe(atob(config.blackListedSites[c])).source)}catch(e){}return!(0===d.length||!new RegExp(d.join("|")).test(a))}var k={},l={event:"event",notification:"notification"},m={remove:"remove",update:"update"};return a(),{dispatchEvent:b,addNotification:c,removeNotification:d,updateNotification:e,getNotifications:i,isTabBlacklisted:j}}(),graphicAssets=function(){"use strict";function a(a,b){b=_.verifyCallback(b);var c=null;switch(a.length){case 7:case 6:c=o.exec(a);break;case 4:case 3:c=p.exec(a);break;default:return{r:0,g:0,b:0}}return c&&(c={r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)}),b(c),c}function b(b,c,d){d=_.verifyCallback(d);var e=a(b,null);c>1&&(c/=100);var f="rgba("+e.r+","+e.g+","+e.b+","+c+")";return d(f),f}function c(a,b,c,d){d=_.verifyCallback(d);var e="#"+((1<<24)+(a<<16)+(b<<8)+c).toString(16).slice(1);return d(e),e}function d(b,d,e){e=_.verifyCallback(e),d=d?d:1;var f=a(b);return f.r=_.keepWithinRange(Math.round(f.r*d),0,255),f.g=_.keepWithinRange(Math.round(f.g*d),0,255),f.b=_.keepWithinRange(Math.round(f.b*d),0,255),b=c(f.r,f.g,f.b,null),e(b),b}function e(b,c,d){d=_.verifyCallback(d);var e,f;if("#ffffff"==b||"#fff"==b)f="#000000";else if("#000000"==b||"#000"==b)f="#ffffff";else{try{var g=a(b?b:"#ffffff");e=(299*g.r+587*g.g+114*g.b)/255e3}catch(h){e=1}f=e>=c?"#000000":"#ffffff"}return d(f),f}function f(a,b){b=_.verifyCallback(b),a=urls.getHostName(a,!0),idb.getItemByKey("COLOR_PICKER_CACHE","url",a,function(c){if(c)b(c.data,a);else{if(!navigator.onLine)return void b();try{$.ajax({dataType:"json",type:"GET",cache:!1,timeout:15e3,url:config.color_picker_api,data:{url:"http://"+a},success:function(c){c?(c.p=_.uniq(c.p),"#ffffff"==c.c.toLowerCase()&&(c.c="#212121"),c.r&&c.s&&idb.add("COLOR_PICKER_CACHE",{url:a,data:c,added:(new Date).getTime(),expiration:(new Date).getTime()+(c.r?ONE_WEEK:3*ONE_HOUR)},null,!1),b(c,a)):b()},error:function(){b()}})}catch(d){b()}}})}function g(a){return"string"==typeof a?0===a.indexOf("data:"):!1}function h(a){return"[object Blob]"===Object.prototype.toString.call(a)}function i(a,b){return a=h(a)?a:g(a)?dataURLtoBlob(a):null,a&&b&&(a.name=b),a}function j(a,b){if(b=_.verifyCallback(b),a instanceof Image||a instanceof HTMLImageElement||"IMG"===a.tagName)b(a);else{var c=new Image;if(g(a))c.src=a,b(c);else if(h(a)){var d=new FileReader;d.onload=function(a){c.src=a.target.result,b(c)},d.readAsDataURL(a)}else b(null)}}function k(a,b,c,d){j(a,function(a){b=Number(b)||500,c=Number(c)||500;var e=document.createElement("canvas"),f=document.createElement("canvas"),g=1;a.width>b?g=b/a.width:a.height>c&&(g=c/a.height),f.width=a.width,f.height=a.height,f.getContext("2d").drawImage(a,0,0),e.width=a.width*g,e.height=a.height*g,e.getContext("2d").drawImage(f,0,0,f.width,f.height,0,0,e.width,e.height),d(e.toDataURL())})}function l(a,b,c){var d=$.Deferred();if(!a)return d.reject();b=Number(b)||.92,b>1&&(b=1),0>b&&(b=0);var e=new Image;return e.src=(window.URL||window.webkitURL).createObjectURL(a),e.onload=function(){var a=document.createElement("canvas");a.width=e.width,a.height=e.height,a.getContext("2d").drawImage(e,0,0);var f=_.tryFor(5,function(b){a.toBlob(function(a){a.size>c?f(b-.1):d.resolve(a)},"image/jpeg",b)},d.reject);f(b)},d}function m(a){return _.isString(a)?spotsAPI.encrypt(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,""):getUUID()}function n(a,b,c){var d=$.Deferred();return a=i(a),a?(b=m(b),(window.requestFileSystem||window.webkitRequestFileSystem)(window.PERSISTENT,null,function(e){e.root.getDirectory(c,{create:!0},function(c){c.getFile(b,{create:!0},function(b){b.createWriter(function(c){c.onwriteend=d.resolve.bind(d,b.toURL()),c.onwritestart=d.notify,c.onwrite=d.notify,c.onerror=d.reject,c.write(a)},d.reject)},d.reject)},d.reject)})):d.reject(),d.promise()}var o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,p=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,q=_.memoize(function(a){return $.Deferred(function(b){if("string"==typeof a)if(g(a))b.resolve(a);else{var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==c.readyState&&200==c.status&&0===c.response.type.indexOf("image/")){var a=new FileReader;a.onload=function(a){b.resolve(a.target.result)},a.readAsDataURL(c.response)}},c.open("GET",a),c.responseType="blob",c.send()}else b.resolve("data:image/png;base64,")})});return{hexToRgb:a,hexToRgba:b,rgbToHex:c,colorLuminance:d,contrastFilter:e,webColorPicker:f,resizeImage:k,lowerImageQuality:l,toDataURL:q,toBlob:i,saveImage:n,toImageElement:j,isDataURL:g}}.call(this),userVoice=function(){"use strict";function a(a){var b=config.guid?config.guid:(new Date).getTime(),c=config.userVoiceData;idb.getAll("SPOTS_DATA",function(d){var e=[];_.each(d,function(a){var b=spotsManager.getSpotByID(a.id);b&&b.sync&&e.push(spotsManager.getSpotByID(a.id).name+"-"+a.sequence)});var f=e.join("|"),g={version:config.version,token:config.token,uuid:config.uuid,didLogin:config.didLogin,installedAndroidApp:config.installedAndroidApp,hasAndroidDevices:config.hasAndroidDevices,userSize:_.size(config.user),token_last_renew:config.token_last_renew,installationDate:config.installationDate,idp:config.idp,sequences:f};g=JSON.stringify(g),g=spotsAPI.encrypt(g);var h={guid:b,data:g,forum:c.forum,sid:c.sid};a(h)})}return{getCustomParams:a}}(),remoteScripts=function(){function a(a){b(),setInterval(function(){b()},config.remoteScriptsInterval),_.verifyCallback(a)()}function b(){config.remoteScripts&&(_.isArray(config.remoteScripts)?_.each(config.remoteScripts,c):_.isString(config.remoteScripts)?c(config.remoteScripts):analytics.reportError("remoteScripts",2,"Unknown variable type",null))}function c(a){a+="?cb="+(new Date).getTime(),navigator.onLine&&$.getScript(a).done(function(){}).fail(function(){analytics.reportError("remoteScripts",3,"Remote script load failed",a)})}return{init:a,loadScripts:b}}(),init=function(){async.eachSeries(config.initList,function(a,b){time.start("init-"+a),window[a]&&window[a].init?window[a].init(function(){time.end("init-"+a),b()}):b()},function(){applyDefaultTheme(),initSpotData()})},applyDefaultTheme=function(){if(!config.themeId){var a=config.defaultThemeId||"space",b=_.find(config.themes,{settings:{themeId:a}});_.each(b&&b.settings,function(a,b){config[b]=a})}},initSpotData=function(){idb.getAll("SPOTS_DATA",function(a){$.isEmptyObject(a)?async.map(spotsManager.getSpotsArray(),function(a,b){idb.add("SPOTS_DATA",{id:a.id,sequence:0},function(){b(null)},!1)},function(){initUser(!0)}):initUser(!0)})},initUser=function(a,b){b=_.verifyCallback(b),config.token?0!==_.size(config.user)&&config.user.guid&&config.user.token?(pullUpdates(a),b(config.user)):spotsAPI.GET("user",null,function(c){configAPI.set("user",c),configAPI.set("token",c.token),configAPI.set("guid",c.guid),pullUpdates(a),b(config.user)},function(){a&&getReferralSource(),b(!1)}):(configAPI.remove("user"),configAPI.remove("guid"),a&&(getReferralSource(),b(!1)))},pullUpdates=function(a){spotsAPI.requestUpdate(null,function(a){spotsAPI.postQueue(function(){},function(){})},function(a){}),initPushService(a)},initPushService=function(a){pushService.init(),userTokenRenew(a)},userTokenRenew=function(a){configAPI.setDefault("token_last_renew",0);var b=config.token_valid_time/config.token_renew_attempts,c=config.token_valid_time-((new Date).getTime()-config.token_last_renew);b>c&&user.tokenRenew(),setTimeout(function(){user.tokenRenew(),userTokenRenew()},b),a&&getReferralSource()},getReferralSource=function(){config.referredBy||chrome.tabs.query({url:"<all_urls>"},function(a){var b=_.find(a,function(a){return a.url&&"spots"==urls.urlParameter(a.url.toLowerCase(),"p")&&urls.urlParameter(a.url.toLowerCase(),"r")});b?(b=urls.urlParameter(b.url.toLowerCase(),"r"),configAPI.set("referredBy",b)):(b="none",configAPI.set("referredBy",b)),_gaq.push(["_trackEvent","New User","Referral",b,1])}),getInstallationDate()},getInstallationDate=function(){config.installationDate?loadSpotsBackgroundScripts():utilsAPI.getCurrentTimeStamp(function(a){a&&configAPI.set("installationDate",a),loadSpotsBackgroundScripts()})},loadSpotsBackgroundScripts=function(){window.apps_grabber=function(){function a(){return idb.getAll("HIDDEN_APPS",function(a){_.each(a,function(a){l.push(a)})}),k.push("play.google.com"),idb.getAll("DOMAIN_BLACK_LIST",function(a){_.each(a,function(a){k.push(a)})}),$.Deferred().resolve().promise()}function b(a,b){b=_.verifyCallback(b);var c=[],e=d(a);_.each(l,function(a){a.appDomain==e&&c.push(a.id)}),b(c)}function c(a,b,c){c=_.verifyCallback(c);var e=d(b),f={appDomain:e,id:a,timestamp:(new Date).getTime()};idb.add("HIDDEN_APPS",f,function(){l.push(f),c()})}function d(a){return a.replace(m,"").replace(n,"");
}function e(a,b){b=_.verifyCallback(b);var c="http://en.api.hoolapp.com/query.php?type=apps&items=%s&items_key=2".replace(/\%s/,a.join(","));$.getJSON(c,function(c){f(c,b),g(a,c)})}function f(a,b){idb.getAll("185ecf76-f51f-4477-82eb-4c3e0dc65b94",function(c){var d=c,e=[];_.each(a,function(a){0!==Number(a.price)||_.findWhere(d,{"package":a.id})||e.push({id:a.id,name:a.name,description:utilsAPI.stripHtml(a.description),rating:a.rating,image:a.icon+"=w50",price:a.price,developer:a.developer,updatedDate:a.updatedDate,categories:a.category})}),b(e)})}function g(a,b){var c=[];_.each(a,function(a){_.findWhere(b,{id:a})||c.push(a)});var d="http://api.hoolapp.com/command.php?type=addapp&items="+c.join(",");$.getJSON(d,function(a){})}function h(a,b){b=_.verifyCallback(b);var c=[],d=/(?:market\.android\.com\/details|play\.google\.com\/store\/apps\/details|\/store\/apps\/details)\?id\=(.+?)(?:\&|$)/;_.each(a,function(a){var b=d.exec(a);b&&-1===c.indexOf(b[1])&&c.push(b[1])}),b(c)}function i(a,b){b=_.verifyCallback(b);var c=d(a),e=!1,f=a.replace(m,"");_.each(k,function(a){(a==c||a==f)&&(e=!0)}),b(e)}function j(a,b,c){c=_.verifyCallback(c);var d;d=b?a.replace(m,"").replace(n,""):a.replace(m,""),idb.add("DOMAIN_BLACK_LIST",{id:d},function(){k.push(d),c()})}var k=[],l=[],m=new RegExp("http(s)?://(www.)?"),n=new RegExp("[/|?|#](.*)");return{init:a,addAppToHiddenAps:c,getAppDetails:e,getHiddenApps:b,findAppsInLinks:h,isOnBlackList:i,addToBlackList:j}}(),window.apps=function(){"use strict";function a(){return c(),$.Deferred().resolve().promise()}function b(a){var b=_.filter(a,function(a){return a.spot_id==i&&(a.snapshot||a.sequences.length>0)});if(b.length>0){var e=[],f=[];_.each(a,function(a){a.sequences?_.each(a.sequences,function(a){_.each(a.sequence_data,function(a){if("add"==a.type){var b=a.object_data["package"];j[b]=a.object_data,e.push(b)}else if("delete"==a.type){var c=_.findWhere(j,{id:a.object_id});c&&f.push(c["package"])}})}):a.snapshot&&c()}),e.length>0&&d(e.join()),f.length>0&&eventManager.dispatchEvent(i,"APPS_EVENT",{type:"delete",apps:f})}}function c(){j={},idb.getAll(i,function(a){var b=[];_.each(a,function(a){var c=a["package"];j[c]=a,a.details?configAPI.set("apps_spot_used",!0):b.push(c)}),b.length>0&&d(b.join())})}function d(a){var b=[];$.getJSON(configAPI.get("url_hoolapp"),{type:"apps",items_key:2,output_key:2,items:a},function(a){_.each(a,function(a,c){var d=j[c];d&&(d.details=a,g(d)&&(b.push(d),idb.update(i,d,null,!1)))}),b.length>0&&(configAPI.set("apps_spot_used",!0),eventManager.dispatchEvent(i,"APPS_EVENT",{type:"add",apps:b}))})}function e(a,b){idb.get(i,a,function(a){b(a)})}function f(a){idb.getAll(i,function(b){a(b)})}function g(a){return void 0!==a.details&&void 0!==a.details.icon&&void 0!==a.details.title}function h(a){var b=_.filter(j,function(a){return g(a)});a(b)}var i=spotsManager.spotID("apps"),j={};return eventManager.addEventListener(i,"UPDATE_EVENT",b),{init:a,getObject:function(a,b){e(a,b)},getAllObjects:function(a){f(a)},getAllObjectsArray:function(a){f(function(b){a(_.toArray(b))})},getApps:function(a){h(a)}}}(),window.discovery=function(){"use strict";function a(){return $.Deferred().resolve().promise()}function b(a){return _.find(j.providers,{name:a})}function c(a){var c=[],d=[],e={};_.each(j.providers,function(f){var i=b(f.name),k=_.groupBy(a[f.name],function(a){return a.provider=f.name,g[a.id]||h[a.source]?"blacklisted":a.paid?"paid":"unpaid"});k.blacklisted;var l=_.first(k.paid,i.maxPaidItems),m=Math.round(i.percentage*j.maxItems)-l.length;c=c.concat(l),d=d.concat(_.first(k.unpaid,m)),e[f.name]=_.rest(k.unpaid,m)});var f=_.first(c,j.maxPaidItems).concat(d);return f.length<j.maxItems&&_.each(j.providers,function(a){f=f.concat(e[a.name])}),_.first(f,j.maxItems)}function d(){var a=$.Deferred();if(!k())return a.reject().promise();var d=_.map(f,function(a){var c=b(a.name);return a.getFeed(c)});return $.when.apply($,d).done(function(){var b=_.keys(f),d=_.object(b,arguments),e=c(d);_.isEmpty(e)?a.reject():a.resolve(e)}),a.promise()}function e(a,b,c){switch(a){case"more":b.id in i?(delete i[b.id],a="more-less"):i[b.id]=b,configAPI.set("discoveryMoreLikeThisItems",i);break;case"less":g[b.id]=!0,configAPI.set("discoveryBlacklistedIDs",g);break;case"hide":h[b.source]=!0,configAPI.set("discoveryBlacklistedSources",h);break;case"report":}var d=f[b.provider];d&&_.isFunction(d.feedback)&&d.feedback(a,b,c)}var f={},g=configAPI.get("discoveryBlacklistedIDs")||{},h=configAPI.get("discoveryBlacklistedSources")||{},i=configAPI.get("discoveryMoreLikeThisItems")||{},j=config.discoveryOptions,k=function(){var a=_.pluck(j.providers,"name"),b=_.pluck(f,"name");return 0===_.difference(a,b).length};return{init:a,feedback:e,getFeed:_.whenOnline(function(a){d().then(a)}),addProvider:function(a){a&&a.name&&(f[a.name]=a)},moreLikeThisItems:i}}(),window.facebook_feed=function(){function a(){return $.Deferred().resolve().promise()}configAPI.get("facebookProviderBlacklistedSources")||[];return{init:a}}(),window.outbrain_feed=function(){function a(){return $.Deferred().resolve().promise()}function b(a){var b=a.source_display_name||a.source_name,c=!!a.pc_id;return{id:"ob_"+a.orig_url,paid:c,url:a.url,originalUrl:a.orig_url,source:d(b)?$(b).filter(".ob_displayed_source, .ob_site_name").text():b,title:$("<textarea/>").html(a.content).text(),thumbnail:a.thumbnail&&a.thumbnail.url,analyticsLabel:"Outbrain-"+(c?"Paid":"Organic"),originalItem:a}}function c(a){return $.ajax({url:config.outbrainAPI,data:{appId:config.outbrainAppId,numOfDocs:config.outbrainMaxResults,imageSize:config.outbrainThumbnailSize}}).then(function(a){var c=a.data&&a.data.documents&&a.data.documents.doc;return c=_.filter(c,function(a){return null!==a.thumbnail}),a.success?_.map(c,b):[]})}var d=function(){var a=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/;return function(b){return a.test(b)}}();({actionOrigin:"SPOTS",odbRequest:config.outbrainAppId,refererDocumentUrl:"http://spotsmagic.com/outbrain",category:0,afterClick:!1,actionText:"",scope:""});return discovery.addProvider({name:"outbrain",feedback:null,getFeed:function(a){return $.Deferred(function(b){c(a).done(b.resolve).fail(function(){b.resolve([])})})}}),{init:a}}(),window.facebook=function(){"use strict";function a(){return b(),eventManager.addEventListener("CONFIG","USER_LOGIN_SUCCESS",b),eventManager.addEventListener("CONFIG","USER_LOGOUT_SUCCESS",function(){configAPI.set("fbAccessToken",null)}),config.installationDate&&modalManager.add({type:"facebookRateUsModal",path:"/app/spots/facebook/newtab/partials/modals/FacebookRateUsModal.html",title:null,priority:5,once:!0,logicHandler:function(a){var b=user.isOrganic()?2*ONE_DAY:ONE_WEEK;a(Date.now()-Number(utilsAPI.decrypt(config.installationDate))>b)},modalHandlers:null}),$.Deferred().resolve().promise()}function b(){config.fbAccessToken&&(g(3),c())}function c(){setInterval(function(){idb.getAll(m,function(a){_.each(a,function(a){a.expirationDate<(new Date).getTime()&&idb.remove(m,a.id,function(){},!1)})})},3*ONE_HOUR)}function d(){f(e);var a=new Date((new Date).setDate((new Date).getDate()+1)),b=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0)-new Date;setTimeout(function(){d()},b)}function e(a){_.each(a,function(a){idb.search(m,function(b){return b.id==a.uid},function(b){if(0===b.length){var c={id:a.uid,name:a.name,Date:new Date(a.birthday_date).getTime(),expirationDate:new Date((new Date).setDate(new Date(a.birthday_date).getDate()+1)).setHours(0,0,0,0),image:a.pic_square,firstName:a.first_name};idb.add(m,c,function(a){notificationManager.set({spotID:m,type:"Facebook-Birthday",objectID:c.id,expiration:c.expirationDate,priority:2,newtab:!0,opentab:!0,toast:!1},null)},!1)}})})}function f(a){a=_.verifyCallback(a);var b="SELECT uid,name,pic_square,birthday_date,first_name FROM user WHERE(substr(birthday_date, 0, 2)="+((new Date).getMonth()+1)+")AND(substr(birthday_date, 3, 2)="+(new Date).getDate()+")AND uid IN(SELECT uid2 FROM friend WHERE uid1= me()) order by name",c=n+"fql?q="+b+"&access_token="+config.fbAccessToken;jQuery.ajax({url:c,dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(b){a(b.data)}})}function g(a){h(a,i),setInterval(function(){h(a,i)},3*ONE_HOUR)}function h(a,b){b=_.verifyCallback(b);var c=new Date,d=new Date((new Date).setDate((new Date).getDate()+a)),e=j(c),f=j(d),g="SELECT name,eid, pic_small,venue, location, start_time FROM event WHERE eid IN (SELECT eid FROM event_member WHERE uid =  me()) AND start_time >='"+e+"' AND start_time <='"+f+"'",h=n+"fql?q="+g+"&access_token="+config.fbAccessToken;jQuery.ajax({url:h,dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(a){b(a.data)}})}function i(a){_.each(a,function(a){idb.search(m,function(b){return b.id==a.eid},function(b){if(0===b.length){var c={id:a.eid,name:a.name,Date:new Date(a.start_time).getTime(),location:a.location,expirationDate:(new Date).setDate(new Date(a.start_time).getDate()),image:a.pic_small};idb.add(m,c,function(a){notificationManager.set({spotID:m,type:"Facebook-Event",objectID:c.id,expiration:c.expirationDate,priority:2,newtab:!0,opentab:!0,toast:!1},null)},!1)}})})}function j(a){Math.abs(a.getTimezoneOffset()/60).toString();return a.getUTCFullYear()+"-"+l(a.getUTCMonth()+1)+"-"+l(a.getUTCDate())+"T"+l(a.getUTCHours())+":"+l(a.getUTCMinutes())+":"+l(a.getUTCSeconds())+encodeURIComponent(k(a))}function k(a){var b=a.getTimezoneOffset()>0?"-":"+",c=Math.abs(a.getTimezoneOffset()),d=l(Math.floor(c/60)),e=l(c%60);return b+d+e}function l(a){return 10>a?"0"+a:a}var m=spotsManager.spotID("facebook"),n="https://graph.facebook.com/";return{init:a,getTodaysBirthdays:f,setBirthdaysNotifications:d,getUpcomingEvents:h,clearExpiredItems:c}}(),window.bookmarks=function(){"use strict";function a(){return $.Deferred().resolve().promise()}function b(a,b,c){c({query:a,spotID:spotsManager.spotID("favorites"),type:"bookmarks",priority:200,results:b})}function c(a,c,d){d=_.verifyCallback(d),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"bookmarks")?chrome.bookmarks.search(a,function(e){e=_.first(e,c),b(a,e,d)}):b(a,[],d)}return{init:a,search:c}}(),window.chromeapps=function(){"use strict";function a(){return $.Deferred().resolve().promise()}function b(a){_.size(f)>0?a(f):chrome.management.getAll(function(b){f=[],_.each(b,function(a){a.enabled&&a.isApp&&(_.size(a.icons)>0&&(a.icon=a.icons[a.icons.length-1].url),f.push(a))}),a(f)})}function c(a,b,c){c({query:a,spotID:spotsManager.spotID("favorites"),type:"chrome-apps",priority:400,results:b})}function d(a,d,e){e=_.verifyCallback(e),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"chrome-apps")?b(function(b){var f=window.search.buildSearchRegex(a),g=_.filter(b,function(a){return f.test(a.name)||f.test(a.shortName)});g=_.first(g,d);var h=g.map(function(a){return graphicAssets.toDataURL(a.icon).then(function(b){return a.icon=b,a})});$.when.apply($,h).done(function(){c(a,g,e)})}):c(a,[],e)}function e(a){webappsUtils.launch(a)}var f;_.memoize(function(a){return $.Deferred(function(b){if("string"==typeof a)if(0===a.indexOf("data"))b.resolve(a);else{var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==this.readyState&&200==this.status&&0===this.response.type.indexOf("image/")){var a=new FileReader;a.onload=function(a){b.resolve(a.target.result)},a.readAsDataURL(this.response)}},c.open("GET",a),c.responseType="blob",c.send()}else b.resolve("data:image/png;base64,")})});return{init:a,getChromeApps:b,search:d,launchApp:e}}(),window.favorites=function(){"use strict";function a(){return idb.getAll(v,function(a){a.DIRECTORY?(x=!0,u=a,w.resolve(u),eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"UPDATE",data:u},null),p()):c(function(a){u=a,w.resolve(u),eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"UPDATE",data:u},null)})}),w.then(function(a){_.each(a,function(a){b(a,!0)})}),w.promise()}function b(a,b){function c(b){b=_.unpick(b,"title","color","url"),_.isEmpty(b)||eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"ITEM_UPDATED",data:_.extend(a,b)},null)}a&&a.url&&webScrapper.scrape(a.url,b).progress(c).done(c)}function c(a){gallery.getGallery(function(b){var c=b.presets[config.brand]||b.presets["default"],d={DIRECTORY:{id:"DIRECTORY",directory:c}};_.each(c,function(a){_.map(a.items,function(a){var c=b.items[a];c&&(d[a]=gallery.toFavoriteItem(a,c))})}),a(d)})}function d(a){$.when(u||w).then(a)}function e(a,b){_.isObject(a)||(a={id:a}),d(function(c){var d=a.id?c[a.id]:_.find(c,function(b){return b.url==a.url||b.meta&&b.meta.redirectUrl==a.url});b(d||null)})}function f(a,b,c){c({query:a,spotID:v,type:"favorites",priority:800,results:b})}function g(a,b,c){if(c=_.verifyCallback(c),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"favorites")){var d=_.clone(u);delete d.DIRECTORY;var e=window.search.buildSearchRegex(a),g=_.filter(d,function(a){return e.test(a.title)||e.test(a.url)});g=_.first(g,b),f(a,g,c)}else f(a,[],c)}function h(a){switch($.type(a)){case"number":return a;case"string":return _.findIndex(u.DIRECTORY.directory,{id:a});case"object":return _.findIndex(u.DIRECTORY.directory,{id:a.id});default:return-1}}function i(a,c,e){e=_.verifyCallback(e),a=_.clone(a),a?d(function(){var d=h(c);-1===d&&(d=0),y().then(function(){idb.add(v,a,function(c){var f=u.DIRECTORY.directory[d];a.id||(a.id=c),u[c]=a,f&&f.items&&f.items.push(c),q(function(){b(a),eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"ITEM_ADDED",data:a},null),e(a)})},!0)})}):e(!1)}function j(a,b){b=_.verifyCallback(b),a?d(function(){y().then(function(){idb.update(v,_.pick(a,"id","title","url","color","icon","iconSize","userIcon"),function(){u[a.id]=a,eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"ITEM_UPDATED",data:a},null),b(a)},!0)})}):b(!1)}function k(a,b){b=_.verifyCallback(b),a=_.clone(a),a?d(function(){var c=_.isObject(a)?a.id:a;if(u[c]&&_.isString(u[c].userIcon)){var d=u[c].userIcon.replace(/^.*[\\\/]/,"");S3.deleteFile("icons",d,null)}y().then(function(){idb.remove(v,c,function(){delete u[c],_.map(u.DIRECTORY.directory,function(a){return a.items=_.without(a.items,c),a}),q(function(){eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"ITEM_REMOVED",data:c},null),b()})},!0)})}):b(!1)}function l(a,b){var c=_.isObject(a)?a:{id:getUUID(),name:a,items:[]};b=_.verifyCallback(b),d(function(){u.DIRECTORY.directory.push(c),y().then(function(){q(b)})})}function m(a,b){b=_.verifyCallback(b),!a||_.isUndefined(a.id)?b(!1):d(function(){var c=h(a);-1===c?b(!1):(u.DIRECTORY.directory[c]=_.clone(a),y().then(function(){q(b)}))})}function n(a,b){b=_.verifyCallback(b),d(function(){var c=h(a),d=u.DIRECTORY.directory[c],e=d&&d.items||[];u.DIRECTORY.directory.splice(c,1),async.map(e,function(a,b){idb.remove(v,a,function(){delete u[a],b(null)},!0)},function(){y().then(function(){q(b)})})})}function o(a,b){b=_.verifyCallback(b);var c=urls.getHostName(a,!0);A[c]?(A[c].requestedUrl=a,b(A[c])):(A[c]={item:{url:a},requestedUrl:a,prettyUrl:c,palette:[],gallery:null},gallery.searchByDomain(c,function(a){a?(A[c].item.gallery_id=a.id,A[c].item.title=a.title,A[c].item.icon=a.assets.icon||null,A[c].item.color=a.assets.color,A[c].gallery=a,A[c].palette=a.assets.palette,A[c].palette.unshift(a.assets.color),b(A[c])):graphicAssets.webColorPicker(c,function(a){a&&a.r&&(A[c].item.color=a.c,A[c].palette=a.p,A[c].palette.unshift(a.c)),urls.getTitleByUrl(c,function(a){a&&(A[c].item.title=a),A[c].item.color&&"#ffffff"==A[c].item.color.toLowerCase()&&(A[c].item.color="#efefef"),b(A[c])})})}))}function p(){idb.getAll(v,function(a){if(a){var b=0;_.each(a.DIRECTORY.directory,function(c){c.items=_.filter(c.items,function(c){return _.isUndefined(a[c])?(b++,!1):!0}),c.id||(c.id=getUUID(),b++)}),b>0&&idb.update(v,a.DIRECTORY,function(){u=a,eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"DIRECTORY_UPDATE",data:a.DIRECTORY.directory},null)},!0)}})}function q(a){a=_.verifyCallback(a),u.DIRECTORY={id:"DIRECTORY",ts:Date.now(),directory:u.DIRECTORY.directory},spotsAPI.getSequence(v,function(b){var c={type:"DIRECTORY_UPDATE",data:u.DIRECTORY.directory};0===b?idb.add(v,u.DIRECTORY,function(){eventManager.dispatchEvent(v,"FAVORITES_EVENT",c,null),a()},!0):idb.update(v,u.DIRECTORY,function(){eventManager.dispatchEvent(v,"FAVORITES_EVENT",c,null),a()},!0)},null)}function r(a){a=_.verifyCallback(a),d(function(){var b=_.map(u.DIRECTORY.directory,function(a){return{name:a.name,id:a.id}});a(b)})}function s(a,b,c){var d=0,e=0;_.each(u.DIRECTORY.directory,function(c,f){-1!=c.items.indexOf(a)&&(d=f),b==c.id&&(e=f)}),u.DIRECTORY.directory[d].id!==b&&(u.DIRECTORY.directory[d].items=_.reject(u.DIRECTORY.directory[d].items,function(b){return b==a}),u.DIRECTORY.directory[e].items.push(a),q(c))}function t(a){d(function(){var b=_.find(u.DIRECTORY.directory,{id:"recommended"}),c=_.map(b&&b.items,function(a){return u[a]});a(c)})}var u,v=spotsManager.spotID("favorites"),w=$.Deferred(),x=!1,y=function(){return $.when(x||z())},z=function(){var a=$.Deferred();return x=!0,async.map(_.toArray(u),function(a,b){idb.add(v,a,b,!0)},function(){a.resolve()}),a.promise()},A={};return eventManager.addEventListener(v,"UPDATE_EVENT",a),{init:a,addItem:i,editItem:j,removeItem:k,enrichItem:b,addCategory:l,editCategory:m,removeCategory:n,directorySave:q,getItem:e,getFavorites:d,search:g,getDetailsForUrl:o,getCategories:r,getRecommended:t,changeItemCategory:s}}(),window.recent_sites=function(){"use strict";function a(){var a=$.Deferred();return a.resolve(),a.promise()}function b(a,b){b=_.verifyCallback(b),tabs.getRecentlyClosed(function(c){b(_.first(c,a))})}return{init:a,getItems:b}}(),window.topsites=function(){"use strict";function a(){var a=$.Deferred();return a.resolve(),a.promise()}function b(a,b){(!a||_.isFunction(a))&&(b=a,a=Number(config.topSitesItems)||20),b=_.verifyCallback(b),f().then(function(c){var d=_.pluck(c,"url").filter(function(a){return!e.test(a)});webScrapper.scrapeAll(d).progress(function(){var c=_.compact(arguments);b(_.first(c,a))})})}function c(a,b,c){c({query:a,spotID:spotsManager.spotID("favorites"),type:"top-sites",priority:600,results:b})}function d(a,d,e){e=_.verifyCallback(e),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"top-sites")?b(function(b){var f=window.search.buildSearchRegex(a),g=_.filter(b,function(a){return f.test(a.title)||f.test(a.url)});g=_.first(g,d),c(a,g,e)}):c(a,[],e)}var e=/^ftp|https?:\/\/localhost/i,f=_.cacheFor(10*ONE_MINUTE,function(){return $.Deferred(function(a){chrome.topSites.get(a.resolve)}).promise()});return{init:a,getTopSites:b,search:d}}(),window.gallery=function(){function a(){return idb.getAll(spotsManager.spotID("gallery"),function(a){_.isEmpty(a)?b(config.gallery_local_data_path).then(function(a){m(!0),l.resolve(k)},function(){m(!0),l.reject()}):(_.each(a,function(a){k[a.id]=a.value}),m(!1),l.resolve(k))}),l.promise()}function b(a){return c(a).then(d)}function c(a){return $.get(a).then(function(a){try{a=utilsAPI.decrypt(a)}catch(b){}try{a=JSON.parse(a)}catch(b){return $.Deferred().reject(b).promise()}return a})}function d(a){var b=$.Deferred();if(!e(a))return b.reject("Outdated gallery structure");var c=a&&a.version>(k.version||0);if(!c)return b.resolve(k);idb.clear(spotsManager.spotID("gallery")),k={};var d=_.map(a,function(a,b){return k[b]=a,{type:"put",value:{id:b,value:a}}});return idb.batch(spotsManager.spotID("gallery"),d,function(){b.resolve(k)},function(a){b.reject(a)}),h(a),b.promise()}function e(a){var b=a&&a.items&&a.items.google&&a.items.google.links&&a.items.google.links["default"];return"google.com"===b}function f(a,b){return{id:a,gallery_id:a,title:b.title,url:b.links[config.brand]||b.links["default"],icon:b.assets.icon||null,iconSize:b.assets.iconSize||config.favoritesIconSize,color:b.assets.color}}function g(a,b){if(a.timestamp<config.last_gallery_update)return b();switch(a.type){case"add_favorite":j(function(c){var d=c.items[a.data.id];if(!d)return b();var e=f(a.data.id,d),g=a.data.category;delete a.data.category,e=_.extend(e,a.data),favorites.getFavorites(function(c){var d=_.findWhere(c,{id:a.data.id});d&&(e=_.extend(_.cloneDeep(d),e)),favorites.addItem(e,g,function(){b()})})});break;case"edit_favorite":favorites.getItem(a.data,function(c){return c?(c=_.extend({},c,a.data),void favorites.editItem(c,function(){b()})):b()});break;case"remove_favorite":favorites.removeItem(a.data,function(){b()});break;case"add_category":favorites.getFavorites(function(c){var d=_.findWhere(c.DIRECTORY&&c.DIRECTORY.directory,{id:a.data.id});d||j(function(d){var e=[];_.each(a.data.items,function(a){var b=d.items[a];!c[a]&&b&&e.push(f(a,b))}),a.data.items=[],favorites.addCategory(a.data,function(){var c=_.after(e.length,function(){b()});e.length?e.forEach(function(b){favorites.addItem(b,a.data.id,c)}):c()})})});break;case"edit_category":favorites.getFavorites(function(c){var d=_.findWhere(c.DIRECTORY&&c.DIRECTORY.directory,{id:a.data.id});d&&g({type:"remove_category",data:a.data},function(){g({type:"add_category",data:a.data},function(){b()})})});break;case"remove_category":favorites.removeCategory(a.data.id,function(){b()});break;default:b()}}function h(a){_.isArray(a&&a.actions)&&idb.getAll(spotsManager.spotID("favorites"),function(b){_.isEmpty(b)||async.eachSeries(a.actions,g,function(){configAPI.set("last_gallery_update",Date.now())})})}function i(a,b){a=urls.getHostName(a,!0),j(function(){var c=_.find(k.items,function(b,c){var d=!1;return _.each(b.matches,function(b){var c=new RegExp(b);c.test(a)&&(d=!0)}),d});b(c)})}function j(a){l.promise().then(function(){try{_.verifyCallback(a)(k)}catch(b){}})}var k={},l=$.Deferred(),m=_.whenOnline(function(a){b(config.gallery_remote_data_path+config.cb).then(function(a){configAPI.set("gallery_last_update",(new Date).getTime()),setTimeout(m,config.gallery_autopull_interval)},function(){setTimeout(function(){m()},config.gallery_retry_interval)})});return{updateRepository:m,discoveryItemsArray:function(){var a=[];return _.each(k.items,function(b,c){b.assets&&b.assets.icon&&b.description&&(b.id=c,a.push(b))}),a},searchByDomain:i,updateFavItemByDomain:function(a,b){i(a,function(a){a?(b.gallery_id=a.id,b.title=a.title,a.assets&&(b.color=a.assets.color?a.assets.color:"#ffffff",a.assets.logo&&(b.icon=a.assets.logo))):delete b.icon})},getFavItemColorPalette:function(a,b){i(a,function(a){b(a.assets.palette)})},init:a,getGallery:j,toFavoriteItem:f}}(),window.gameo=function(){function a(a){$.Deferred();return b(function(){setInterval(function(){b()},config.updateFeedInterval)}),$.Deferred().resolve().promise()}function b(a){a=_.verifyCallback(a),c(config.gameoApiAdress+config.promotedGamesQuery).then(function(b){c(config.gameoApiAdress+config.recommendedGamesQuery).then(function(c){g=_.uniq(_.union(b,c),function(a){return a.id}),_.verifyCallback(a)})})}function c(a){var b=$.Deferred();return $.ajax(a,{dataType:"text",type:"GET",success:function(a){try{var c=JSON.parse(a);b.resolve(c)}catch(d){b.reject(d)}},error:function(a){b.reject(a)}}),b.promise()}function d(){return g}function e(a,b,c){if(c=_.verifyCallback(c),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"gameo")){var d=_.clone(g),e=window.search.buildSearchRegex(a),h=_.filter(d,function(a){return e.test(a.title)});h=_.first(h,b),f(a,h,c)}else f(a,[],c)}function f(a,b,c){c({query:a,spotID:h,type:"gameo",priority:800,results:b})}var g=[],h=spotsManager.spotID("gameo");return{init:a,getGamesFeed:d,search:e}}(),window.mobile_apps_feed=function(){function a(){var a=$.Deferred();return mobileApps.addProvider({name:"mobileApps",getFeed:function(a){return $.Deferred(function(b){f(a).done(b.resolve).fail(function(){b.resolve([])})})}}),playLight.getPlayAccount().then(function(b){j=b,configAPI.set("mobileAppsDiscoveryAvailable",!0),a.resolve()},function(){configAPI.set("mobileAppsDiscoveryAvailable",!1),a.resolve()}),a.promise()}function b(a,b){var c=_.format(a,b);$.get(c),analytics.reportEvent("Mobile Apps","Report",c,1)}function c(a){var c=_.find(a.creatives,{type:"banner"})||_.find(a.creatives,{type:"coverImg"}),d=_.find(a.creatives,{type:"icon"}),e=i+"?id="+a.packageName+"&rdid="+a.packageName;return{id:"ma_"+a.offer_id,paid:!0,url:e,originalUrl:null,source:"",title:a.title,price:"FREE",rating:Number(a.rating)||4,description:a.description,thumbnail:c&&c.url,icon:d&&d.url,onClick:function(){a.rurl&&b(a.rurl,{appid:a.packageName,clickid:window.getUUID(),sha1_el:PPbnlErCVt.XnsglwwSjV(j).toString(),campaignid:config.brand}),analytics.reportEvent("Mobile Apps","Click",a.packageName,1)},originalItem:a}}function d(a){var b;try{b=utilsAPI.decrypt(a)}catch(c){return a}return b}function e(a){var b;try{b=JSON.parse(a)}catch(c){return a}return b}function f(a){return $.ajax({url:h,cache:!1}).then(d).then(e).then(function(a){return _.map(a,c).filter(g)})}function g(a){return!!a.thumbnail}var h=config.mobileAppsFeed,i="https://play.google.com/store/apps/details",j=null;return{init:a}}(),window.mobileApps=window.mobile_apps=function(){"use strict";function a(){return config.favoritesExtraSections=_.extend(config.favoritesExtraSections||{},{mobile_apps:{report:"MA",label:"mobile_apps",partial:"/app/spots/mobile-apps/newtab/partials/NewtabMobileApps.html"}}),$.Deferred().resolve().promise()}function b(a){var b=_.find(h.providers,{name:a});return b.maxItems=Math.round(b.percentage*h.maxItems),b}function c(a){var c=[];return _.chain(h.providers).map(function(d){var e=a[d.name];_.each(e,function(a){a.provider=d.name});var f=b(d.name),g=f.maxItems-e.length;return c.push.apply(c,e.splice(g)),e}).flatten().tap(function(a){var b=_.first(c,h.maxItems-a.length);a.push.apply(a,b)}).value()}function d(){var a=$.Deferred();return j.done(function(d){var e=_.pick(g,d),f=_.map(e,function(a){var c=b(a.name);return a.getFeed(c)});$.when.apply($,f).done(function(){var b=c(_.object(d,_.toArray(arguments)));_.isEmpty(b)?a.reject():a.resolve(b)})}),a.promise()}function e(a){return f?f.then(a).done(k):d().then(function(){return f=this}).then(a).done(k)}var f=null,g={},h={maxItems:30,providers:[{name:"mobileApps",percentage:.5}]},i=_.whenOnline(function(){d().then(function(){f=this},function(){})}),j=$.Deferred(function(a){var b=_.pluck(h.providers,"name"),c=_.clone(b);a.progress(function(d){c=_.without(c,d),_.isEmpty(c)&&a.resolve(b)})}),k=_.cacheFor(12e5,i);return{init:a,getFeed:e,addProvider:function(a){a&&a.name&&(g[a.name]=a,j.notify(a.name))}}}(),window.call_log=function(){"use strict";function a(){var a=$.Deferred();return idb.getAll(k,function(a){d(a),eventManager.dispatchEvent(k,"CACHE_UPDATE")}),b(),a.resolve(),a.promise()}function b(){magicAPI.getLastUpdateTimestamp(k,function(a){magicAPI.getItems(l,function(b){c(a,b)})})}function c(a,b){var c=0;idb.search(k,function(b){return b.from&&b.timestamp>a},function(a){if(a.length>0){var d=[];_.each(a,function(a){var e=a.number,f=_.find(d,function(a){return magicAPI.getObjectKey(l,e)==a.id});f||(f=_.find(b,function(a){return magicAPI.getObjectKey(l,e)==a.id})),f?f.score++:f=magicAPI.createMagicItem(l,e,1),d.push(f),a.timestamp>c&&(c=a.timestamp)}),magicAPI.setItems(l,d),magicAPI.setLastUpdateTimestamp(k,parseInt(c,10))}})}function d(a){a=_.sortBy(a,function(a){return a.timestamp}),j=[];var b;_.each(a,function(a){b&&b.number==a.number||(b=a,b.calls=[],j.push(b)),b.calls.push({type:a.type,timestamp:a.timestamp})})}function e(a,b,c){if(j){var d=j.length;if(a){d=-1;for(var f=j.length-1;f>=0;f--)if(j[f].timestamp==a.timestamp){d=f;break}0>=d&&c([])}var g=d-b>0?d-b:0;c(j.slice(g,d))}else setTimeout(function(){e(a,b,c)},100)}function f(a){if(j&&a){for(var b,c=j.length-1;c>=0;c--)if(j[c].timestamp==a.timestamp){b=c+1;break}var d=[];if(b&&b<j.length){var e=j.length;d=j.slice(b,e)}return b>0&&a.calls.length<j[b-1].calls.length&&d.unshift(j[b-1]),d}return[]}function g(a){idb.getAll(k,function(b){a(b)})}function h(a,b){idb.get(k,a,function(a){b(a)})}function i(a){notificationManager.getAll({spotID:k},function(b){b&&_.each(b,function(b){b.data&&b.data.number==a&&notificationManager.clear(b.id,null)})})}var j,k=spotsManager.spotID("call_log"),l=spotsManager.spotID("contacts");return eventManager.addEventListener(k,"UPDATE_EVENT",function(b){a()}),{init:a,getObject:h,getAllObjects:g,getAllObjectsArray:function(a){g(function(b){a(_.toArray(b))})},getPreviousCalls:e,getNewCalls:f,clearNotificationsForNumber:i}}(),window.contacts=function(){"use strict";function a(){var a=$.Deferred();return idb.getAll(o,function(b){_.each(b,function(a){_.each(a.phones,function(b){p[b]=a})}),eventManager.dispatchEvent(o,"CACHE_UPDATE",null),a.resolve()}),a.promise()}function b(a){if(p[a])return p[a];var b=a.toString().replace(/\D/g,"");if(b=parseInt(b,10),b.length>=5){var c=_.keys(p),d=_.find(c,function(a){return-1!==a.indexOf(b)?!0:void 0});if(d){var e=p[d];return p[a]=e,e}}return null}function c(a){idb.getAll(o,function(b){a(b)})}function d(a){c(function(b){a(_.toArray(b))})}function e(a,b){idb.get(o,a,function(a){b(a)})}function f(a,b){var c=_.sortBy(a,function(a){if(a.notifications){var b=_.max(a.notifications,function(a){return a});return a.score=b,b}return"number"==typeof a.score?a.score:-1});b(c)}function g(a,b,c){magicAPI.getItems(o,function(d){_.each(a,function(a){var b=_.find(this,function(b){var c=_.find(a.phones,function(a){return b.objectID==a});return c});b?a.score=b.score:a.score=0},d),f(a,function(a){b&&(a=_.last(a,b));for(var d=0;d<a.length;d++)a[d].score=d;c(a)})})}function h(){n=null}function i(a,b){_.size(n)>=a?b(_.last(n,a)):magicAPI.getItems(o,function(c){f(c,function(c){n=_.last(c,a),b(n)})})}function j(a){return a.defaultNumber||_.find(a.phones,function(a,b){return"mobile"==b.toLowerCase()})||_.toArray(a.phones)[0]}function k(a,b,c){c({query:a,spotID:spotsManager.spotID("contacts"),type:"contacts",priority:1e3,results:b})}function l(a,b,c){if(c=_.verifyCallback(c),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"contacts")){var d=window.search.buildSearchRegex(a);idb.search(o,function(a){return d.test(a.givenName)||d.test(a.familyName)||d.test(a.display)},function(d){g(d,q,function(d){d=_.first(d,b),k(a,d,c)})})}else k(a,[],c)}function m(a){return phoneformat.formatLocal(geolocation.getCountryCode(),a)}var n,o=spotsManager.spotID("contacts"),p={},q=3;return eventManager.addEventListener(o,"UPDATE_EVENT",a),eventManager.addEventListener("MAGIC","ITEM_UPDATED",h),{init:a,getObject:e,getAllObjects:c,getAllObjectsArray:d,getContactByPhoneNumber:b,getTopMagicResults:i,getContactDefaultPhone:j,search:l,normalizePhoneNumber:_.memoize(m)}}(),window.phone_notification=function(){function a(){function a(a){a.spotID==d&&a.data&&magicAPI.clearNotification(b,a.data.number,a.id)}var f=$.Deferred();return eventManager.addEventListener("NOTIFICATIONS","NOTIFICATION_CLEARED",a),eventManager.addEventListener(c,1,function(a){(new Date).getTime()-a.timestamp>2*ONE_MINUTE||(a.contact=contacts.getContactByPhoneNumber(a.number),a.contact||(a.contact={}),a.contact.display||(a.contact.display=languageManager.getTranslation("unknown")),a.contact.image?a.contact.toastImage=a.contact.image:a.contact.toastImage="/img/default-image-grey.png",notificationManager.set({spotID:c,objectID:a.timestamp,expiration:(new Date).getTime()+ONE_MINUTE/2,priority:5,newtab:!1,opentab:!1,toast:{type:"basic",title:a.contact.display,message:languageManager.getTranslation("incoming_call"),contextMessage:a.number,iconUrl:a.contact.toastImage,eventTime:parseInt(a.timestamp,10)}},null),_gaq.push(["_trackEvent","Phone","Call-Notifications","Incoming Call"]))}),eventManager.addEventListener(c,2,function(a){notificationManager.clear(c+"_"+a.timestamp),_gaq.push(["_trackEvent","Phone","Call-Notifications","Answered Call"])}),eventManager.addEventListener(c,3,function(a){notificationManager.clear(c+"_"+a.timestamp),_gaq.push(["_trackEvent","Phone","Call-Notifications",e])}),eventManager.addEventListener(c,4,function(a){_gaq.push(["_trackEvent","Phone","Call-Notifications","Outgoing Call"])}),eventManager.addEventListener(c,"UPDATE_EVENT",function(a){
var b=_.findWhere(a,{spot_id:c}).sequences;_.each(b,function(b){var d=_.where(b.sequence_data,{type:"add"});_.each(d,function(b){a=b.object_data,a.contact=contacts.getContactByPhoneNumber(a.number),a.contact||(a.contact={}),a.contact.display||(a.contact.display=languageManager.getTranslation("unknown")),a.contact.image?a.contact.toastImage=a.contact.image:a.contact.toastImage="/img/default-image-grey.png","3"==a.type?(notificationManager.set({spotID:c,type:"Missed-Call",objectID:a.id,expiration:parseInt(a.timestamp,10)+8*ONE_HOUR,priority:5,newtab:!0,opentab:!0,toast:{type:"basic",title:a.contact.display,contextMessage:a.number,message:languageManager.getTranslation("missed_call"),iconUrl:a.contact.toastImage}},function(a){}),_gaq.push(["_trackEvent","Phone","Call","Missed"])):call_log.clearNotificationsForNumber(a.number)})})}),eventManager.addEventListener(d,"UPDATE_EVENT",function(a){var c=_.findWhere(a,{spot_id:d}).sequences;_.each(c,function(a){var c=_.where(a.sequence_data,{type:"add"});_.each(c,function(a){var c=a.object_data;"1"==c.type?(c.contact=contacts.getContactByPhoneNumber(c.number),c.contact||(c.contact={}),c.contact.display||(c.contact.display=languageManager.getTranslation("unknown")),c.contact.image?c.contact.toastImage=c.contact.image:c.contact.toastImage="/img/default-image-grey.png",notificationManager.set({spotID:d,objectID:c.id,expiration:parseInt(c.timestamp,10)+ONE_DAY,priority:4,newtab:!1,opentab:!0,toast:{type:"basic",title:c.contact.display,contextMessage:c.number,message:c.text,iconUrl:c.contact.image}},function(a){magicAPI.handleNotification(b,c.number,a)}),_gaq.push(["_trackEvent","Phone","SMS-Received","Incoming sms"])):(_gaq.push(["_trackEvent","Phone","SMS-Received","Outgoing sms"]),a.clearNotificationsForNumber(c.number))})})}),f.resolve().promise()}var b=spotsManager.spotID("contacts"),c=spotsManager.spotID("call_log"),d=spotsManager.spotID("sms"),e="Missed Call";return{init:a}}(),window.sms=function(){"use strict";function a(){var a=$.Deferred();return g(),b(),a.resolve(),a.promise()}function b(){magicAPI.getLastUpdateTimestamp(p,function(a){magicAPI.getItems(q,function(b){c(a,b)})})}function c(a,b){var c=0;idb.search(p,function(b){return b.from&&b.timestamp>a},function(a){if(a.length>0){var d=[];_.each(a,function(a){var e=a.number,f=_.find(d,function(a){return magicAPI.getObjectKey(q,e)==a.id});f||(f=_.find(b,function(a){return magicAPI.getObjectKey(q,e)==a.id})),f?f.score++:f=magicAPI.createMagicItem(q,e,1),d.push(f),a.timestamp>c&&(c=a.timestamp)}),magicAPI.setItems(q,d),magicAPI.setLastUpdateTimestamp(p,parseInt(c,10))}})}function d(a){var b=_.filter(a,function(a){return a.spot_id==p&&(a.snapshot||a.sequences.length>0)});b.length>0&&g(function(){e(a)})}function e(a){var b=[];_.each(a,function(a){_.each(a.sequences,function(a){_.each(a.sequence_data,function(a){if(a.type="add"){var c=a.object_data;b.push(c);var d=c.number;magicAPI.incrementItemScore(q,d),magicAPI.setLastUpdateTimestamp(p,c.timestamp)}})})}),eventManager.dispatchEvent(p,"SMS_EVENT",b)}function f(a){notificationManager.getAll({spotID:p},function(b){b&&_.each(b,function(b){b.data.number==a&&notificationManager.clear(b.id,null)})})}function g(a){a=_.verifyCallback(a),idb.getAll(p,function(b){var c={};_.each(b,function(a){c[a.number]?c[a.number].timestamp<a.timestamp&&(c[a.number]=a):c[a.number]=a}),o=[],_.each(c,function(a){o.push(a)}),o=_.sortBy(o,function(a){return a.timestamp}),a()})}function h(a,b,c){if(c=_.verifyCallback(c),o){var d=_.sortBy(o,function(a){return-1*a.timestamp});if(d[a]){var e=a,f=a+b+1>d.length?d.length:a+b;c(d.slice(e,f))}else c([])}else setTimeout(function(){h(lastThreadFetched,threadFetchCount,c)},100)}function i(a){return a=_.verifyCallback(a),a(o),o}function j(a,b){b=b?b:_.noop,idb.search(p,function(b){return b.number==a.number||b.from&&a.from&&b.from==a.from},b)}function k(a,b){b=b?b:_.noop,idb.search(p,function(b){return b.number==a},function(a){b(a)})}function l(a){idb.getAll(p,function(b){a(b)})}function m(a){l(function(b){a(_.toArray(b))})}function n(a,b){idb.get(p,a,function(a){b(a)})}var o,p=spotsManager.spotID("sms"),q=spotsManager.spotID("contacts");return eventManager.addEventListener(p,"UPDATE_EVENT",d),{init:a,getObject:n,getAllObjects:l,getAllObjectsArray:m,getPreviousThreads:h,getAllThreads:i,getThread:j,getThreadForNumber:k,initMagic:b,clearNotificationsForNumber:f}}(),window.reviewAPI=function(){"use strict";function a(a){a()}function b(){return Math.floor(200*Math.random())+2}function c(a){var b=new XMLHttpRequest;b.open("POST",utilsAPI.decrypt(k),!0),b.onreadystatechange=function(b){if(4===this.readyState){var c,d=this.responseText;try{c=JSON.parse(d)}catch(e){a(!1)}if(c&&c.channelHeader&&c.channelHeader.token){var f=c.channelHeader.token;a(f)}else a(!1)}},b.send()}function d(a,c,d){var e=b(),f=e-2,g='req={"appId":94,"version":"130625","hl":"en","specs":[{"type":"CommentEditor","cwsapprevision":"40","url":"0","groups":"1","id":"'+e+'","comment":"'+c+'","event":"writeAnnotation"},{"type":"RatingPicker","url":"0","groups":"1","id":"'+f+'","rating":"'+a+'","event":"writeAnnotation"}],"internedKeys":["0","1"],"internedValues":["'+utilsAPI.decrypt(j)+'","chrome_webstore"]}&token='+d;return g}function e(a,b){var c='{"appId":94,"version":"130625","hl":"en","specs":[{"type":"RatingPicker","url":"'+utilsAPI.decrypt(j)+'","groups":"chrome_webstore","id":"2","rating":"'+a+'","event":"writeAnnotation"}],"internedKeys":[],"internedValues":[]}&token='+b;return c}function f(a,b,c,e){e=_.verifyCallback(e);var f=d(a,b,c),g=new XMLHttpRequest,h=utilsAPI.decrypt(i);g.open("POST",h,!0),g.onreadystatechange=function(a){if(4===this.readyState){this.responseText;e()}},g.send(f),configAPI.set("rated",!0)}function g(a,b,c){c=_.verifyCallback(c);var d=e(a,b),f=new XMLHttpRequest,g=utilsAPI.decrypt(i);f.open("POST",g,!0),f.onreadystatechange=function(a){if(4===this.readyState){this.responseText;c()}},f.send(d)}function h(a,b,d){googlePlayUtils.isSignedIn()&&(d=_.verifyCallback(d),setTimeout(function(){c(function(e){g(a,e,function(){c(function(c){f(a,b,c,function(){d()})})})})},l))}var i="rED1ev6KCc+uAZ6jkt0atNs2JcP4gowLvpAIqCLWuDjJPHou5yO9PR1mFrn/8IKU",j="3x9xNIMYTIqL8RvxOFFSoe32brST5zUm8/OSMLzYOzgBMCklEUN0Wuug5zA+ExinLWZVzgjBoEdcxdZqSYLymx5P7f2Pwph7Dfe5sutJfSnMOdFXxzCQAzyMnHnsp1aN",k="rED1ev6KCc+uAZ6jkt0atNs2JcP4gowLvpAIqCLWuDg4PMQjVcuFfiA2CSYPMJ3D",l=5*ONE_MINUTE;return{init:a,buildRatingParams:d,fetchReviewToken:c,rate:h}}(),window.affiliatedSearch=function(){function a(){return gallery.getGallery(function(a){e=d(a.items)}),$.Deferred().resolve().promise()}function b(a,b,d){d=_.verifyCallback(d);var f=window.search.buildSearchRegex(a),g=f.test.bind(f),h=_.reduce(e,function(a,c,d){return a.length<b&&c.isMatch(g)&&a.push({type:"affiliated",label:c.title,value:gallery.toFavoriteItem(d,c)}),a},[]);c(a,h,d)}function c(a,b,c){c({query:a,spotID:spotsManager.spotID("search"),type:"affiliated",priority:800,results:b})}function d(a){var b={};return _.each(a,function(a,c){var d=config.brand in a.links;if(d){a=_.cloneDeep(a);var e=_.isArray(a.geo)&&new RegExp(a.geo.join("|"),"i"),f=e?e.test(geolocation.getCountryCode()):!0,g=_.union([a.title],a.keywords);a.isMatch=function(a){return f&&_.any(g,a)},a.url=a.links[config.brand],b[c]=a}}),b}var e={};return{init:a,search:b}}(),window.search=function(){"use strict";function a(){var a=$.Deferred();return a.resolve(),a.promise()}function b(a,b){b=_.verifyCallback(b),c[a]?_.each(c[a],function(a){b(a)}):a&&(c[a]={},_.each(d,function(d){window[d.service]&&window[d.service].search&&window[d.service].search(a,d.limit,function(d){d&&(c[a][d.spotID+"_"+d.type]=d,b(d))})}))}eventManager.addEventListener(spotsManager.spotID("search"),1,function(a){tabs.openLinkInNewTab(a.link)});var c={},d=[{service:"websearch",limit:4},{service:"favorites",limit:3},{service:"topSites",limit:3},{service:"bookmarks",limit:3},{service:"chromeapps",limit:3},{service:"contacts",limit:3},{service:"gameo",limit:3},{service:"affiliatedSearch",limit:3}],e=_.memoize(function(a){var b=new RegExp.Safe(a,"i").source;return a.length<3&&(b="^"+b),b=b.replace(/\s+/g,"\\s+"),new RegExp(b,"i")});return{init:a,search:b,buildSearchRegex:e}}(),window.websearch=function(){function a(){return $.Deferred().resolve().promise()}function b(a,b,d){if(d=_.verifyCallback(d),a.length>0){var e={label:a,score:1e4,value:config.searchProviderUrl+a,type:"web-default"},f={query:a,spotID:spotsManager.spotID("search"),type:"web-search",priority:100,results:[e]};c(a,b,function(a,b){a||(f.results=b.concat(f.results)),d(f)})}else d(null)}function c(a,b,c){g[a]?c(null,g[a]):(d(),e=$.ajax({url:f,dataType:"json",data:{client:"chrome-omni",ie:"utf-8",oe:"utf-8",hl:"en-US",q:a},success:function(d){var e=[];if(d[1].length>0){var f=d[1].reverse(),h=d[2].reverse(),i=d[4]["google:suggesttype"].reverse(),j=d[4]["google:suggestrelevance"].reverse();_.each(i,function(a,b){var c={label:f[b],score:j[b],value:config.searchProviderUrl+f[b],type:"web"};"NAVIGATION"==a?(c.type="navigation",c.value=f[b],h[b]&&(c.label=h[b])):"CALCULATOR"==a&&(c.type="calculator"),e.push(c)}),e=_.last(e,b),g[a]=e}c(null,e)},error:function(a,b,d){c(d,[])}}))}function d(){e&&(e.abort(),e=null)}var e,f="http://google.com/complete/search",g={};return{init:a,search:b}}(),window.weather=function(){function a(){return d(),eventManager.addEventListener("SETTINGS","LANGUAGE_CHANGED",d),geolocation.geolocate().then(function(){var a=/US|PR|JM|BS|GU|BZ|VI|KY|PW/.test(geolocation.getCountryCode());config.temperatureUnit||(config.temperatureUnit=a?"fahrenheit":"celsius")}),$.Deferred().resolve().promise()}function b(a,b){return $.Deferred(function(c){var d=$.ajax({url:g,data:{APPID:"ca75c2bfeca27575a5cf10682ec41d6b",lat:a,lon:b,units:"metric",lang:i[languageManager.getLang()]||"en"}});d.then(function(a){c[a.main?"resolve":"reject"](a)},c.reject)})}function c(){return config.weatherLocation?b(config.weatherLocation.lat,config.weatherLocation.lon):b(config.geolocation.latitude,config.geolocation.longitude)}function d(){j=_.cacheFor(h,c)}function e(a){return a?a(h):h}function f(a){a?configAPI.set("weatherLocation",a):configAPI.remove("weatherLocation"),d()}var g=config.weatherAPI,h=10*ONE_MINUTE,i={en:"en",ru:"ru",it:"it",es:"sp",uk:"ua",de:"de",pt:"pt",ro:"ro",pl:"pl",fi:"fi",nl:"nl",fr:"fr",bg:"bg",sv:"se",zh:"zh_cn",tr:"tr",cs:"cz",gl:"gl",vi:"vi",ar:"ar",mk:"mk",sk:"sk"},j=function(){};return config.backgroundInitialized.done(a),{init:a,setLocation:f,getRefreshInterval:e,getWeatherByLatLon:b,getWeather:function(a){return geolocation.geolocate().then(function(){return j().then(a)})}}}(),initBackgroundServices()},initBackgroundServices=function(){var a=_.flatten(_.map(spotsManager.getSpotsArray(),function(a){return _.map(a.background_scripts,function(a){return a.replace(".js","").replace("_service","").replace("module.","")})}));async.map(a,function(a,b){window[a]&&window[a].init?window[a].init().then(function(){b()}):b()},refreshExtension)},refreshExtension=function(){chromeEvents.refreshExtension(),config.backgroundInitialized.resolve(),time.end("backgroundInitialized"),_gaq.push(["_trackEvent","Background","Init-Complete"])};init();