function bootstrapSpots(){var a='<div ng-app="spotsOpentab" ng-controller="OpentabMainCtrl" ng-init="initMainCtrl()" id="spots" spellcheck="false"><div ng-include="\''+chrome.extension.getURL("")+"opentab.html'\"></div></div>";SPOTS.createWrapper(a,"#spots",function(a,b,c){function d(){$(document.body).append(a),angular.bootstrap(b,["spotsOpentab"])}cssFiles=["/css/opentab.css"];var e=_.map(cssFiles,function(a){return $.ajax(chrome.extension.getURL(a)).then(function(a){return a})});$.when.apply($,e).done(function(){var a=document.createElement("style");_.each(arguments,function(b){a.innerHTML+=b}),c.appendChild(a),d()})})}var googlePlayUtils=function(){return{isSignedIn:function(a){opentabService.post("googlePlayUtils","isSignedIn",[],a,!0)},hasDevices:function(a){opentabService.post("googlePlayUtils","hasDevices",[],a,!0)},googleLogin:function(a,b,c,d){opentabService.post("googlePlayUtils","googleLogin",[a,b,c],d,!1)},getGoogleAccountData:function(a){opentabService.post("googlePlayUtils","getGoogleAccountData",[],a,!1)},doInstall:function(a,b){opentabService.post("googlePlayUtils","doInstall",[a],b,!1)}}}(),spotsManager=function(){return{getSpots:function(a){opentabService.post("spotsManager","getSpots",null,a,!0)},getSpotsArray:function(a){opentabService.post("spotsManager","getSpotsArray",null,a,!1)},getSpotByID:function(a,b){opentabService.post("spotsManager","getSpotByID",[a],b,!1)},spotID:function(a,b){opentabService.post("spotsManager","spotID",[a],b,!0)},getSpot:function(a,b){opentabService.post("spotsManager","getSpot",[a],b,!0)}}}(),S3=function(){return{deleteFile:function(a,b,c){opentabService.post("S3","deleteFile",[a,b],c,!1)},uploadImage:function(){function a(a,b,c){opentabService.post("S3","uploadImage",[a,b],function(a){var b=c[a];_.isFunction(b)&&b.apply(null,Array.prototype.splice.call(arguments,1))},!1)}return function(b,c,d){var e=graphicAssets.isDataURL(b);if(e)a(b,c,d);else{var f=new FileReader;f.readAsDataURL(b),f.onload=function(b){a(b.target.result,c,d)}}}}(),list:function(a,b,c){opentabService.post("S3","list",[a,b],c,!1)}}}(),utilsAPI=function(){return{decrypt:function(a,b){opentabService.post("utilsAPI","decrypt",[a],b,!0)},encrypt:function(a,b){opentabService.post("utilsAPI","encrypt",[a],b,!0)},getCurrentTimeStamp:function(a){opentabService.post("utilsAPI","getCurrentTimeStamp",[],a,!1)},sendGA:function(a,b,c,d){opentabService.post("utilsAPI","sendGA",[a,b,c],d,!1)}}}(),configAPI=function(){return{getConfig:function(a){opentabService.post("configAPI","getConfig",[],a,!0)},get:function(a,b){opentabService.post("configAPI","get",[a],b,!0)},set:function(a,b,c){config[a]=b,opentabService.post("configAPI","set",[a,b],c,!0)},remove:function(a,b){delete config[a],opentabService.post("configAPI","remove",[a],b,!0)},setDefault:function(a,b,c){opentabService.post("configAPI","setDefault",[a,b],c,!0)}}}(),graphicAssets=function(){return{hexToRgb:function(a,b){opentabService.post("graphicAssets","hexToRgb",[a],b,!0)},rgbToHex:function(a,b,c,d){opentabService.post("graphicAssets","rgbToHex",[a,b,c],d,!0)},colorLuminance:function(a,b,c){opentabService.post("graphicAssets","colorLuminance",[a,b],c,!1)},contrastFilter:function(a,b,c){opentabService.post("graphicAssets","contrastFilter",[a,b],c,!1)},webColorPicker:function(a,b){opentabService.post("graphicAssets","webColorPicker",[a],b,!1)},resizeImage:function(a,b,c,d){var e=graphicAssets.isDataURL(a)?a:a instanceof Image?a.src:null;if(e)opentabService.post("graphicAssets","resizeImage",[e,b,c],d,!1);else{var f=new FileReader;f.readAsDataURL(a),f.onload=function(a){e=a.target.result,opentabService.post("graphicAssets","resizeImage",[e,b,c],d,!1)}}},isDataURL:function(a){return"string"==typeof a?0===a.indexOf("data:"):!1}}}(),notificationManager=function(){return{getAll:function(a,b){opentabService.post("notificationManager","getAll",[a],b,!1)},get:function(a,b){opentabService.post("notificationManager","get",[a],b,!1)},clear:function(a,b){opentabService.post("notificationManager","clear",[a],b,!1)},clearAll:function(a){opentabService.post("notificationManager","clearAll",[],a,!1)},getOpentabNotificationWidgets:function(a){opentabService.post("notificationManager","getOpentabNotificationWidgets",[],a,!1)},getOpentabNotificationPartials:function(a){opentabService.post("notificationManager","getOpentabNotificationPartials",[],a,!1)}}}(),languageManager=function(){return{getLang:function(a){opentabService.post("languageManager","getLang",[],a,!0)},changeLang:function(a,b){opentabService.post("languageManager","changeLang",[a],b,!1)},getLangObj:function(a){opentabService.post("languageManager","getLangObj",[],a,!0)},getDefaultLangObj:function(a){opentabService.post("languageManager","getDefaultLangObj",[],a,!0)}}}(),webappsUtils=function(){return{list:function(a){opentabService.post("webappsUtils","list",[],a,!0)},launch:function(a,b){opentabService.post("webappsUtils","launch",[a],b,!1)},uninstall:function(a,b){opentabService.post("webappsUtils","uninstall",[a],b,!1)}}}(),pushService=function(){return{sendNotification:function(a,b,c,d){opentabService.post("pushService","sendNotification",[a,b,c],d,!1)}}}(),browserUtils=function(){return{captureTab:function(a,b,c,d){opentabService.post("browserUtils","captureTab",[a,b,c],d,!1)}}}(),bi=function(){return{report:function(a,b){opentabService.post("bi","report",[a],b,!0)}}}(),opentab=function(){return{isTabBlacklisted:function(a,b,c){opentabService.post("opentab","isTabBlacklisted",[a,b],c,!0)}}}(),urls=function(){function a(a){return/^(http:\/\/|https:\/\/|ftp:\/\/)/.test(a)}function b(a){var b=a.replace(" ","");return/^[a-zA-Z0-9_]+$/.test(b)&&(b+=".com"),b=b.replace(/\/$/,"")}function c(a){var b=g(a);S(b).startsWith("www.")&&(b=b.substr(4));var c=b.length,d=b.substr(c-4),e=b.substr(c-7,5),f=b.substr(c-6,4);return[".com",".net",".org",".gov",".edu"].indexOf(d)>=0?b=b.substring(0,c-4):[".com.",".net.",".org.",".gov",".edu."].indexOf(e)>=0?b=b.substring(0,c-7):[".co.",".ac.",".org.",".gov",".edu."].indexOf(f)>=0&&(b=b.substring(0,c-6)),b=S(b).contains(".")?S(b).replaceAll("."," ").humanize().capitalize().s:3==b.length?b.toUpperCase():S(b).replaceAll("."," ").humanize().capitalize().s}function d(b){var c=b;return/^[a-zA-Z0-9_]+$/.test(c)&&(c+=".com"),c=c.replace(/\/$/,""),a(c)||(c="http://"+c),c}function e(a){var b=a.match(/\[(.*?)\]/g);if("object"==typeof b)for(var c=0;c<b.length;c++){var d=b[c];d=d.substr(1,d.length-2);var e=config[d];void 0==e&&(e="");var f=new RegExp("\\["+d+"\\]","gi");a=a.replace(f,e)}var b=a.match(/\((.*?)\)/g);if("object"==typeof b)for(var c=0;c<b.length;c++){var d=b[c];d=d.substr(1,d.length-2);var e=user[d];void 0==e&&(e="");var f=new RegExp("\\("+d+"\\)","gi");a=a.replace(f,e)}return a}function f(b){return a(b)?b:"http://"+b}function g(a,b){a=f(a);var c=document.createElement("a");c.href=a;var d=c.hostname;return b&&d.indexOf("www.")>=0?d.substr(4):d}function h(a,b){var c=new RegExp(b+"=[-A-Za-z0-9]+");if(!c.exec(a))return!1;var d=c.exec(a)[0].split("=")[1];return d}function i(a){var b=urls.getHostName(a);b=b.replace("www.","");for(var c=!1;!c&&-1!==b.lastIndexOf(".");){var d=b.lastIndexOf(".");b.length-d<=4?b=b.substr(0,d):c=!0}return b}function j(a,b){var c=i(a),d=c.split("").join("\\s?");d=new RegExp(d,"i");var e=d.exec(b);return e?e[0]:b=b.split("|")[0]}function k(a,b){l&&l.abort(),a=f(a),l=$.ajax(a,{dataType:"text",type:"GET",success:function(c){var d=c.match(/<title>(.*?)<\/title>/);if(d){var e=d[1];if(e){var f=urls.getPrettyTitle(a,e);b(f?f:e)}else b(i(a))}else b(i(a))},error:function(a){b(null)}})}var l,m=/[\s\S]{1,}[\.][A-Za-z]{2,3}/i,n=function(a){return m.test(a)},o=function(){var a=/[?&]([^=#]+)=([^&#]*)/g;return function(b,c){var d={};return"string"==typeof b&&b.replace(a,function(a,b,e){d[c?b.toLowerCase():b]=decodeURIComponent(e)}),d}}();return{hasProtocol:a,name2host:b,url2name:c,getFullURL:d,isValidUrl:n,buildURL:e,ensureURL:f,getHostName:g,urlParameter:h,getBaseDomain:i,getPrettyTitle:j,getTitleByUrl:k,parseQueryString:o}}(),paths={base:chrome.extension.getURL("").slice(0,-1),app:"/app",img:chrome.extension.getURL("img"),spots:"/app/spots",partials:"/app"},ONE_SECOND=1e3,ONE_MINUTE=60*ONE_SECOND,ONE_HOUR=60*ONE_MINUTE,ONE_DAY=24*ONE_HOUR,ONE_WEEK=7*ONE_DAY,app=angular.module("spotsOpentab",["ngRoute"],function(){});app.config(["$anchorScrollProvider","$sceProvider","$compileProvider",function(a,b,c){a.disableAutoScrolling(),b.enabled(!1),c.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|chrome-extension):/),c.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|chrome-extension):|data:image\/|chrome:\/\/(favicon|extension-icon)/)}]),app.service("$location",[function(){var a={ftp:21,http:80,https:443};angular.extend(this,{absUrl:function(){return location.href},hash:function(a){return location.hash.substr(1)},host:function(){return location.host},path:function(a){return a?(location.pathname=a,this):location.pathname},port:function(){return location.port?Number(location.port):a[this.protocol()]||null},protocol:function(){return location.protocol.substr(0,location.protocol.length-1)},replace:function(){return this},search:function(a,b){if(a||b)return this;var c={};return location.search.substr(1).split("&").forEach(function(a){a=a.split("="),c[a[0]]=decodeURIComponent(a[1])}),c},url:function(a,b){return this.path()}})}]),app.directive("lazyBackground",function(){return{restrict:"A",link:function(a,b,c){var d=a.$eval(c.lazyBackground);_.each(d,function(c,d){var e,f;b.on("mouseover",function(g){var h=a.$eval(c);h&&h!==f&&(f=h,e=b[0].querySelectorAll(d),jqLite(e).css("background-image","url("+h+")"))})})}}}),app.directive("starRating",function(){return{restrict:"EA",transclude:!1,replace:!0,template:'<div class="rating"><span ng-repeat="i in [1,2,3,4,5]" class="star" ng-class="{ full: $index < rating }"></span></div>',link:function(a,b,c){a.rating=Number(c.starRating).toFixed()}}}),app.directive("spotsLoader",function(){return{restrict:"E",transclude:!1,replace:!0,template:'<object type="application/x-shockwave-flash" data="/img/loaders/loader.swf">  <param name="menu" value="false">  <param name="wmode" value="transparent"></object>'}}),app.directive("ngClickOutside",["$document",function(a){var b;return{restrict:"A",link:function(c,d){c.clickedOutside=function(){b=null},d.bind("click",function(a){b||(b=d);var c=b.find(a.target).length>0;c&&a.stopPropagation()}),a.bind("click",function(){b=null,_.digest(c)})}}}]),app.directive("ngLink",function(){var a,b,c=20;return{restrict:"A",link:function(d,e,f){e.bind("mousedown",function(c){a=c.pageX,b=c.pageY,2==c.which&&c.preventDefault()}),e.bind("mouseup",function(d){Math.abs(a-d.pageX)<c&&Math.abs(b-d.pageY)<c&&(d.currentTarget!=d.target&&d.target.hasAttribute("ng-click")||(1==d.which?(d.preventDefault(),config.favoritesOpenInNewTab?tabs.openLinkInNewTab(f.ngLink):window.location.href=urls.getFullURL(f.ngLink)):2==d.which&&(d.preventDefault(),tabs.openLinkInNewTab(f.ngLink,!1))))})}}}),app.directive("colorPicker",["$timeout",function(a){var b={"default":{defaultColor:"#6D0004",colors:{"#303030":["#021416","#1A282A","#303E40","#465557","#5E6E70"],"#777777":["#352F2B","#4C4540","#645D58","#7E7671","#978F8A"],"#3F00DD":["#00006F","#000084","#1E0098","#3B0DAD","#5424C3"],"#9025FF":["#58009D","#6800B3","#9400D5","#A528ED","#C046FF"],"#FE0B6B":["#BB0071","#DA008B","#F900A5","#FF3AC1","#FF5FDC"],"#FE1C03":["#7C0003","#6D0004","#9C0000","#DE0000","#FF1700"],"#FD6C05":["#A21200","#C23600","#E25200","#FF6B00","#FF892B"],"#FEAB07":["#713400","#8F4C00","#AD6500","#CB7E00","#EB9900"],"#5DA200":["#002800","#003C00","#005500","#1F6E00","#418700"],"#30A700":["#004C00","#006400","#007F00","#169900","#43B500"],"#00A8A9":["#004C51","#006569","#007F82","#009A9C","#00B6B7"],"#009BF0":["#002568","#003981","#00509B","#0068B7","#0082D4"],"#338AFF":["#0023A1","#0037BE","#004DDA","#0064F8","#3B7CFF"]}},light:{defaultColor:"#FF6759",colors:{"#7D8B8C":["#7D8B8C","#96A2A2","#AEB6B8","#BFC4C7","#CED4D4"],"#ADA5A2":["#ADA5A2","#BBB6B3","#CBC7C4","#D6D2CF","#E1DDDC"],"#7750CF":["#7750CF","#906FD8","#A891E1","#BBA6E7","#CBBDEE"],"#CD6BFE":["#CD6BFE","#D686FF","#DFA2FF","#E5B5FF","#ECC6FF"],"#FF7FE3":["#FF7FE3","#FE97E8","#FFAFEE","#FFBFF1","#FFD0F4"],"#FF4634":["#FF4634","#FF6759","#FF8B7E","#FFA29A","#FFB8B2"],"#FEA154":["#FEA154","#FEB276","#FEC496","#FFD0AA","#FFDCC0"],"#D89834":["#D89834","#DFAC59","#E6BE80","#ECCC9B","#F1D9B3"],"#679F32":["#679F32","#83B159","#A0C37F","#B2CF99","#C6DBB2"],"#68C433":["#68C433","#85CE58","#A2DA7F","#B3E199","#C6E9B1"],"#33C5C5":["#33C5C5","#59CFCF","#7FDADB","#98E2E1","#B2EAE9"],"#339ADD":["#339ADD","#59AEE4","#7FC0E8","#98CDED","#B1D9F2"],"#6196FE":["#6196FE","#80AAFF","#9EBDFE","#B1CBFE","#C4D7FF"]}},favorites:{defaultColor:"#819799",colors:{"#0FA593":["#00905B","#3EB984","#0FA593","#33C5C5","#7CCB4D"],"#6296FF":["#39579A","#2570E8","#0082D4","#6296FF","#3A96FF"],"#833BC7":["#6419BC","#833BC7","#CD6BFF","#C046FF","#AC7CDA"],"#333333":["#333333","#666666","#819799","#99918D","#999999"],"#FF1542":["#9B1313","#F10025","#C7346D","#FF1542","#F7667C"],"#F2C406":["#B78236","#EFA30C","#D6A300","#FFCE00","#F2C406"],"#FF6D00":["#D17835","#A04525","#EA5F00","#FF6D00","#FF8533"]}}};return{restrict:"AE",require:"ngModel",template:'<div class="color-picker-component"><div class="family"><div class="family-color" ng-repeat="(family, colors) in colorSet track by $index" ng-style="{background:family}" ng-class="{selected:family==currentFamily}" ng-click="pickFamily(family, true)"></div></div><div class="arrow"></div><div class="colors"><div class="color" ng-repeat="color in colorSet[currentFamily] track by $index" ng-style="{background:color}" ng-class="{selected:color==currentColor}" ng-click="pickColor(color)"></div></div></div>',scope:{ngModel:"=",colorScheme:"@",addColors:"=",ngChange:"&"},link:function(c,d){var e,f=$(".color-picker-component",d),g=$(".arrow",f),h=$(".colors",f);c.pickFamily=function(b,d){c.currentFamily=b,c.colorSet[b]||(c.colorSet[b]=[b]),d&&(c.currentColor=c.colorSet[b][Math.floor(c.colorSet[b].length/2)],c.ngModel=c.currentColor),a(function(){var a=$(".family-color.selected",f),b=$(".family",f).width();if(a.position())var c=a.position().left+a.width()/2;var d=h.width(),e=_.keepWithinRange(c-d/2,0,b-d);g.css("left",c-7),h.css("left",e)})},c.addColorsHandler=function(a){_.size(a)&&(c.colorSet=angular.copy(e.colors),_.extend(c.colorSet,a),c.ngModel&&c.pickColor(c.ngModel))},c.pickColor=function(b,d){if(d){b=String(b).toLowerCase();var e=!1;if(_.each(c.colorSet,function(a,d){_.each(a,function(a){b==String(a).toLowerCase()&&(e=!0,c.pickFamily(d,!1),c.currentColor=a,c.ngModel=c.currentColor,c.ngChange())})}),!e){var f={};f[b]=[],async.eachSeries([.6,.8,1,1.2,1.4],function(a,c){graphicAssets.colorLuminance(b,a,function(a){f[b].push(a),c()})},function(){c.addColorsHandler(f),a(function(){c.pickColor(b,!0)})})}}else c.currentColor=b,c.ngModel=c.currentColor,c.ngChange()},c.$watch("addColors",c.addColorsHandler,!0),c.$watch("ngModel",function(a){a&&c.pickColor(a,!0)}),e=b[c.colorScheme?c.colorScheme:"default"],c.colorSet=angular.copy(e.colors),c.ngModel||c.pickColor(e.defaultColor,!0)}}}]),app.directive("fallbackSrc",function(){return{link:function(a,b,c){b.bind("error",function(){$(this).attr("src",c.fallbackSrc)})}}}),app.directive("errorClass",function(){return{link:function(a,b,c){b.bind("error",function(){angular.elem(this).addClass(c.errorClass)})}}}),app.directive("backgroundUrl",function(){return{link:function(a,b,c){c.$observe("backgroundUrl",function(a){b.css({"background-image":a?"url("+a+")":"none"})})}}}),app.directive("fallbackBg",function(){return{link:function(a,b,c){$(b).bind("error",function(){$(b).css({"background-image":"url("+c.fallbackSrc+")"})})}}}),app.directive("contact",function(){return{restrict:"E",scope:{contact:"=",badges:"=",hideName:"=",themeColor:"="},template:'<div class="contact-component" ng-style="contactStyle" ng-class="{noimage:noImage}" ng-click="ngClick"><span ng-show="name" class="name">{{ name }}</span><span ng-if="badges && badges > 0" class="badge" ng-style="badgeStyle">{{ badges }}</span></div>',link:function(a,b,c){a.updateView=function(){if(a.contactStyle={},a.badgeStyle={background:config.accentColor},a.themeColor&&(a.contactStyle["background-color"]=config.themeColor),a.noImage=!1,a.badges&&(a.badges=parseInt(a.badges,10)),a.badges&&a.badges>0&&(a.contactStyle["box-shadow"]="0 0 0 3px "+config.accentColor+" inset"),a.contact){if(a.name=a.hideName?null:a.contact.display,a.hideName||_.isEmpty(a.contact.display)?a.noImage=!0:a.contact.display&&(a.name=a.contact.display),a.contact.image){var b=$("<img />").attr("src",a.contact.image);b.load(function(){a.contactStyle["background-image"]="url("+a.contact.image+")",a.contactStyle["background-color"]=null,a.noImage=!1,a.name=null,_.digest(a)})}}else a.noImage=!0},a.$watch("contact",a.updateView),a.$watch("badges",a.updateView)}}}),app.directive("autocompletePlaces",function(){return{restrict:"A",scope:!0,link:function(a,b,c){function d(){var b={},d=a.$eval(c.autocompletePlaces);return d&&(d.types&&(b.types=[d.types]),d.bounds&&(b.bounds=d.bounds),d.country&&(b.componentRestrictions={country:d.country})),b}function e(){a.gPlace=new google.maps.places.Autocomplete(b[0],d()),google.maps.event.addListener(a.gPlace,"place_changed",function(){a.$emit("placeSelected",a.gPlace.getPlace(),b.val())})}window.google&&google.maps&&google.maps.places?e():(window.googlePlacesLoaded=_.once(function(){a.$emit("GooglePlacesLoaded"),e()}),$.getScript("https://maps.googleapis.com/maps/api/js?libraries=places&sensor=false&callback=googlePlacesLoaded&language="+languageManager.getSelectedLang()))}}}),app.directive("clearButton",function(){return{restrict:"A",scope:!0,link:function(a,b,c){var d=$("<span class='input-clear-button'>&times;</span>").on("click",function(){a.$eval(c.clearButton),b.val("")});b.wrap("<div>").after(d).on("keyup",function(a){27===a.keyCode&&""!==b.val()&&(d.click(),a.stopPropagation())})}}}),app.directive("autoResize",function(){return{restrict:"A",transclude:!0,link:function(a,b,c){var d=b[0];b.attr("rows",c.rows||1).css("box-sizing","border-box"),a.$watch(c.ngModel,function(){d.style.height="auto",d.style.height=d.scrollHeight+d.offsetHeight-d.clientHeight+"px"})}}}),app.directive("spot",["$filter",function(a){return{restrict:"AE",scope:{item:"=",opentab:"=",colorAutoBalance:"&",size:"="},template:'<div id="{{iconId}}" class="spot-component" ng-style="spotStyle"><span ng-show="!item.userIcon">{{ title }}</span></div>',compile:function(){function b(b){b.title=null,b.spotStyle={width:b.size.toString()+"px",height:b.size.toString()+"px","background-color":b.item.color,"background-size":b.item.iconSize?100*b.item.iconSize+"%":null},b.iconId=b.item.userIcon&&b.item.userIcon.replace(/^.*[\\\/]/,"").replace(".",""),b.item.userIcon?(b.spotStyle["background-image"]="url("+b.item.userIcon+")",b.opentab&&b.item.userIcon.indexOf("app/spots")&&(b.spotStyle["background-image"]="url("+b.item.userIcon+")")):b.item.icon?(b.spotStyle["background-image"]="url("+b.item.icon+")",b.opentab&&b.item.icon.indexOf("app/spots")&&(b.spotStyle["background-image"]="url("+(/https?:\/\//i.test(b.item.icon)?"":paths.base)+b.item.icon+")")):(b.title=a("spotIconLetters")(b.item),b.spotStyle["font-size"]=Math.round(.45*b.size),graphicAssets.contrastFilter(b.item.color,.7,function(a){b.spotStyle.color=a})),_.digest(b)}return function(a,c,d){a.item=a.item?a.item:{},a.$watchCollection("[item.id, item.iconSize, item.userIcon, item.icon, item.color, size]",b.bind(null,a))}}}}]),app.directive("fileUpload",["$timeout","$rootScope",function(a,b){return{restrict:"A",scope:{folder:"=",maxSize:"=",createThumbnail:"=",maxWidth:"=",maxHeight:"=",partial:"=",item:"=",noUser:"&",isOpentab:"="},template:'<span ng-include="partial"></span><input ng-show="false" type="file" name="file" accept="image/*"/>',link:function(c,d){c.i18n=b.i18n,c.percent=0,c.math=window.Math,c.themeColor=config.themeColor,c.input=$(d).find("input[type='file']"),c.s3BaseUrl=config.s3_images_folder,c.images=[],c.thumbnails={},c.thumbnailsFolder=[c.folder,"thumbnails"].join("/"),c.maxUploadTime=500,c.updateImages=function(){S3.list(c.folder,20,function(a){a instanceof Error||(a=_.groupBy(a,function(a){return a.Key.indexOf("thumbnails")>=0?"thumbnails":"images"}),a.thumbnails=_.object(_.map(a.thumbnails,function(a){return c.getFilename(a.Key)}),_.pluck(a.thumbnails,"Key").map(function(a){return c.s3BaseUrl+a})),c.thumbnails=_.extend(a.thumbnails,c.thumbnails),c.images=_.sortBy(a.images,"LastModified").map(function(a){return a.FileName||(a.FileName=c.getFilename(a.Key)),a}),_.digest(c))})},c.updateImages(),c.validateImageDimensions=function(a,b){var d=new FileReader;d.onload=function(a){var d=new Image;d.src=a.target.result;var e=c.maxWidth?d.width<=c.maxWidth:!0,f=c.maxHeight?d.height<=c.maxHeight:!0;b(e&&f,d)},d.readAsDataURL(a)},c.getFilename=function(a){return a?a.split("/").pop():null},c.uploadThumbnail=function(a,b){graphicAssets.resizeImage(a,280,null,function(d){c.thumbnails[c.getFilename(b)]=d,c.latestThumbnail=d,_.digest(c);var e=graphicAssets.toBlob(d);e.name=a.name,S3.uploadImage(e,{filename:e.name,folder:c.thumbnailsFolder},{success:function(){c.latestThumbnail=null}})})},c.finishUploading=function(b){c.increasePercent(100),c.$apply("percent"),a(function(){c.selectImage(b,!0),c.updateImages(),c.$parent.$$phase||c.$parent.$apply("config"),c.resetUploader()},100)},c.increasePercent=function(a){c.percent=a,_.digest(c)},c.upload=function(b,e){$(".favorites-image-upload",d).css({height:15,margin:"10px 0"}),_.whenOnline(function(){var d=(new Date).getTime(),f=a(function(){c.increasePercent(20)},.2*c.maxUploadTime),g=a(function(){c.increasePercent(40)},.4*c.maxUploadTime),h=a(function(){c.increasePercent(60)},.6*c.maxUploadTime),i=a(function(){c.increasePercent(80)},.8*c.maxUploadTime),j=a(function(){c.increasePercent(90)},.9*c.maxUploadTime),k=a(function(){c.increasePercent(95)},.95*c.maxUploadTime);S3.uploadImage(b,{filename:e||b.name,folder:c.folder,maxSize:c.maxSize},{success:function(b){var e=(new Date).getTime();if(d<e+c.maxUploadTime){var f=d+c.maxUploadTime-e;a(function(){c.finishUploading(b)},f)}else c.finishUploading(b)},error:function(b,d){c.percent=-1,a.cancel(f),a.cancel(g),a.cancel(h),a.cancel(i),a.cancel(j),a.cancel(k),c.resetUploader()},progress:function(a,d){null===a&&c.createThumbnail&&c.uploadThumbnail(b,d)}})}())},c.selectImage=function(a,b){(c.$parent.selectImage||$.noop)(a,c.folder,b)},c.removeImage=function(a,b){var d=c.getFileName(a);(c.$parent.removeImage||$.noop)(a),c.item&&c.item.userIcon&&(c.item.userIcon=null),S3.deleteFile(c.folder,d,null),c.createThumbnail&&S3.deleteFile(c.thumbnailsFolder,d,null),b&&b.stopPropagation()},c.selectFile=function(){config.user?c.input.show().click().focus():c.noUser()},c.input.on("keyup",function(a){27===a.keyCode&&(c.input.blur().hide(),a.stopPropagation())}),c.resetUploader=function(){$(".favorites-image-upload",d).css({height:40,margin:"0"}),c.percent=0,c.latestThumbnail=null,c.input.val(""),_.digest(c)},c.getIconId=function(a){return a.replace(/^.*[\\\/]/,"").replace(".","")},c.getFileName=function(a){return a.replace(/^.*[\\\/]/,"")},c.input.on("change",function(){c.increasePercent(5);var a=c.input[0].files[0];c.validateImageDimensions(a,function(b,d){b?(c.selectImage(d.src),c.upload(a)):graphicAssets.resizeImage(d,c.maxWidth,c.maxHeight,function(b){c.selectImage(b),c.upload(b,a.name)})})})}}}]),app.directive("rowsCalculator",function(){return{restrict:"A",link:function(a,b,c){var d=_.throttle(function(){var d=Number(c.rowsCalculator),e=b[0].querySelectorAll(".item")[0],f=window.getComputedStyle(e),g=Number.parseFloat(f.width);"border-box"===f.boxSizing&&(g-=Number.parseFloat(f["padding-right"]),g-=Number.parseFloat(f["padding-left"])),a.itemLimit=Math.floor(b[0].offsetWidth/g)*d,_.digest(a)},50);a.$watch(c.itemsArray,function(b){b&&b.length&&a.$evalAsync(d)}),jqLite(window).on("resize",d)}}});var opentabService=function(){"use strict";function a(){return l.onMessage.addListener(function(a){m=a.data.tab,i[a.data.callID].callback&&i[a.data.callID].callback.apply(void 0,a.result)}),l.onDisconnect.addListener(function(a){SPOTS.destory()}),chrome.runtime.onMessage.addListener(function(a,b,c){switch(a.msgType){case n.event:a.spot&&a.eventType&&g(a.spot,a.eventType,a.data);break;case n.notification:a.spot&&h(a.spot,a.id,a.priority,a.data)}}),$.Deferred().resolve().promise()}function b(a,b,c,d,e){j++,i["call_"+j]={callID:"call_"+j,serviceName:a,functionName:b,sync:!!e,args:_.isArray(c)?c:[c],callback:d},l.postMessage(i["call_"+j])}function c(a,b,c,e){k[n.event].push({spot:a,eventType:b,eventHandler:c}),e&&e.$on("$destroy",function(){d(a,b,c)})}function d(a,b,c){_.each(k,function(d,e){a==d.spot&&b==d.eventType&&c==d.eventHandler&&k[n.event].splice(e,1)})}function e(a,b,c){k[n.notification].push({spot:a,eventHandler:b}),c&&c.$on("$destroy",function(){f(a,b)})}function f(a,b){_.each(k,function(c,d){a==c.spot&&b==c.eventHandler&&k[n.notification].splice(d,1)})}function g(a,b,c){_.each(k[n.event],function(e){if(a==e.spot&&b==e.eventType)try{e.eventHandler(c)}catch(f){d(e.spot,e.eventType,e.eventHandler)}})}function h(a,b,c,d){_.each(k[n.notification],function(e){if(a==e.spot)try{e.eventHandler(a,b,c,d)}catch(g){f(e.spot,e.eventHandler)}})}var i={},j=0,k={},l=chrome.runtime.connect({name:"spots"}),m=null,n={event:"event",notification:"notification"};return _.each(n,function(a){k[a]=[]}),a(),{post:b,addEventListener:c,addNotificationListener:e,removeNotificationListener:f,dispatchEvent:g,dispatchNotification:h,getCurrentTab:function(){return m}}}();$.isXMLDoc(document)||opentab.isTabBlacklisted(window.location.hostname,null,function(a){a||$(document).ready(bootstrapSpots)}),app.filter("fromNow",[function(){return function(a){return moment(parseInt(a,10)).fromNow()}}]),app.filter("dayOfWeek",[function(){return function(a){return moment(parseInt(a,10)).format("dddd")}}]),app.filter("formatDate",[function(){return function(a){return moment(a).format(config.dateFormat||"l").replace(/\//g,".")}}]),app.filter("Math",[function(){return function(a,b){return Math[b](a)}}]),app.filter("cleanURL",[function(){return _.memoize(function(a){return urls.getHostName(a,!0)})}]),app.filter("spotIconLetters",["$cacheFactory",function(a){var b=a("spotIconLetters");return function(a){if(_.isObject(a)&&(a=a.title||a.url&&urls.getHostName(a.url,!0)),_.isString(a)){var c=a+"_"+config.favoritesLetterCount;if(!b.get(c)){var d=a.substr(0,config.favoritesLetterCount);b.put(c,d)}return b.get(c)}}}]),app.filter("normalizePhoneNumber",function(){function a(a){return b[a]}var b={};return function(c){return b[c]?a(c):(contacts.normalizePhoneNumber(c,function(a){b[c]=a}),"-")}}),app.filter("hexToRgba",function(){function a(a){return b[a]}var b={};return function(c,d){return b[c+d]?a(c+d):(graphicAssets.hexToRgb(c,function(a){b[c+d]="rgba("+a.r+","+a.g+","+a.b+","+d+")"}),"-")}}),app.filter("tempetureUnit",function(){return function(a){if("fahrenheit"==config.temperatureUnit){var b=9*parseInt(a,10)/5+32;return Math.round(b)}return a}});var apps_grabber=function(){return{addAppToHiddenAps:function(a,b,c){opentabService.post("apps_grabber","addAppToHiddenAps",[a,b],c,!1)},filterApps:function(a,b,c){opentabService.post("apps_grabber","filterApps",[a,b],c,!1)},getAppDetails:function(a,b){opentabService.post("apps_grabber","getAppDetails",[a],b,!1)},getHiddenApps:function(a,b){opentabService.post("apps_grabber","getHiddenApps",[a],b,!1)},findAppsInLinks:function(a,b){opentabService.post("apps_grabber","findAppsInLinks",[a],b,!1)},isOnBlackList:function(a,b){opentabService.post("apps_grabber","isOnBlackList",[a],b,!1)},addToBlackList:function(a,b,c){opentabService.post("apps_grabber","addToBlackList",[a,b],c,!1)}}}(),search=function(){"use strict";return{search:function(a,b){opentabService.post("search","search",[a],b,!1)},buildSearchRegex:function(a){opentabService.post("search","buildSearchRegex",[a],null,!0)}}}(),sms=function(){"use strict";return{getObject:function(a,b){opentabService.post("sms","getObject",[a],b,!1)},getAllObjects:function(a){opentabService.post("sms","getAllObjects",[],a,!1)},getAllObjectsArray:function(a){opentabService.post("sms","getAllObjectsArray",[],a,!1)},getPreviousThreads:function(a,b,c){opentabService.post("sms","getPreviousThreads",[a,b],c,!1)},getThread:function(a,b){opentabService.post("sms","getThread",[a],b,!1)},getThreadForNumber:function(a,b){opentabService.post("sms","getThreadForNumber",[a],b,!1)}}}(),contacts=function(){"use strict";return{normalizePhoneNumber:function(a,b){opentabService.post("contacts","normalizePhoneNumber",[a],b,!0)},getContactDefaultPhone:function(a,b){opentabService.post("contacts","getContactDefaultPhone",[a],b,!0)},getContactByPhoneNumber:function(a,b){opentabService.post("contacts","getContactByPhoneNumber",[a],b,!0)},getObject:function(a,b){opentabService.post("contacts","getObject",[a],b,!0)}}}(),favorites=function(){"use strict";return{launchApp:function(a,b){opentabService.post("favorites","launchApp",[a],b,!0)},getRecentlyClosed:function(a){opentabService.post("favorites","getRecentlyClosed",[],a,!1)},getCategories:function(a){opentabService.post("favorites","getCategories",[],a,!1)},addItem:function(a,b,c){opentabService.post("favorites","addItem",[a,b],c,!1)},removeItem:function(a,b){opentabService.post("favorites","removeItem",[a],b,!1)},getItem:function(a,b){opentabService.post("favorites","getItem",[a],b,!1)},getDetailsForUrl:function(a,b){opentabService.post("favorites","getDetailsForUrl",[a],b,!1)},getRecommended:function(a){opentabService.post("favorites","getRecommended",[],a,!1)}}}(),topsites=function(){"use strict";var a=[];return{getTopSites:function(b,c){opentabService.post("topsites","getTopSites",[b],function(b){a=b,c(a)},!1)},search:function(a,b,c){opentabService.post("topsites","search",[a,b],c,!1)}}}(),weather=function(){"use strict";return{getRefreshInterval:function(a){opentabService.post("weather","getRefreshInterval",[],a,!1)},getWeatherByLatLon:function(a,b,c){opentabService.post("weather","getWeatherByLatLon",[a,b],c,!0)},getWeather:function(a){opentabService.post("weather","getWeather",[],a,!1)}}}();app.controller("OpentabMainCtrl",["$scope","$rootScope","$timeout","$window","$q",function(a,b,c,d,e){function f(b,c){b=$.isNumeric(b)?b:a.animationTime,a.spotsFader.show(),a.spotsFader.animate({opacity:1},b,c)}function g(b,c){b=$.isNumeric(b)?b:a.animationTime,a.spotsFader.animate({opacity:0},b,function(){a.spotsFader.hide(),_.verifyCallback(c)()})}var h=e.defer();b.paths=paths,b.spotsDOM=$(SPOTS.DOM),languageManager.getLang(function(a){moment.lang(a)}),a.parts={},a.animationTime=300,a.spotsReady=h.promise,a.initMainCtrl=function(){configAPI.getConfig(function(c){window.config=c,a.config=c,a.$$phase||a.$apply(),languageManager.getLangObj(function(a){b.i18n=a}),b.$on("SETTINGS_LANGUAGE_CHANGED",function(a,c){moment.lang(c.langName),b.i18n=c.obg,_.digest(b)}),opentabService.addEventListener("CONFIG","CONFIG_SET",function(c){window.config=c,a.config=c,b.$$phase||b.$apply()}),spotsManager.getSpots(function(b){a.spots=b,a.spotsById={},_.each(a.spots,function(b){a.spotsById[b.id]=b}),h.resolve(a.spots),a.initMainEvents()})})},a.initMainEvents=function(){$(window).load(function(){}),a.spotsDOM.on("keydown",".part",_.debounce(function(b){b.originalEvent.keyCode==config.opentab_toggle_key_code&&(utilsAPI.sendGA("Opentab","Handle","hotkey-close",null),"topLeft"==b.currentTarget.id?a.closeAll():a.closePart(b.currentTarget.id))},a.animationTime,!0)),$(d).on("mousemove",function(b){a.$apply(function(){a.factor=Number((b.clientX/d.innerWidth).toFixed(2))})}),opentabService.addEventListener(a.spots.favorites.id,"SHOW_ADD_FORM",_.debounce(function(){b.isFavoritesSpotOpen()?b.closePart("topRight"):b.replacePart(paths.spots+"/favorites/opentab/partials/FavoritesOpentabAdd.html","topRight",!0,function(a){
$(".add-favorite input:first",a).focus()})},a.animationTime,!0)),opentabService.addEventListener(a.spots.favorites.id,"SHOW_REMOVE_FORM",_.debounce(function(){b.isFavoritesSpotOpen()?b.closePart("topRight"):b.replacePart(paths.spots+"/favorites/opentab/partials/FavoritesOpentabRemove.html","topRight",!0)},a.animationTime,!0)),a.$on("searchOpen",function(){b.replacePart(paths.spots+"/search/opentab/partials/search_opentab.html","topLeft",!0,function(){$(".search-box",a.spotsDOM).focus()}),a.openNotifications()}),a.spotsHandle=a.spotsDOM.find("#spotsHandle").css("top",100*config.opentabSearchHandlePosition+"%"),a.spotsFader=$("#spotsFader",a.spotsDOM),a.spotsDOM.show(),a.$broadcast("mainCtrlReady")},b.isFavoritesSpotOpen=function(){return!!a.spotsDOM.find("#topRight .favorites-spot").length},b.replacePart=function(b,c,d,e){a.closePart(c,function(){a.openPart(b,c,d,e)})},b.closePart=function(b,c){if(c=_.isFunction(c)?c:$.noop,a.parts[b]){var d=$("#"+b,a.spotsDOM),e={right:-d.width()};("topLeft"==b||"bottomLeft"==b)&&(e={left:-d.width()}),d.stop().animate(e,a.animationTime,function(){delete a.parts[b],a.$$phase||a.$apply("parts"),0===_.size(a.parts)?(g(a.animationTime,c),a.$broadcast("closedAllParts"),SPOTS.unlock()):c()})}else c()},a.openPart=function(b,c,d,e){SPOTS.lock(),a.parts[c]=b,i[c]=e,a.$$phase||a.$apply("parts"),(d||null==d)&&f()};var i={};a.slideIn=function(b){a.$$phase||a.$apply("parts");var c="8%",d=i[b]||$.noop,e=$("#"+b,a.spotsDOM),f=350;delete i[b],"topLeft"==b||"bottomLeft"==b?(e.css({left:-f}),a.$broadcast("openedLeftPart",c,e,function(){e.show().stop().animate({left:0},a.animationTime,function(){d(e)})})):(e.css({right:-f}),e.show().stop().animate({right:0},a.animationTime,function(){d(e)}))},a.closeAll=_.debounce(function(c){_.each(a.parts,function(c,d){c&&("topLeft"==d&&utilsAPI.sendGA("Opentab","Handle","close",null),a.closePart(d),b.searchOpen=!1)}),b.closeApps()},a.animationTime,!0),a.backgroundImage=_.memoize(function(a){return a?"url("+a+")":"none"}),a.openNotifications=function(){b.replacePart(paths.app+"/opentab/partials/opentab_notifications.html","topRight",!0)},a.closeNotifications=function(){a.closePart("topRight")},a.openChat=function(c,d,e){b.chatItem={phone:c,display:d?d.display:c,givenName:d?d.givenName:"Unknown",image:d?d.image:"",requestFrom:e},a.closeNotifications(),a.closePart("topLeft"),b.replacePart(paths.spots+"/phone/opentab/partials/phone_chat.html","bottomRight")},b.sendGA=function(a,b,c){utilsAPI.sendGA(a,b,c)}}]),app.controller("OpentabFtueStepCtrl",["$scope","$timeout","$rootScope",function(a,b,c){b(function(){a._openSearch=c.openSearch,a._isFavoritesSpotOpen=c.isFavoritesSpotOpen,c.openSearch=function(){var b=this,d=arguments;configAPI.get("ftueOpentab",function(e){0===e.step?a.next(1):(a.end(null,!0),c.openSearch.apply(b,d))})}},ONE_SECOND),a.skip=function(b){a.end(b),c.closePart("topLeft")},a.next=function(b){b?($(".half-circle",SPOTS.DOM).remove(),a.step=b,a.$$phase||a.$apply("step"),a.initStep(a.step),configAPI.set("ftueOpentab",{step:b}),utilsAPI.sendGA("Opentab-ftue","step"+b,"view",null)):a.end()},a.end=function(b,d){$(".ftue",a.spotsDOM).fadeOut(300,function(){configAPI.set("ftueOpentab",{step:null})}),d||(b?utilsAPI.sendGA("Opentab-ftue","step"+b,"skip",null):utilsAPI.sendGA("Opentab-ftue","finish","",null)),c.openSearch=a._openSearch,c.isFavoritesSpotOpen=a._isFavoritesSpotOpen,c.hintHandleLocked=!1},a.initStep=function(b){switch(b){case 1:a.spotsHandle.append("<div class='half-circle' />"),c.openSearch=a.next.bind(a,2),c.hintHandleLocked=!0,a.spotsHandle.css("left",0),c.closePart("topLeft");break;case 2:a.spotsHandle.stop().animate({left:a.handleLeft},a.animationTime,function(){c.hintHandleLocked=!1,c.replacePart(paths.spots+"/search/opentab/partials/search_opentab.html","topLeft",!1,function(){$(".favorites-search-ftue",SPOTS.DOM).css("opacity",1)})});break;case 3:c.isFavoritesSpotOpen=function(){return a.end(),!1},c.closePart("topLeft")}}}]),app.controller("OpentabNotifications",["$scope","$rootScope","$timeout",function(a,b,c){a.selectedWidgetIndex=0,notificationManager.getAll(null,function(b){a.notifications=b}),notificationManager.getOpentabNotificationWidgets(function(b){a.notificationWidgets=b}),notificationManager.getOpentabNotificationPartials(function(b){a.notificationsPartials=b}),a.removeNotification=function(b){a.notifications=_.filter(a.notifications,function(a){return a.id!=b.id}),a.$$phase||a.$apply("notifications"),notificationManager.clear(b.id,null)},function(){var b=null;a.selectedWidgetIndex=0,b=c(function(){a.selectedWidgetIndex+=1,a.selectedWidgetIndex>=a.notificationWidgets.length&&(a.selectedWidgetIndex=0),a.$$phase||a.$apply("selectedWidgetIndex")},config.widgesOpentabAutoRotate),a.selectWidget=function(b){b>=a.notificationWidgets.length&&(b=0),a.selectedWidgetIndex=b,a.$$phase||a.$apply("selectedWidgetIndex")}}(),opentabService.addEventListener("NOTIFICATIONS","NOTIFICATION_CLEARED",function(b){a.notifications=_.filter(a.notifications,function(a){return a.id!=b.id}),a.selected>=a.notifications.length&&(a.selected=a.notifications.length-1),a.$$phase||a.$apply("notifications","selected")},a),opentabService.addEventListener("NOTIFICATIONS","ALL_NOTIFICATIONS_CLEARED",function(){a.notifications=[],a.$$phase||a.$apply("notifications")},a),opentabService.addEventListener("NOTIFICATIONS","NOTIFICATION_ADDED",function(b){b.newtab&&(a.notifications.unshift(b),a.selected=0,a.$$phase||a.$apply("notifications","selected"))},a)}]),app.controller("OpentabAppsHandleCtrl",["$scope","$rootScope","$window","$timeout",function(a,b,c,d){var e,f,g=300,h=!1;b.apps=[],a.apps=[],a.openAppsLocked=!1,a.openMode=!1,a.installationList={},a.toggleDesc={app:null,show:!0},a.hiddenApps=[],a.init=function(){googlePlayUtils.hasDevices(function(b){b&&(a.getConfigValues(),a.getApps(),a.trackUrlAddress())})},a.getApps=function(){apps_grabber.isOnBlackList(window.location.href,function(b){b||apps_grabber.getHiddenApps(window.location.href,function(b){var c=/(?:market\.android\.com\/details|play\.google\.com\/store\/apps\/details|\/store\/apps\/details)\?id\=(.+?)(?:\&|$)/,d=[];$("a").each(function(){var a=$(this).attr("href"),e=c.exec(a);if(e&&e[1]){var f=e[1];-1===d.indexOf(f)&&-1===b.indexOf(f)&&(utilsAPI.sendGA("Android-Insights-Apps","Detected",f,null),d.push(f))}}),b.length&&apps_grabber.getAppDetails(b,function(b){a.hiddenApps=b,a.$$phase||a.$apply("hiddenApps")}),d.length&&apps_grabber.getAppDetails(d,function(b){a.apps=b,a.apps&&utilsAPI.sendGA("Android-Insights-Widget","Show","",null),a.$$phase||a.$apply("apps")})})})},a.getConfigValues=function(){configAPI.get("opentabNumAppsDisplayed",function(b){a.opentabNumAppsDisplayed=b}),configAPI.get("appsDisplayed",function(b){a.appsDisplayed=b}),configAPI.get("opentabAppsHandlePosition",function(b){a.spotsDOM.find("#appsHandle").css("top",100*b+"%")}),configAPI.get("opentab_sensitivity_R",function(b){a.opentab_sensitivity_R=b})},a.trackUrlAddress=function(){f=window.location.href,setInterval(function(){window.location.href!=f&&(f=window.location.href,a.getApps())},3e3)},a.iconLeave=function(){a.openMode||(a.showApps=a.openMode?!0:!1)},a.iconEnter=function(){a.openMode||(a.showApps=!0)},configAPI.get("themeColor",function(b){a.themeColor=b}),a.doLogin=function(b,c,d){googlePlayUtils.googleLogin(b,c,d,function(c){a.playStoreUserResponse(c,b)})},configAPI.get("opentabNumAppsDisplayed",function(b){a.opentabNumAppsDisplayed=b}),a.playStoreUserResponse=function(b,c){b&&(a.installationList[c]=1,a.$$phase||a.$apply("installationList"),googlePlayUtils.getGoogleAccountData(function(b,e,f){googlePlayUtils.doInstall(c,function(b){d(function(){b?(a.installationList[c]=2,a.$$phase||a.$apply("installationList")):(a.installationList[c]=-1,a.$$phase||a.$apply("installationList"))},3e3)})}))},a.installApp=function(b,c,d,e){utilsAPI.sendGA("Android-Insights-Apps","Install",b,null),e&&e.stopPropagation(),googlePlayUtils.isSignedIn(function(e){e?googlePlayUtils.hasDevices(function(e){e?a.playStoreUserResponse(!0,b):a.doLogin(b,c,d)}):a.doLogin(b,c,d)})},a.hideApp=function(b,c){utilsAPI.sendGA("Android-Insights-Apps","Remove",b,null);var d=_.findWhere(a.apps,{id:b});d&&(a.apps=_.filter(a.apps,function(a){return a.id!=b}),a.hiddenApps.push(d)),a.$$phase||a.$apply("apps","hiddenApps"),apps_grabber.addAppToHiddenAps(b,window.location.href,function(){}),c&&c.stopPropagation()},a.hideAllApps=function(b){b="true"==b,b?utilsAPI.sendGA("Android-Insights-Widget","Remove-From-Domain",window.location.host,null):utilsAPI.sendGA("Android-Insights-Widget","Remove-From-Page",window.location.href,null),apps_grabber.addToBlackList(window.location.href,b,function(){a.spotsDOM.find("#appsHandle").css("right","-500px")})},a.cancel=function(){a.closeView=!1,a.$$phase||a.$apply("closeView")},a.appClick=function(b){if(utilsAPI.sendGA("Android-Insights-Apps","Click",b,null),a.openMode){var c="https://play.google.com/store/apps/details",d=c+"?id="+b;window.open(d,"_blank")}else a.openApps()},a.openApps=function(b){a.openMode=!0,a.showApps=!0,utilsAPI.sendGA("Android-Insights-Widget","Open","",null),a.spotsDOM.find("#appsHandle").css("right","-1px"),b&&b.stopPropagation()},a.stopPropagation=function(a){a.stopPropagation()},b.closeApps=function(){a.openMode&&(a.showApps=!1,a.openMode=!1,a.closeView=!1,utilsAPI.sendGA("Android-Insights-Widget","Close","",null),a.$$phase||a.$apply("showApps","openMode","closeView"),a.spotsDOM.find("#appsHandle").css("right","-250px"))},$(window).click(b.closeApps),a.openCloseView=function(b){a.closeView?a.closeApps():(a.showApps=!1,a.closeView=!0,a.$$phase||a.$apply("closeView"),b&&b.stopPropagation())},function(){function d(){h=!0}function f(b){_.delay(d,100),a.spotsDOM.find(".handel-app-image").css({"pointer-events":"none"});var c=b.pageY-k-window.scrollY;c>m&&(c=m),0>c&&(c=0),j=c/window.innerHeight,a.spotsDOM.find("#appsHandle").css("top",c)}function i(b){$(b.target).is(SPOTS.wrapper)?(a.spotsDOM.find("#appsHandle").css("right",e),a.spotsDOM.find(".handel-app-image").css({"pointer-events":""})):a.spotsDOM.find("#appsHandle").stop().animate({right:e},g,function(){}),n.css("-webkit-user-select",o),$(c).off(p),a.spotsFader.css({display:"none",opacity:1}),j&&configAPI.set("opentabAppsHandlePosition",j)}var j,k,l,m,n=$(window.document.body),o=n.css("-webkit-user-select"),p={mousemove:f,mouseup:i},q=_.once(function(){l=a.spotsDOM.find("#appsHandle").height(),m=window.innerHeight-l});b.startDragAppsHandle=_.debounce(function(b){q(),$(c).on(p),k=b.clientY-a.spotsDOM.find("#appsHandle").position().top,n.css("-webkit-user-select","none"),a.spotsFader.css({display:"block",opacity:0}),h=!1},ONE_SECOND,!0)}(),a.init()}]),app.controller("DefaultNotificationOpentabCtrl",["$scope",function(a){"use strict"}]),app.controller("CallLogOpentabNotificationCtrl",["$scope",function(a){"use strict";a.contact={},a.notification.data.from?contacts.getContactByPhoneNumber(a.notification.data.number,function(b){a.contact=b,a.$$phase||a.$apply()}):"unknown"==a.notification.data.number.toLowerCase()&&(a.notification.data.number="Private Number")}]),app.controller("SmsOpentabNotificationCtrl",["$scope",function(a){"use strict";contacts.getContactByPhoneNumber(a.notification.data.number,function(b){a.contact=b})}]),app.controller("OpentabSearchCtrl",["$scope","$timeout","$window",function(a,b,c){function d(){var b=a.results[a.searchTerm]||a.defaultResults;a.selectedItem++,a.selectedCategory>=b.length&&(a.selectedCategory=0,a.selectedItem=0),a.selectedItem>=b[a.selectedCategory].results.length&&(a.selectedCategory++,a.selectedItem=0,a.selectedCategory===b.length&&d()),a.results[a.searchTerm]&&b[a.selectedCategory]&&!b[a.selectedCategory].results[a.selectedItem].show&&d()}function e(){var b=a.results[a.searchTerm]||a.defaultResults;a.selectedItem--,a.selectedItem<0&&(a.selectedCategory--,a.selectedCategory<0&&(a.selectedCategory=b.length-1),a.selectedItem=b[a.selectedCategory].results.length-1,a.selectedItem<0&&e()),a.results[a.searchTerm]&&b[a.selectedCategory]&&!b[a.selectedCategory].results[a.selectedItem].show&&e()}var f;a.selected=0,a.results={};var g={DOWN:40,UP:38,ENTER:13,ESC:27};$("input.search-box",a.spotsDOM).on("keydown",function(b){var c=b.originalEvent;switch(c.keyCode){case g.DOWN:d();break;case g.UP:e(),a.searchTerm&&a.selectRange(c.target,a.searchTerm.length,a.searchTerm.length);break;case g.ENTER:b.preventDefault(),a.searchTerm?a.results[a.searchTerm].length?a.enterEventInfo={spotID:a.results[a.searchTerm][a.selectedCategory].spotID,type:a.results[a.searchTerm][a.selectedCategory].type,selectedItem:a.selectedItem}:a.resultClick(a.buildGoogleSearchURL(a.searchTerm)):a.enterEventInfo={spotID:a.defaultResults[0].spotID,type:a.defaultResults[0].type,selectedItem:a.selectedItem};break;case g.ESC:a.searchTerm&&(a.searchTerm=null,b.stopPropagation())}a.$$phase||a.$apply()}),a.resultsLimit=Math.floor((.95*c.innerHeight-50)/50),angular.element(c).bind("resize",_.debounce(function(){var b=Math.floor((.95*c.innerHeight-50)/50);b!=a.resultsLimit&&(a.resultsLimit=b,a.calculateVisibleResults(),a.$apply("resultsLimit"))},100)),a.$watch("searchTerm",function(c){c&&a.searchQueryInPreviousResults(function(){b.cancel(f),a.enterEventInfo=null,!c||a.results[c]&&a.results[c].length?a.spotsResults=_.where(a.results[c],function(a){return a.results.length>0}).length:(a.results[c]=a.tempResults?a.tempResults:null,f=b(function(){search.search(c,a.searchResponseHandler)},200))})}),a.searchQueryInPreviousResults=function(b){if(a.LastSearchCommited&&a.searchTerm){var c=a.searchTerm,d=a.getSearchRegex(c);a.tempResults=angular.copy(a.results[a.LastSearchCommited]),_.each(a.tempResults,function(b){b.results=_.filter(b.results,function(b){return a.checkFields(b,["givenName","familyName","display","title","url","name","shortName","label"],d)})}),a.tempResults=_.reject(a.tempResults,function(a){return 0===a.results.length}),b()}else b()},a.checkFields=function(a,b,c){var d=!1;return _.each(b,function(b){!_.isUndefined(a[b])&&c.test(a[b])&&(d=!0)}),d},a.getSearchRegex=function(a){return a?(a.length<3&&(a="^"+a),a=a.replace(" ","\\s"),new RegExp(a,"i")):null},a.searchResponseHandler=function(b){b.results.length&&(a.results[b.query]||(a.results[b.query]=[]),a.results[b.query]=_.reject(a.results[b.query],function(a){return a.spotID==b.spotID&&a.type==b.type}),a.results[b.query].push(b),a.results[b.query]=_.sortBy(a.results[b.query],function(a){return-1*a.priority}),a.calculateVisibleResults(),a.results[b.query]=_.sortBy(a.results[b.query],function(a){return-1*a.priority})),a.selectedCategory=0,a.selectedItem=0,a.LastSearchCommited=b.query,a.$$phase||a.$apply()},a.calculateVisibleResults=function(){var b=[];_.each(a.results[a.searchTerm],function(c,d){a.results[a.searchTerm][d].results=_.sortBy(c.results,function(a){return-1*a.score}),b=_.union(b,c.results)}),_.each(b,function(b,c){b.show=c<a.resultsLimit})},a.setSelected=function(b,c){a.selectedCategory=b,a.selectedItem=c},a.resultClick=function(a){var b=_.isString(a)?a:a.url||a.link;b&&($("html").addClass("spots-web-hider"),window.location.href=urls.getFullURL(b))},a.selectRange=function(a,b,c){if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,c);else if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveEnd("character",c),d.moveStart("character",b),d.select()}},a.setDefaultSearchItems=function(){a.defaultResults=[{spotID:"ef974b5a-432f-472b-89c6-c92a67d60182",type:"top-sites",results:a.defaultResultsItems}],a.selectedCategory=0,a.selectedItem=0,a.$$phase||a.$apply("defaultResults","selectedCategory","selectedItem")},topsites.getTopSites(config.opentabDefaultResultsLimit,function(b){b.length<config.opentabDefaultResultsLimit?favorites.getRecommended(function(c){c=_.uniq(b.concat(c),!1,function(a){return a.id}),c.length>config.opentabDefaultResultsLimit&&(c=c.slice(0,config.opentabDefaultResultsLimit)),a.defaultResultsItems=c,a.setDefaultSearchItems()}):(a.defaultResultsItems=b,a.setDefaultSearchItems())}),a.buildGoogleSearchURL=function(a){return config.searchProviderUrl+a},a.googleSearch=function(){a.searchTerm&&(utilsAPI.sendGA("Opentab-Search","Web-Search","Search-Btn-Click",null),utilsAPI.sendGA("Search-Term",a.searchTerm,"",null),bi.report({event_name:"srch",srch_provider:urls.getBaseDomain(config.searchProviderUrl).split(".").pop()}),window.location.href=a.buildGoogleSearchURL(a.searchTerm))}}]),app.controller("OpentabSearchResultCtrl",["$scope",function(a){"use strict";var b={calculator:"Calculator-Search",navigation:"Navigation-Search","web-search":"Web-Search"},c=null;spotsManager.spotID("search",function(a){c=a}),a.resultClick=function(){utilsAPI.sendGA("Opentab-Search",b[a.spot.type]||"","AutoComplete-Click",null),("web"==a.result.type||"web-default"===a.result.type)&&utilsAPI.sendGA("Search-Term",a.searchTerm,"",null),"calculator"===a.spot.type&&(a.result.value=a.buildGoogleSearchURL(a.searchTerm)),a.$parent.resultClick(a.result.value)},a.$watch("enterEventInfo",function(){a.enterEventInfo&&a.enterEventInfo.spotID==c&&a.enterEventInfo.selectedItem==a.$index&&a.enterEventInfo.type==a.spot.type&&a.resultClick()})}]),app.controller("OpentabSearchHandleCtrl",["$scope","$rootScope","$window","$timeout",function(a,b,c,d){function e(){f(),$(document).keyup(function(){var a=!1;return function(c){c.keyCode==config.opentab_toggle_key_code&&(a?b.openSearch(!0):(a=!0,d(function(){a=!1},config.opentab_toggle_key_timeout)))}}());var c=Number(config.opentab_sensitivity_L);a.$watch("factor",function(d){c>d?a.handleLeft=d/c*-a.handleWidth:a.handleLeft=-a.handleWidth,a.hintHandle&&!b.hintHandleLocked&&a.spotsHandle.css("left",a.handleLeft)}),a.$on("closedAllParts",function(b){a.spotsHandle.css("top",100*config.opentabSearchHandlePosition+"%"),a.spotsHandle.show().stop(),a.spotsHandle.animate({left:a.handleLeft},function(){a.hintHandle=!0})}),a.$on("openedLeftPart",function(b,c,d,e){if(a.hintHandle=!1,a.handleLeft>-a.handleWidth){var f=a.spotsHandle.position().top/2;d.css("top",c),a.spotsHandle.stop().animate({top:c},f,function(){a.spotsHandle.stop().animate({left:-a.handleWidth},200,function(){a.spotsHandle.hide(),e()})})}else e()}),b.openSearch=_.debounce(function(c){"topLeft"in a.parts||!c&&a.openSearchLocked||(utilsAPI.sendGA("Opentab","Handle",c?"hotkey-open":"open",null),b.searchOpen=!0,a.$emit("searchOpen"))},a.animationTime,!0)}function f(){function d(){a.openSearchLocked=!0}function e(b){_.delay(d,100);var c=b.pageY-h-window.scrollY;c>j&&(c=j),0>c&&(c=0),g=c/window.innerHeight,a.spotsHandle.css("top",c)}function f(d){$(d.target).is(SPOTS.wrapper)?(a.spotsHandle.css("left",a.handleLeft),b.hintHandleLocked=!1):a.spotsHandle.stop().animate({left:a.handleLeft},a.animationTime,function(){b.hintHandleLocked=!1}),k.css("-webkit-user-select",l),$(c).off(m),a.spotsFader.css({display:"none",opacity:1}),g&&configAPI.set("opentabSearchHandlePosition",g)}var g,h,i,j,k=$(window.document.body),l=k.css("-webkit-user-select"),m={mousemove:e,mouseup:f},n=_.once(function(){i=a.spotsHandle.height(),j=window.innerHeight-i});b.startDragSearchHandle=_.debounce(function(d){n(),$(c).on(m),h=d.clientY-a.spotsHandle.position().top,k.css("-webkit-user-select","none"),a.spotsFader.css({display:"block",opacity:0}),b.hintHandleLocked=!0,a.openSearchLocked=!1},ONE_SECOND,!0)}a.hintHandle=!0,b.handleWidth=20,b.handleLeft=-a.handleWidth,a.$on("mainCtrlReady",e)}]),app.controller("FavoritesOpentabAddCtrl",["$scope","$timeout",function(a,b){"use strict";b(function(){$("#topRight",a.spotsDOM).css("top",0)}),a.disableForm=!1,a.item={url:window.location.href,title:urls.getPrettyTitle(window.location.href,window.document.title),placeholder:urls.getBaseDomain(window.location.href)},favorites.getDetailsForUrl(window.location.href,function(b){b.item.icon&&(b.item.icon=paths.base+b.item.icon),a.item=_.extend({},b.item,a.item),a.colorPalette=[{f:b.item.color,c:b.palette}],a.$$phase||a.$apply("item","colorPalette")}),favorites.getCategories(function(b){a.itemCategory=b[0].id,a.categories=b,a.$$phase||a.$apply("itemCategory","categories")}),a.selectImage=function(b){var c=graphicAssets.isDataURL(b);c||(a.item.userIcon=b,_.digest(a))},a.removeImage=function(a){var b=a.replace(/^.*[\\\/]/,"").replace(".","");$("#"+b).css("background-image","none")},a.addFavorite=function(){String(a.item.title).trim()||(a.item.title=a.item.placeholder,delete a.item.placeholder),favorites.addItem(a.item,a.itemCategory),a.closePart("topRight",function(){})}}]),app.controller("FavoritesOpentabRemoveCtrl",["$scope",function(a){"use strict";favorites.getItem({url:window.location.href},function(b){a.item=b,a.$$phase||a.$apply("item")}),a.removeFavorite=function(){favorites.removeItem(a.item),a.closePart("topRight")}}]),app.controller("OpentabFavoritesSearchResultCtrl",["$scope",function(a){"use strict";var b={bookmarks:"Bookmarks-Search",favorites:"Favorites-Search","top-sites":"TopSites-Search","chrome-apps":"ChromeApps-Search"},c=null;spotsManager.spotID("favorites",function(a){c=a}),a.resultClick=function(){utilsAPI.sendGA("Opentab-Search",b[a.spot.type]||"","AutoComplete-Click",null);var c={"TopSites-Search":"mostvisited","Favorites-Search":"fav","Web-Search":"web","Contacts-Search":"contact","Bookmarks-Search":"bkmark"};bi.report({event_name:"srch",srch_provider:urls.getBaseDomain(config.searchProviderUrl).split(".").pop(),srch_type:c[b[a.spot.type]]}),"chrome-apps"===a.spot.type?webappsUtils.launch(a.result):a.$parent.resultClick(a.result.url)},a.$watch("enterEventInfo",function(){a.enterEventInfo&&a.enterEventInfo.spotID==c&&a.enterEventInfo.selectedItem==a.$index&&a.enterEventInfo.type==a.spot.type&&a.resultClick()})}]),app.controller("OpentabClockCtrl",["$scope","$timeout",function(a,b){"use strict";a.updateClock=function(){a.currentTime=(new Date).getTime(),b(a.updateClock,ONE_MINUTE)},a.updateClock()}]),app.controller("opentabWeatherCtrl",["$scope",function(a){"use strict";function b(){return weather.getWeather(function(b){var c=b.weather;c.length&&(a.weatherConditionText=c[0].description,a.weatherConditionId=c[0].id),a.temperature=Math.round(b.main.temp),a.weatherLoaded=!0,_.digest(a)})}a.weatherLoaded=!1,weather.getRefreshInterval(function(a){window.setInterval(b,a)}),opentabService.addEventListener("SETTINGS","LANGUAGE_CHANGED",b),a.$watch("config.weatherLocation",b),b()}]),app.controller("OpentabContactsSearchResultCtrl",["$rootScope","$scope","$timeout",function(a,b,c){b.currentView="default",b.$watch("enterEventInfo",function(){b.enterEventInfo&&b.enterEventInfo.spotID==b.spots.contacts.id&&b.enterEventInfo.selectedItem==b.$index&&(utilsAPI.sendGA("Opentab-Search","Contacts-Search","AutoComplete-Click",null),b.openChat(b.defaultPhone,b.result,"search-enter"))}),b.callNumber=function(a){b.selectedItem==b.$index&&(b.selectedItemCallItem=b.selectedItem,utilsAPI.sendGA("Opentab-Search","Contacts-Search","Call-Contact",null),b.currentView="calling",_.digest(b),pushService.sendNotification(b.spots.call_log.id,1,{number:a,speaker:config.phoneSpeaker},function(){}))},b.cancelCall=function(){utilsAPI.sendGA("Opentab-Search","Contacts-Search","Cancel-Call-Contact",null),pushService.sendNotification(b.spots.call_log.id,2,"",function(){b.currentView="default",_.digest(b)})},opentabService.addEventListener(b.spots.call_log.id,4,function(a){b.selectedItemCallItem==b.$index&&(b.currentView="call_connected",_.digest(b),c(function(){b.currentView="default",_.digest(b)},5e3))},b),b.toggleContact=function(){utilsAPI.sendGA("Opentab-Search","Contacts-Search","AutoComplete-Click",null),b.disableToggle||("all_numbers"==b.currentView?b.currentView="default":b.currentView="all_numbers")},b.getAdditionalNumbersHeight=function(){return 44*_.size(b.result.phones)},b.getDefaultPhone=function(){contacts.getContactDefaultPhone(b.result,function(a){b.defaultPhone=a})},b.getDefaultPhone()}]),app.controller("ChatCtrl",["$rootScope","$scope","$timeout",function(a,b,c){var d=$(".chat .scroll-window",a.spotsDOM);b.scrollToBottom=function(){d.prop("scrollHeight")&&d.scrollTop(d.prop("scrollHeight"))},$("#smsText",a.spotsDOM).on("keydown",function(a){var c=a.originalEvent;switch(c.keyCode){case 13:!c.shiftKey&&b.smsText.trim()&&(b.sendSms(),a.preventDefault());break;case 27:b.smsText.trim()?(b.smsText="",_.digest(b),a.stopPropagation()):b.openSearch()}}),b.currentView="default",sms.getThreadForNumber(b.chatItem.phone,function(a){b.numberSmss=a,_.digest(b),c(b.scrollToBottom)}),b.sendSms=function(){utilsAPI.sendGA("Opentab","Chat","sms sent",null);var a=b.chatItem.phone,d=b.smsText.trim();b.numberSmss.push({id:(new Date).getTime(),number:a,text:d,timestamp:(new Date).getTime().toString(),type:3}),pushService.sendNotification(b.spots.sms.id,1,{number:a,text:d},function(){}),b.smsText="",c(b.scrollToBottom),_.digest(b)},b.closeChat=function(){a.closePart("bottomRight"),"notifications"==a.chatItem.requestFrom&&b.openNotifications(),utilsAPI.sendGA("Opentab","Chat","close",null)},opentabService.addEventListener(b.spots.sms.id,"SMS_EVENT",function(a){_.each(a,function(a){a.number==b.chatItem.phone&&(_.each(b.numberSmss,function(c,d){c.text==a.text&&3==c.type&&b.numberSmss.splice(d,1)}),b.numberSmss.push(a),_.digest(b))})},b),b.callNumber=function(a){utilsAPI.sendGA("Opentab","Chat","call made",null),b.selectedItemCallItem=b.selectedItem,b.currentView="calling",_.digest(b),pushService.sendNotification(b.spots.call_log.id,1,{number:a,speaker:config.phoneSpeaker},function(){})},b.cancelCall=function(){pushService.sendNotification(b.spots.call_log.id,2,"",function(){b.currentView="default",_.digest(b)})},opentabService.addEventListener(b.spots.call_log.id,4,function(a){b.currentView="call_connected",_.digest(b),c(function(){b.currentView="default",_.digest(b)},5e3)},b)}]);